<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}柯基学习小助手{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#32C77F",
                        warning: "#FF9B27", 
                        danger: "#ED4B4B",
                        "text-dark-brown": "#715D46",
                        "text-medium-brown": "#9B8D7D",
                        "text-gray": "#828282",
                        "bg-light-blue": "#D5F8FF",
                        "bg-beige": "#FFFFD6",
                        "bg-light-green": "#E2F2EB",
                        "bg-light-gray": "#F2F0ED",
                        "bg-light-blue-gray": "#F5F7F9",
                    },
                    fontFamily: {
                        sans: ['"Noto Sans SC"', 'sans-serif'],
                    },
                    borderRadius: {
                        'xl': '1rem',
                    },
                },
            },
        };
    </script>
    
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-bg-light-blue-gray font-sans">
    <!-- 全局调试面板 -->
    <div id="global-debug-panel" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="absolute right-4 top-4 bottom-4 w-1/3 bg-white rounded-lg shadow-2xl flex flex-col">
            <!-- 调试面板头部 -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                <div class="flex items-center">
                    <span class="material-icons-outlined text-blue-600 mr-2">bug_report</span>
                    <h3 class="text-lg font-semibold text-gray-800">调试面板</h3>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="clear-debug-log" class="p-1 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded">
                        <span class="material-icons-outlined text-sm">clear_all</span>
                    </button>
                    <button id="close-debug-panel" class="p-1 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded">
                        <span class="material-icons-outlined text-sm">close</span>
                    </button>
                </div>
            </div>
            
            <!-- 调试内容区域 -->
            <div class="flex-1 overflow-hidden flex flex-col">
                <div class="p-3 border-b border-gray-100 bg-blue-50">
                    <div class="text-xs text-blue-700 font-medium">实时日志 (按F12开启/关闭)</div>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <pre id="global-debug-content" class="text-xs font-mono text-gray-700 whitespace-pre-wrap leading-relaxed"></pre>
                </div>
            </div>
        </div>
    </div>

    {% block content %}{% endblock %}
    
    {% block scripts %}
    <script>
        // 让bridge挂到window，确保动态注入的页面也能访问到window.bridge
        window.bridge = null;
        
        // 全局调试面板功能
        window.globalDebugLogs = [];
        
        // 全局调试日志函数
        window.globalDebugLog = function(message) {
            const timestamp = new Date().toISOString();
            const logEntry = `${timestamp} - INFO - ${message}`;
            
            // 添加到全局日志数组
            window.globalDebugLogs.push(logEntry);
            
            // 更新调试面板显示
            const debugContent = document.getElementById('global-debug-content');
            if (debugContent) {
                const displayTime = new Date().toLocaleTimeString();
                debugContent.textContent += `[${displayTime}] ${message}\n`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            
            console.log(message);
            
            // 发送到Python后端记录到文件
            if (window.bridge && window.bridge.logFrontendMessage) {
                try {
                    window.bridge.logFrontendMessage(logEntry);
                } catch (e) {
                    console.warn('无法发送日志到后端:', e);
                }
            }
        };
        
        // 全局调试错误函数
        window.globalDebugError = function(message) {
            const timestamp = new Date().toISOString();
            const logEntry = `${timestamp} - ERROR - ${message}`;
            
            window.globalDebugLogs.push(logEntry);
            
            const debugContent = document.getElementById('global-debug-content');
            if (debugContent) {
                const displayTime = new Date().toLocaleTimeString();
                debugContent.textContent += `[${displayTime}] ERROR: ${message}\n`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            
            console.error(message);
            
            if (window.bridge && window.bridge.logFrontendMessage) {
                try {
                    window.bridge.logFrontendMessage(logEntry);
                } catch (e) {
                    console.warn('无法发送错误日志到后端:', e);
                }
            }
        };
        
        // 调试面板控制函数
        window.toggleDebugPanel = function() {
            const panel = document.getElementById('global-debug-panel');
            if (panel) {
                const isHidden = panel.classList.contains('hidden');
                if (isHidden) {
                    panel.classList.remove('hidden');
                    globalDebugLog('调试面板已打开');
                } else {
                    panel.classList.add('hidden');
                    globalDebugLog('调试面板已关闭');
                }
            }
        };
        
        // 清空调试日志
        window.clearDebugLog = function() {
            window.globalDebugLogs = [];
            const debugContent = document.getElementById('global-debug-content');
            if (debugContent) {
                debugContent.textContent = '';
            }
            globalDebugLog('调试日志已清空');
        };
        
        // 键盘快捷键监听
        document.addEventListener('keydown', function(e) {
            // F12键切换调试面板
            if (e.key === 'F12') {
                e.preventDefault();
                window.toggleDebugPanel();
            }
        });
        
        // 调试面板按钮事件
        document.addEventListener('DOMContentLoaded', function() {
            const closeBtn = document.getElementById('close-debug-panel');
            const clearBtn = document.getElementById('clear-debug-log');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    document.getElementById('global-debug-panel').classList.add('hidden');
                });
            }
            
            if (clearBtn) {
                clearBtn.addEventListener('click', window.clearDebugLog);
            }
        });

        // 初始化WebChannel
        new QWebChannel(qt.webChannelTransport, function (channel) {
            window.bridge = channel.objects.bridge;
            console.log("WebChannel连接成功");
            
            // 触发bridge准备就绪事件
            const bridgeReadyEvent = new CustomEvent('bridgeReady');
            document.dispatchEvent(bridgeReadyEvent);
            
            // 调用子模板的初始化代码
            if (typeof onBridgeReady === 'function') {
                onBridgeReady();
            }
        });
        
        // 调用Python函数
        function callPythonFunction(functionName, ...args) {
            if (bridge && bridge[functionName]) {
                bridge[functionName](...args);
            }
        }
    </script>
    {% endblock %}
    
    <!-- 子模板的bridge初始化代码 -->
    {% block on_bridge_ready %}{% endblock %}
</body>
</html>
