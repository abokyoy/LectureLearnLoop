<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}ÊüØÂü∫Â≠¶‰π†Â∞èÂä©Êâã{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#32C77F",
                        warning: "#FF9B27", 
                        danger: "#ED4B4B",
                        "text-dark-brown": "#715D46",
                        "text-medium-brown": "#9B8D7D",
                        "text-gray": "#828282",
                        "bg-light-blue": "#D5F8FF",
                        "bg-beige": "#FFFFD6",
                        "bg-light-green": "#E2F2EB",
                        "bg-light-gray": "#F2F0ED",
                        "bg-light-blue-gray": "#F5F7F9",
                    },
                    fontFamily: {
                        sans: ['"Noto Sans SC"', 'sans-serif'],
                    },
                    borderRadius: {
                        'xl': '1rem',
                    },
                },
            },
        };
    </script>
    
    {% block extra_head %}{% endblock %}
    
    <style>
        /* AIÂä©ÊâãÊµÆÁ™óÊ†∑Âºè */
        .ai-assistant-float {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .ai-assistant-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #32C77F, #28a745);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(50, 199, 127, 0.3);
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .ai-assistant-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(50, 199, 127, 0.4);
        }
        
        .ai-assistant-avatar.dragging {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(50, 199, 127, 0.5);
        }
        
        .ai-chat-window {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            z-index: 9998;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .ai-chat-window.maximized {
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            width: auto;
            height: auto;
            max-width: none;
            max-height: none;
        }
        
        .ai-chat-window.show {
            display: flex;
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .ai-chat-header {
            background: linear-gradient(135deg, #32C77F, #28a745);
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #f8f9fa;
        }
        
        .ai-chat-input {
            padding: 16px;
            border-top: 1px solid #e9ecef;
            background: white;
        }
        
        .message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .message.ai .message-content {
            background: #e2f2eb;
            color: #2d5a3d;
        }
        
        .user-message .message-content {
            background: #007bff;
            color: white;
            margin-left: auto;
            margin-right: 0;
        }

        /* ÂéÜÂè≤ÂØπËØùÂºπÁ™óÊ†∑Âºè */
        .ai-history-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .ai-history-modal.show {
            display: flex;
        }

        .ai-history-content {
            background: white;
            border-radius: 12px;
            width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .ai-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .ai-history-search {
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .ai-history-list {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
            padding: 10px;
        }

        .history-item {
            padding: 12px 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            background: #f3f4f6;
            border-color: #3b82f6;
        }

        .history-item.selected {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .history-item-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .history-item-time {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .history-item-preview {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.4;
        }

        .ai-history-actions {
            padding: 15px 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
        }
    </style>
</head>
<body class="bg-bg-light-blue-gray font-sans">
    <!-- AIÂä©ÊâãÊµÆÁ™ó -->
    <div class="ai-assistant-float" id="aiAssistantFloat">
        <div class="ai-assistant-avatar" id="aiAssistantAvatar">
            <span class="material-icons-outlined text-white text-2xl">pets</span>
        </div>
    </div>
    
    <!-- AIËÅäÂ§©Á™óÂè£ -->
    <div class="ai-chat-window" id="aiChatWindow">
        <div class="ai-chat-header">
            <div class="flex items-center">
                <span class="material-icons-outlined text-white mr-2">smart_toy</span>
                <span class="text-white font-medium">ÊüØÂü∫AIÂä©Êâã</span>
            </div>
            <div class="flex items-center space-x-2">
                <button id="historyChatBtn" class="text-white hover:text-gray-300 transition-colors" title="ÂéÜÂè≤ËÆ∞ÂΩï">
                    <span class="material-icons-outlined">history</span>
                </button>
                <button id="maximizeChatBtn" class="text-white hover:text-gray-300 transition-colors" title="ÊúÄÂ§ßÂåñ">
                    <span class="material-icons-outlined">fullscreen</span>
                </button>
                <button id="closeChatBtn" class="text-white hover:text-gray-300 transition-colors" title="ÂÖ≥Èó≠">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>
        </div>
        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-message">
                <div class="message-avatar">üêï</div>
                <div class="message-content">
                    Ê±™ÔºÅÊàëÊòØ‰Ω†ÁöÑÂ≠¶‰π†Â∞èÂä©ÊâãÔºåÊúâ‰ªÄ‰πàÈóÆÈ¢òÂèØ‰ª•ÈóÆÊàëÂì¶ÔºÅ
                </div>
            </div>
        </div>
        <div class="ai-chat-input">
            <input type="text" id="aiChatInput" placeholder="ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò..." class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="summaryChatBtn" class="ml-2 px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors" title="ÊÄªÁªìÂØπËØù">
                <span class="material-icons-outlined text-sm">summarize</span>
            </button>
            <button id="sendChatBtn" class="ml-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                ÂèëÈÄÅ
            </button>
        </div>
    </div>

    <!-- ÂéÜÂè≤ÂØπËØùÂºπÁ™ó -->
    <div class="ai-history-modal" id="aiHistoryModal">
        <div class="ai-history-content">
            <div class="ai-history-header">
                <h3 class="text-lg font-semibold">ÂØπËØùÂéÜÂè≤</h3>
                <button id="closeHistoryBtn" class="text-gray-500 hover:text-gray-700">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>
            <div class="ai-history-search">
                <input type="text" id="historySearchInput" placeholder="ÊêúÁ¥¢ÂØπËØù..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="ai-history-list" id="aiHistoryList">
                <!-- ÂéÜÂè≤ÂØπËØùÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
            <div class="ai-history-actions">
                <button id="loadHistoryBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                    Âä†ËΩΩÈÄâ‰∏≠ÂØπËØù
                </button>
                <button id="cancelHistoryBtn" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    ÂèñÊ∂à
                </button>
            </div>
        </div>
    </div>
    <!-- ÂÖ®Â±ÄË∞ÉËØïÈù¢Êùø -->
    <div id="global-debug-panel" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="absolute right-4 top-4 bottom-4 w-1/3 bg-white rounded-lg shadow-2xl flex flex-col">
            <!-- Ë∞ÉËØïÈù¢ÊùøÂ§¥ÈÉ® -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                <div class="flex items-center">
                    <span class="material-icons-outlined text-blue-600 mr-2">bug_report</span>
                    <h3 class="text-lg font-semibold text-gray-800">Ë∞ÉËØïÈù¢Êùø</h3>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="clear-debug-log" class="p-1 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded">
                        <span class="material-icons-outlined text-sm">clear_all</span>
                    </button>
                    <button id="close-debug-panel" class="p-1 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded">
                        <span class="material-icons-outlined text-sm">close</span>
                    </button>
                </div>
            </div>
            
            <!-- Ë∞ÉËØïÂÜÖÂÆπÂå∫Âüü -->
            <div class="flex-1 overflow-hidden flex flex-col">
                <div class="p-3 border-b border-gray-100 bg-blue-50">
                    <div class="text-xs text-blue-700 font-medium">ÂÆûÊó∂Êó•Âøó (ÊåâF12ÂºÄÂêØ/ÂÖ≥Èó≠)</div>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <pre id="global-debug-content" class="text-xs font-mono text-gray-700 whitespace-pre-wrap leading-relaxed"></pre>
                </div>
            </div>
        </div>
    </div>

    {% block content %}{% endblock %}
    
    {% block scripts %}
    <script>
        // ËÆ©bridgeÊåÇÂà∞windowÔºåÁ°Æ‰øùÂä®ÊÄÅÊ≥®ÂÖ•ÁöÑÈ°µÈù¢‰πüËÉΩËÆøÈóÆÂà∞window.bridge
        window.bridge = null;
        
        // ÂÖ®Â±ÄË∞ÉËØïÈù¢ÊùøÂäüËÉΩ
        window.globalDebugLogs = [];
        
        // ÂÖ®Â±ÄË∞ÉËØïÊó•ÂøóÂáΩÊï∞
        window.globalDebugLog = function(message) {
            const timestamp = new Date().toISOString();
            const logEntry = `${timestamp} - INFO - ${message}`;
            
            // Ê∑ªÂä†Âà∞ÂÖ®Â±ÄÊó•ÂøóÊï∞ÁªÑ
            window.globalDebugLogs.push(logEntry);
            
            // Êõ¥Êñ∞Ë∞ÉËØïÈù¢ÊùøÊòæÁ§∫
            const debugContent = document.getElementById('global-debug-content');
            if (debugContent) {
                const displayTime = new Date().toLocaleTimeString();
                debugContent.textContent += `[${displayTime}] ${message}\n`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            
            console.log(message);
            
            // ÂèëÈÄÅÂà∞PythonÂêéÁ´ØËÆ∞ÂΩïÂà∞Êñá‰ª∂
            if (window.bridge && window.bridge.logFrontendMessage) {
                try {
                    window.bridge.logFrontendMessage(logEntry);
                } catch (e) {
                    console.warn('Êó†Ê≥ïÂèëÈÄÅÊó•ÂøóÂà∞ÂêéÁ´Ø:', e);
                }
            }
        };
        
        // ÂÖ®Â±ÄË∞ÉËØïÈîôËØØÂáΩÊï∞
        window.globalDebugError = function(message) {
            const timestamp = new Date().toISOString();
            const logEntry = `${timestamp} - ERROR - ${message}`;
            
            window.globalDebugLogs.push(logEntry);
            
            const debugContent = document.getElementById('global-debug-content');
            if (debugContent) {
                const displayTime = new Date().toLocaleTimeString();
                debugContent.textContent += `[${displayTime}] ERROR: ${message}\n`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            
            console.error(message);
            
            if (window.bridge && window.bridge.logFrontendMessage) {
                try {
                    window.bridge.logFrontendMessage(logEntry);
                } catch (e) {
                    console.warn('Êó†Ê≥ïÂèëÈÄÅÈîôËØØÊó•ÂøóÂà∞ÂêéÁ´Ø:', e);
                }
            }
        };
        
        // Ë∞ÉËØïÈù¢ÊùøÊéßÂà∂ÂáΩÊï∞
        window.toggleDebugPanel = function() {
            const panel = document.getElementById('global-debug-panel');
            if (panel) {
                const isHidden = panel.classList.contains('hidden');
                if (isHidden) {
                    panel.classList.remove('hidden');
                    globalDebugLog('Ë∞ÉËØïÈù¢ÊùøÂ∑≤ÊâìÂºÄ');
                } else {
                    panel.classList.add('hidden');
                    globalDebugLog('Ë∞ÉËØïÈù¢ÊùøÂ∑≤ÂÖ≥Èó≠');
                }
            }
        };
        
        // Ê∏ÖÁ©∫Ë∞ÉËØïÊó•Âøó
        window.clearDebugLog = function() {
            window.globalDebugLogs = [];
            const debugContent = document.getElementById('global-debug-content');
            if (debugContent) {
                debugContent.textContent = '';
            }
            globalDebugLog('Ë∞ÉËØïÊó•ÂøóÂ∑≤Ê∏ÖÁ©∫');
        };
        
        // ÈîÆÁõòÂø´Êç∑ÈîÆÁõëÂê¨
        document.addEventListener('keydown', function(e) {
            // F12ÈîÆÂàáÊç¢Ë∞ÉËØïÈù¢Êùø
            if (e.key === 'F12') {
                e.preventDefault();
                window.toggleDebugPanel();
            }
        });
        
        // Ë∞ÉËØïÈù¢ÊùøÊåâÈíÆ‰∫ã‰ª∂
        document.addEventListener('DOMContentLoaded', function() {
            const closeBtn = document.getElementById('close-debug-panel');
            const clearBtn = document.getElementById('clear-debug-log');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    document.getElementById('global-debug-panel').classList.add('hidden');
                });
            }
            
            if (clearBtn) {
                clearBtn.addEventListener('click', window.clearDebugLog);
            }
            
            // AIÂä©ÊâãÊµÆÁ™óÂäüËÉΩÂàùÂßãÂåñ
            initAIAssistant();
        });
        
        // AIÂä©ÊâãÊµÆÁ™óÂäüËÉΩ
        function initAIAssistant() {
            const aiFloat = document.getElementById('aiAssistantFloat');
            const aiAvatar = document.getElementById('aiAssistantAvatar');
            const chatWindow = document.getElementById('aiChatWindow');
            const closeChatBtn = document.getElementById('closeChatBtn');
            const maximizeBtn = document.getElementById('maximizeChatBtn');
            const historyBtn = document.getElementById('historyChatBtn');
            const summaryBtn = document.getElementById('summaryChatBtn');
            const chatInput = document.getElementById('aiChatInput');
            const sendBtn = document.getElementById('sendChatBtn');
            const messagesContainer = document.getElementById('aiChatMessages');
            
            // ÂéÜÂè≤ÂØπËØùÁõ∏ÂÖ≥ÂÖÉÁ¥†
            const historyModal = document.getElementById('aiHistoryModal');
            const closeHistoryBtn = document.getElementById('closeHistoryBtn');
            const historySearchInput = document.getElementById('historySearchInput');
            const historyList = document.getElementById('aiHistoryList');
            const loadHistoryBtn = document.getElementById('loadHistoryBtn');
            const cancelHistoryBtn = document.getElementById('cancelHistoryBtn');
            
            if (!aiFloat || !aiAvatar || !chatWindow) return;
            
            // ÂØπËØùÁä∂ÊÄÅÁÆ°ÁêÜ
            let conversationHistory = [];
            let conversationId = generateConversationId();
            let isMaximized = false;
            let selectedHistoryId = null;
            
            let isDragging = false;
            let dragOffset = { x: 0, y: 0 };
            let isWindowOpen = false;
            let dragStartTime = 0;
            let dragStartPos = { x: 0, y: 0 };
            let hasMoved = false;
            
            // ÊãñÊãΩÂäüËÉΩ
            aiAvatar.addEventListener('mousedown', function(e) {
                dragStartTime = Date.now();
                dragStartPos.x = e.clientX;
                dragStartPos.y = e.clientY;
                isDragging = true;
                hasMoved = false;
                aiAvatar.classList.add('dragging');
                const rect = aiFloat.getBoundingClientRect();
                dragOffset.x = e.clientX - rect.left;
                dragOffset.y = e.clientY - rect.top;
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    const moveDistance = Math.abs(e.clientX - dragStartPos.x) + Math.abs(e.clientY - dragStartPos.y);
                    
                    // Â¶ÇÊûúÁßªÂä®Ë∑ùÁ¶ªË∂ÖËøá5ÂÉèÁ¥†ÔºåËÆ§‰∏∫ÊòØÊãñÊãΩ
                    if (moveDistance > 5) {
                        hasMoved = true;
                        const x = e.clientX - dragOffset.x;
                        const y = e.clientY - dragOffset.y;
                        
                        // ÈôêÂà∂Âú®Á™óÂè£ËåÉÂõ¥ÂÜÖ
                        const maxX = window.innerWidth - 60;
                        const maxY = window.innerHeight - 60;
                        
                        aiFloat.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
                        aiFloat.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
                        aiFloat.style.right = 'auto';
                        aiFloat.style.bottom = 'auto';
                    }
                }
            });
            
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    const dragDuration = Date.now() - dragStartTime;
                    isDragging = false;
                    aiAvatar.classList.remove('dragging');
                    
                    // Â¶ÇÊûúÊ≤°ÊúâÁßªÂä®‰∏îÊó∂Èó¥ÂæàÁü≠ÔºåËÆ§‰∏∫ÊòØÁÇπÂáª
                    if (!hasMoved && dragDuration < 300) {
                        toggleChatWindow();
                    }
                }
            });
            
            // ÁÇπÂáªÂàáÊç¢ËÅäÂ§©Á™óÂè£ - ÁßªÈô§Ëøô‰∏™‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÈÅøÂÖçÈáçÂ§çËß¶Âèë
            // aiAvatar.addEventListener('click', function(e) {
            //     if (!isDragging) {
            //         toggleChatWindow();
            //     }
            // });
            
            // ÂÖ≥Èó≠ÊåâÈíÆ
            if (closeChatBtn) {
                closeChatBtn.addEventListener('click', function() {
                    toggleChatWindow();
                });
            }
            
            // ÊúÄÂ§ßÂåñÊåâÈíÆ‰∫ã‰ª∂
            if (maximizeBtn) {
                maximizeBtn.addEventListener('click', toggleMaximize);
            }
            
            // ÂéÜÂè≤ËÆ∞ÂΩïÊåâÈíÆ‰∫ã‰ª∂
            if (historyBtn) {
                historyBtn.addEventListener('click', showHistoryModal);
            }
            
            // ÊÄªÁªìÊåâÈíÆ‰∫ã‰ª∂
            if (summaryBtn) {
                summaryBtn.addEventListener('click', summarizeConversation);
            }
            
            // ÂéÜÂè≤ÂØπËØùÂºπÁ™ó‰∫ã‰ª∂
            if (closeHistoryBtn) {
                closeHistoryBtn.addEventListener('click', hideHistoryModal);
            }
            
            if (cancelHistoryBtn) {
                cancelHistoryBtn.addEventListener('click', hideHistoryModal);
            }
            
            if (loadHistoryBtn) {
                loadHistoryBtn.addEventListener('click', loadSelectedHistory);
            }
            
            if (historySearchInput) {
                historySearchInput.addEventListener('input', filterHistoryList);
            }
            
            // ÂèëÈÄÅÊ∂àÊÅØ
            function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
                conversationHistory.push({role: 'user', content: message});
                addMessage(message, 'user');
                chatInput.value = '';
                
                // Ë∞ÉÁî®ÂêéÁ´ØAIÊé•Âè£Ôºå‰º†ÈÄíÂØπËØùÂéÜÂè≤
                if (window.bridge && window.bridge.chatWithAI) {
                    const historyJson = JSON.stringify(conversationHistory.slice(0, -1)); // ‰∏çÂåÖÂê´ÂΩìÂâçÊ∂àÊÅØ
                    window.bridge.chatWithAI(message, historyJson, function(response) {
                        try {
                            const result = JSON.parse(response);
                            if (result.success) {
                                // Ê∑ªÂä†AIÂõûÂ§çÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
                                conversationHistory.push({role: 'assistant', content: result.message});
                                addMessage(result.message, 'ai');
                            } else {
                                const errorMsg = 'Êä±Ê≠âÔºåÊàëÁé∞Âú®Êó†Ê≥ïÂõûÁ≠îËøô‰∏™ÈóÆÈ¢ò„ÄÇ';
                                conversationHistory.push({role: 'assistant', content: errorMsg});
                                addMessage(errorMsg, 'ai');
                            }
                        } catch (e) {
                            const errorMsg = 'Êä±Ê≠âÔºåÊàëÁé∞Âú®Êó†Ê≥ïÂõûÁ≠îËøô‰∏™ÈóÆÈ¢ò„ÄÇ';
                            conversationHistory.push({role: 'assistant', content: errorMsg});
                            addMessage(errorMsg, 'ai');
                        }
                    });
                } else {
                    // Ê®°ÊãüAIÂõûÂ§ç
                    setTimeout(() => {
                        const aiResponse = generateAIResponse(message);
                        conversationHistory.push({role: 'assistant', content: aiResponse});
                        addMessage(aiResponse, 'ai');
                    }, 1000);
                }
            }
            
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }
            
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            
            // ÂàáÊç¢ËÅäÂ§©Á™óÂè£ÊòæÁ§∫/ÈöêËóè
            function toggleChatWindow() {
                isWindowOpen = !isWindowOpen;
                if (isWindowOpen) {
                    chatWindow.classList.add('show');
                    chatInput.focus();
                } else {
                    chatWindow.classList.remove('show');
                    // ‰øùÂ≠òÂØπËØù
                    if (conversationHistory.length > 0) {
                        saveCurrentConversation();
                    }
                }
            }
            
            // ÊúÄÂ§ßÂåñ/ËøòÂéüËÅäÂ§©Á™óÂè£
            function toggleMaximize() {
                isMaximized = !isMaximized;
                if (isMaximized) {
                    chatWindow.classList.add('maximized');
                    maximizeBtn.querySelector('span').textContent = 'fullscreen_exit';
                    maximizeBtn.title = 'ËøòÂéü';
                } else {
                    chatWindow.classList.remove('maximized');
                    maximizeBtn.querySelector('span').textContent = 'fullscreen';
                    maximizeBtn.title = 'ÊúÄÂ§ßÂåñ';
                }
            }
            
            // ÁîüÊàêÂØπËØùID
            function generateConversationId() {
                return 'chat_' + new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            }
            
            // Ê∑ªÂä†Ê∂àÊÅØÂà∞ËÅäÂ§©Á™óÂè£
            function addMessage(content, type) {
                if (!messagesContainer) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                
                if (type === 'ai') {
                    avatar.className += ' bg-primary';
                    avatar.innerHTML = '<span class="material-icons-outlined text-white text-sm">pets</span>';
                } else {
                    avatar.className += ' bg-blue-500';
                    avatar.innerHTML = '<span class="material-icons-outlined text-white text-sm">person</span>';
                }
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                messageContent.innerHTML = content.replace(/\n/g, '<br>');
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(messageContent);
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // ÁîüÊàêAIÂõûÂ§çÔºàÁÆÄÂçïÁ§∫‰æãÔºâ
            function generateAIResponse(userMessage) {
                const responses = [
                    "ËøôÊòØ‰∏Ä‰∏™ÂæàÂ•ΩÁöÑÈóÆÈ¢òÔºÅËÆ©ÊàëÊù•Â∏Æ‰Ω†ÂàÜÊûê‰∏Ä‰∏ã„ÄÇ",
                    "Ê†πÊçÆÊàëÁöÑÁêÜËß£ÔºåËøô‰∏™ÈóÆÈ¢òÂèØ‰ª•‰ªéÂá†‰∏™ËßíÂ∫¶Êù•Áúã...",
                    "ÊàëÂª∫ËÆÆ‰Ω†ÂèØ‰ª•Â∞ùËØïËøôÊ†∑ÁöÑÊñπÊ≥ï...",
                    "ËøôËÆ©ÊàëÊÉ≥Âà∞‰∫Ü‰∏Ä‰∏™Áõ∏ÂÖ≥ÁöÑÊ¶ÇÂøµ...",
                    "ËÆ©Êàë‰∏∫‰Ω†ËØ¶ÁªÜËß£Èáä‰∏Ä‰∏ãËøô‰∏™Áü•ËØÜÁÇπ„ÄÇ",
                    "Ê±™ÔºÅ‰Ωú‰∏∫‰Ω†ÁöÑÂ≠¶‰π†‰ºô‰º¥ÔºåÊàëËßâÂæó‰Ω†ÂèØ‰ª•ËøôÊ†∑ÊÄùËÄÉ...",
                    "Ëøô‰∏™ÈóÆÈ¢òÂæàÊúâË∂£ÔºÅÊàë‰ª¨‰∏ÄËµ∑Êù•Êé¢ËÆ®‰∏Ä‰∏ãÂêß„ÄÇ"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            // ‰øùÂ≠òÂΩìÂâçÂØπËØù
            function saveCurrentConversation() {
                if (conversationHistory.length === 0) return;
                
                const conversationData = {
                    id: conversationId,
                    title: generateConversationTitle(),
                    conversation_history: conversationHistory
                };
                
                if (window.bridge && window.bridge.saveConversation) {
                    window.bridge.saveConversation(JSON.stringify(conversationData), function(response) {
                        try {
                            const result = JSON.parse(response);
                            if (result.success) {
                                console.log('ÂØπËØùÂ∑≤‰øùÂ≠ò');
                            }
                        } catch (e) {
                            console.error('‰øùÂ≠òÂØπËØùÂ§±Ë¥•:', e);
                        }
                    });
                }
            }
            
            // ÁîüÊàêÂØπËØùÊ†áÈ¢ò
            function generateConversationTitle() {
                if (conversationHistory.length > 0) {
                    const firstUserMessage = conversationHistory.find(msg => msg.role === 'user');
                    if (firstUserMessage) {
                        return firstUserMessage.content.substring(0, 20) + (firstUserMessage.content.length > 20 ? '...' : '');
                    }
                }
                return 'Êñ∞ÂØπËØù';
            }
            
            // ÊòæÁ§∫ÂéÜÂè≤ÂØπËØùÂºπÁ™ó
            function showHistoryModal() {
                if (historyModal) {
                    historyModal.classList.add('show');
                    loadHistoryList();
                }
            }
            
            // ÈöêËóèÂéÜÂè≤ÂØπËØùÂºπÁ™ó
            function hideHistoryModal() {
                if (historyModal) {
                    historyModal.classList.remove('show');
                    selectedHistoryId = null;
                }
            }
            
            // Âä†ËΩΩÂéÜÂè≤ÂØπËØùÂàóË°®
            function loadHistoryList() {
                if (!window.bridge || !window.bridge.loadConversationHistory) return;
                
                window.bridge.loadConversationHistory(function(response) {
                    try {
                        const result = JSON.parse(response);
                        if (result.success) {
                            displayHistoryList(result.conversations);
                        }
                    } catch (e) {
                        console.error('Âä†ËΩΩÂéÜÂè≤ÂØπËØùÂ§±Ë¥•:', e);
                    }
                });
            }
            
            // ÊòæÁ§∫ÂéÜÂè≤ÂØπËØùÂàóË°®
            function displayHistoryList(conversations) {
                if (!historyList) return;
                
                historyList.innerHTML = '';
                
                if (conversations.length === 0) {
                    historyList.innerHTML = '<div class="text-center text-gray-500 py-4">ÊöÇÊó†ÂØπËØùÂéÜÂè≤</div>';
                    return;
                }
                
                conversations.forEach(conv => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.dataset.id = conv.id;
                    
                    const title = document.createElement('div');
                    title.className = 'history-item-title';
                    title.textContent = conv.title || 'Êñ∞ÂØπËØù';
                    
                    const time = document.createElement('div');
                    time.className = 'history-item-time';
                    time.textContent = formatTimestamp(conv.timestamp);
                    
                    const preview = document.createElement('div');
                    preview.className = 'history-item-preview';
                    preview.textContent = `${conv.message_count} Êù°Ê∂àÊÅØ`;
                    
                    item.appendChild(title);
                    item.appendChild(time);
                    item.appendChild(preview);
                    
                    item.addEventListener('click', function() {
                        // Ê∏ÖÈô§ÂÖ∂‰ªñÈÄâ‰∏≠Áä∂ÊÄÅ
                        historyList.querySelectorAll('.history-item').forEach(el => {
                            el.classList.remove('selected');
                        });
                        // ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠
                        item.classList.add('selected');
                        selectedHistoryId = conv.id;
                    });
                    
                    historyList.appendChild(item);
                });
            }
            
            // Ê†ºÂºèÂåñÊó∂Èó¥Êà≥
            function formatTimestamp(timestamp) {
                if (!timestamp) return 'Êú™Áü•Êó∂Èó¥';
                try {
                    const date = new Date(timestamp);
                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                } catch (e) {
                    return 'Êú™Áü•Êó∂Èó¥';
                }
            }
            
            // ËøáÊª§ÂéÜÂè≤ÂØπËØùÂàóË°®
            function filterHistoryList() {
                const searchTerm = historySearchInput.value.toLowerCase();
                const items = historyList.querySelectorAll('.history-item');
                
                items.forEach(item => {
                    const title = item.querySelector('.history-item-title').textContent.toLowerCase();
                    const visible = title.includes(searchTerm);
                    item.style.display = visible ? 'block' : 'none';
                });
            }
            
            // Âä†ËΩΩÈÄâ‰∏≠ÁöÑÂéÜÂè≤ÂØπËØù
            function loadSelectedHistory() {
                if (!selectedHistoryId) return;
                
                if (window.bridge && window.bridge.loadConversationById) {
                    window.bridge.loadConversationById(selectedHistoryId, function(response) {
                        try {
                            const result = JSON.parse(response);
                            if (result.success) {
                                loadConversation(result.conversation);
                                hideHistoryModal();
                            }
                        } catch (e) {
                            console.error('Âä†ËΩΩÂØπËØùÂÜÖÂÆπÂ§±Ë¥•:', e);
                        }
                    });
                }
            }
            
            // Âä†ËΩΩÂØπËØùÂÜÖÂÆπ
            function loadConversation(conversationData) {
                // Ê∏ÖÁ©∫ÂΩìÂâçÂØπËØù
                messagesContainer.innerHTML = '';
                conversationHistory = [];
                
                // ËÆæÁΩÆÂØπËØùID
                conversationId = conversationData.id;
                
                // ÈáçÊñ∞ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ
                addMessage('Ê±™ÔºÅÊàëÊòØ‰Ω†ÁöÑÂ≠¶‰π†Â∞èÂä©ÊâãÔºåÊúâ‰ªÄ‰πàÈóÆÈ¢òÂèØ‰ª•ÈóÆÊàëÂì¶ÔºÅ', 'ai');
                
                // Âä†ËΩΩÂéÜÂè≤Ê∂àÊÅØ
                const history = conversationData.conversation_history || [];
                history.forEach(msg => {
                    conversationHistory.push(msg);
                    addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai');
                });
            }
            
            // ÊÄªÁªìÂØπËØù
            function summarizeConversation() {
                if (conversationHistory.length === 0) {
                    alert('Ê≤°ÊúâÂØπËØùÂÜÖÂÆπÂèØ‰ª•ÊÄªÁªì');
                    return;
                }
                
                if (window.bridge && window.bridge.summarizeConversation) {
                    const historyJson = JSON.stringify(conversationHistory);
                    window.bridge.summarizeConversation(historyJson, function(response) {
                        try {
                            const result = JSON.parse(response);
                            if (result.success) {
                                // Â∞ÜÊÄªÁªì‰Ωú‰∏∫AIÊ∂àÊÅØÊ∑ªÂä†Âà∞ÂØπËØù‰∏≠
                                const summaryMessage = 'üìã **ÂØπËØùÊÄªÁªì**\n\n' + result.summary;
                                conversationHistory.push({role: 'assistant', content: summaryMessage});
                                addMessage(summaryMessage, 'ai');
                            } else {
                                alert('ÊÄªÁªìÁîüÊàêÂ§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'));
                            }
                        } catch (e) {
                            alert('ÊÄªÁªìÂäüËÉΩÂºÇÂ∏∏');
                        }
                    });
                } else {
                    alert('ÊÄªÁªìÂäüËÉΩÊöÇ‰∏çÂèØÁî®');
                }
            }
            
            globalDebugLog('AIÂä©ÊâãÊµÆÁ™óÂàùÂßãÂåñÂÆåÊàê');
        }

        // ÂàùÂßãÂåñWebChannel
        new QWebChannel(qt.webChannelTransport, function (channel) {
            window.bridge = channel.objects.bridge;
            console.log("WebChannelËøûÊé•ÊàêÂäü");
            
            // Ëß¶ÂèëbridgeÂáÜÂ§áÂ∞±Áª™‰∫ã‰ª∂
            const bridgeReadyEvent = new CustomEvent('bridgeReady');
            document.dispatchEvent(bridgeReadyEvent);
            
            // Ë∞ÉÁî®Â≠êÊ®°ÊùøÁöÑÂàùÂßãÂåñ‰ª£Á†Å
            if (typeof onBridgeReady === 'function') {
                onBridgeReady();
            }
        });
        
        // Ë∞ÉÁî®PythonÂáΩÊï∞
        function callPythonFunction(functionName, ...args) {
            if (bridge && bridge[functionName]) {
                bridge[functionName](...args);
            }
        }
    </script>
    {% endblock %}
    
    <!-- Â≠êÊ®°ÊùøÁöÑbridgeÂàùÂßãÂåñ‰ª£Á†Å -->
    {% block on_bridge_ready %}{% endblock %}
</body>
</html>
