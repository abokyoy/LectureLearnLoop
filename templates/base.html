<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}æŸ¯åŸºå­¦ä¹ å°åŠ©æ‰‹{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#32C77F",
                        warning: "#FF9B27", 
                        danger: "#ED4B4B",
                        "text-dark-brown": "#715D46",
                        "text-medium-brown": "#9B8D7D",
                        "text-gray": "#828282",
                        "bg-light-blue": "#D5F8FF",
                        "bg-beige": "#FFFFD6",
                        "bg-light-green": "#E2F2EB",
                        "bg-light-gray": "#F2F0ED",
                        "bg-light-blue-gray": "#F5F7F9",
                    },
                    fontFamily: {
                        sans: ['"Noto Sans SC"', 'sans-serif'],
                    },
                    borderRadius: {
                        'xl': '1rem',
                    },
                },
            },
        };
    </script>
    
    {% block extra_head %}{% endblock %}
    
    <style>
        /* AIåŠ©æ‰‹æµ®çª—æ ·å¼ */
        .ai-assistant-float {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .ai-assistant-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #32C77F, #28a745);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(50, 199, 127, 0.3);
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .ai-assistant-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(50, 199, 127, 0.4);
        }
        
        .ai-assistant-avatar.dragging {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(50, 199, 127, 0.5);
        }
        
        .ai-chat-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 9998;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .ai-chat-window.show {
            display: flex;
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .ai-chat-header {
            background: linear-gradient(135deg, #32C77F, #28a745);
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #f8f9fa;
        }
        
        .ai-chat-input {
            padding: 16px;
            border-top: 1px solid #e9ecef;
            background: white;
        }
        
        .message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .message.ai .message-content {
            background: #e2f2eb;
            color: #2d5a3d;
        }
        
        .message.user .message-content {
            background: #32C77F;
            color: white;
        }
    </style>
</head>
<body class="bg-bg-light-blue-gray font-sans">
    <!-- AIåŠ©æ‰‹æµ®çª— -->
    <div class="ai-assistant-float" id="aiAssistantFloat">
        <div class="ai-assistant-avatar" id="aiAssistantAvatar">
            <span class="material-icons-outlined text-white text-2xl">pets</span>
        </div>
    </div>
    
    <!-- AIèŠå¤©çª—å£ -->
    <div class="ai-chat-window" id="aiChatWindow">
        <div class="ai-chat-header">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <span class="material-icons-outlined text-sm">pets</span>
                </div>
                <div>
                    <h3 class="font-semibold">æŸ¯åŸºAIåŠ©æ‰‹</h3>
                    <p class="text-xs opacity-80">éšæ—¶ä¸ºæ‚¨ç­”ç–‘è§£æƒ‘</p>
                </div>
            </div>
            <button class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-1 transition-colors" id="closeChatBtn">
                <span class="material-icons-outlined text-sm">close</span>
            </button>
        </div>
        
        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="message ai">
                <div class="message-avatar bg-primary">
                    <span class="material-icons-outlined text-white text-sm">pets</span>
                </div>
                <div class="message-content">
                    ä½ å¥½ï¼æˆ‘æ˜¯æŸ¯åŸºAIåŠ©æ‰‹ ğŸ•<br>
                    æœ‰ä»€ä¹ˆå­¦ä¹ é—®é¢˜å¯ä»¥éšæ—¶é—®æˆ‘å“¦ï¼
                </div>
            </div>
        </div>
        
        <div class="ai-chat-input">
            <div class="flex gap-2">
                <input type="text" 
                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm" 
                       placeholder="è¾“å…¥ä½ çš„é—®é¢˜..."
                       id="aiChatInput">
                <button class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors flex items-center" 
                        id="sendChatBtn">
                    <span class="material-icons-outlined text-sm">send</span>
                </button>
            </div>
        </div>
    </div>
    <!-- å…¨å±€è°ƒè¯•é¢æ¿ -->
    <div id="global-debug-panel" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="absolute right-4 top-4 bottom-4 w-1/3 bg-white rounded-lg shadow-2xl flex flex-col">
            <!-- è°ƒè¯•é¢æ¿å¤´éƒ¨ -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                <div class="flex items-center">
                    <span class="material-icons-outlined text-blue-600 mr-2">bug_report</span>
                    <h3 class="text-lg font-semibold text-gray-800">è°ƒè¯•é¢æ¿</h3>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="clear-debug-log" class="p-1 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded">
                        <span class="material-icons-outlined text-sm">clear_all</span>
                    </button>
                    <button id="close-debug-panel" class="p-1 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded">
                        <span class="material-icons-outlined text-sm">close</span>
                    </button>
                </div>
            </div>
            
            <!-- è°ƒè¯•å†…å®¹åŒºåŸŸ -->
            <div class="flex-1 overflow-hidden flex flex-col">
                <div class="p-3 border-b border-gray-100 bg-blue-50">
                    <div class="text-xs text-blue-700 font-medium">å®æ—¶æ—¥å¿— (æŒ‰F12å¼€å¯/å…³é—­)</div>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <pre id="global-debug-content" class="text-xs font-mono text-gray-700 whitespace-pre-wrap leading-relaxed"></pre>
                </div>
            </div>
        </div>
    </div>

    {% block content %}{% endblock %}
    
    {% block scripts %}
    <script>
        // è®©bridgeæŒ‚åˆ°windowï¼Œç¡®ä¿åŠ¨æ€æ³¨å…¥çš„é¡µé¢ä¹Ÿèƒ½è®¿é—®åˆ°window.bridge
        window.bridge = null;
        
        // å…¨å±€è°ƒè¯•é¢æ¿åŠŸèƒ½
        window.globalDebugLogs = [];
        
        // å…¨å±€è°ƒè¯•æ—¥å¿—å‡½æ•°
        window.globalDebugLog = function(message) {
            const timestamp = new Date().toISOString();
            const logEntry = `${timestamp} - INFO - ${message}`;
            
            // æ·»åŠ åˆ°å…¨å±€æ—¥å¿—æ•°ç»„
            window.globalDebugLogs.push(logEntry);
            
            // æ›´æ–°è°ƒè¯•é¢æ¿æ˜¾ç¤º
            const debugContent = document.getElementById('global-debug-content');
            if (debugContent) {
                const displayTime = new Date().toLocaleTimeString();
                debugContent.textContent += `[${displayTime}] ${message}\n`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            
            console.log(message);
            
            // å‘é€åˆ°Pythonåç«¯è®°å½•åˆ°æ–‡ä»¶
            if (window.bridge && window.bridge.logFrontendMessage) {
                try {
                    window.bridge.logFrontendMessage(logEntry);
                } catch (e) {
                    console.warn('æ— æ³•å‘é€æ—¥å¿—åˆ°åç«¯:', e);
                }
            }
        };
        
        // å…¨å±€è°ƒè¯•é”™è¯¯å‡½æ•°
        window.globalDebugError = function(message) {
            const timestamp = new Date().toISOString();
            const logEntry = `${timestamp} - ERROR - ${message}`;
            
            window.globalDebugLogs.push(logEntry);
            
            const debugContent = document.getElementById('global-debug-content');
            if (debugContent) {
                const displayTime = new Date().toLocaleTimeString();
                debugContent.textContent += `[${displayTime}] ERROR: ${message}\n`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            
            console.error(message);
            
            if (window.bridge && window.bridge.logFrontendMessage) {
                try {
                    window.bridge.logFrontendMessage(logEntry);
                } catch (e) {
                    console.warn('æ— æ³•å‘é€é”™è¯¯æ—¥å¿—åˆ°åç«¯:', e);
                }
            }
        };
        
        // è°ƒè¯•é¢æ¿æ§åˆ¶å‡½æ•°
        window.toggleDebugPanel = function() {
            const panel = document.getElementById('global-debug-panel');
            if (panel) {
                const isHidden = panel.classList.contains('hidden');
                if (isHidden) {
                    panel.classList.remove('hidden');
                    globalDebugLog('è°ƒè¯•é¢æ¿å·²æ‰“å¼€');
                } else {
                    panel.classList.add('hidden');
                    globalDebugLog('è°ƒè¯•é¢æ¿å·²å…³é—­');
                }
            }
        };
        
        // æ¸…ç©ºè°ƒè¯•æ—¥å¿—
        window.clearDebugLog = function() {
            window.globalDebugLogs = [];
            const debugContent = document.getElementById('global-debug-content');
            if (debugContent) {
                debugContent.textContent = '';
            }
            globalDebugLog('è°ƒè¯•æ—¥å¿—å·²æ¸…ç©º');
        };
        
        // é”®ç›˜å¿«æ·é”®ç›‘å¬
        document.addEventListener('keydown', function(e) {
            // F12é”®åˆ‡æ¢è°ƒè¯•é¢æ¿
            if (e.key === 'F12') {
                e.preventDefault();
                window.toggleDebugPanel();
            }
        });
        
        // è°ƒè¯•é¢æ¿æŒ‰é’®äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const closeBtn = document.getElementById('close-debug-panel');
            const clearBtn = document.getElementById('clear-debug-log');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    document.getElementById('global-debug-panel').classList.add('hidden');
                });
            }
            
            if (clearBtn) {
                clearBtn.addEventListener('click', window.clearDebugLog);
            }
            
            // AIåŠ©æ‰‹æµ®çª—åŠŸèƒ½åˆå§‹åŒ–
            initAIAssistant();
        });
        
        // AIåŠ©æ‰‹æµ®çª—åŠŸèƒ½
        function initAIAssistant() {
            const aiFloat = document.getElementById('aiAssistantFloat');
            const aiAvatar = document.getElementById('aiAssistantAvatar');
            const chatWindow = document.getElementById('aiChatWindow');
            const closeChatBtn = document.getElementById('closeChatBtn');
            const chatInput = document.getElementById('aiChatInput');
            const sendBtn = document.getElementById('sendChatBtn');
            const messagesContainer = document.getElementById('aiChatMessages');
            
            if (!aiFloat || !aiAvatar || !chatWindow) return;
            
            let isDragging = false;
            let dragOffset = { x: 0, y: 0 };
            let isWindowOpen = false;
            let dragStartTime = 0;
            let dragStartPos = { x: 0, y: 0 };
            let hasMoved = false;
            
            // æ‹–æ‹½åŠŸèƒ½
            aiAvatar.addEventListener('mousedown', function(e) {
                dragStartTime = Date.now();
                dragStartPos.x = e.clientX;
                dragStartPos.y = e.clientY;
                isDragging = true;
                hasMoved = false;
                aiAvatar.classList.add('dragging');
                const rect = aiFloat.getBoundingClientRect();
                dragOffset.x = e.clientX - rect.left;
                dragOffset.y = e.clientY - rect.top;
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    const moveDistance = Math.abs(e.clientX - dragStartPos.x) + Math.abs(e.clientY - dragStartPos.y);
                    
                    // å¦‚æœç§»åŠ¨è·ç¦»è¶…è¿‡5åƒç´ ï¼Œè®¤ä¸ºæ˜¯æ‹–æ‹½
                    if (moveDistance > 5) {
                        hasMoved = true;
                        const x = e.clientX - dragOffset.x;
                        const y = e.clientY - dragOffset.y;
                        
                        // é™åˆ¶åœ¨çª—å£èŒƒå›´å†…
                        const maxX = window.innerWidth - 60;
                        const maxY = window.innerHeight - 60;
                        
                        aiFloat.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
                        aiFloat.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
                        aiFloat.style.right = 'auto';
                        aiFloat.style.bottom = 'auto';
                    }
                }
            });
            
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    const dragDuration = Date.now() - dragStartTime;
                    isDragging = false;
                    aiAvatar.classList.remove('dragging');
                    
                    // å¦‚æœæ²¡æœ‰ç§»åŠ¨ä¸”æ—¶é—´å¾ˆçŸ­ï¼Œè®¤ä¸ºæ˜¯ç‚¹å‡»
                    if (!hasMoved && dragDuration < 300) {
                        toggleChatWindow();
                    }
                }
            });
            
            // ç‚¹å‡»åˆ‡æ¢èŠå¤©çª—å£ - ç§»é™¤è¿™ä¸ªäº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤è§¦å‘
            // aiAvatar.addEventListener('click', function(e) {
            //     if (!isDragging) {
            //         toggleChatWindow();
            //     }
            // });
            
            // å…³é—­æŒ‰é’®
            if (closeChatBtn) {
                closeChatBtn.addEventListener('click', function() {
                    toggleChatWindow();
                });
            }
            
            // å‘é€æ¶ˆæ¯
            function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                addMessage(message, 'user');
                chatInput.value = '';
                
                // è°ƒç”¨åç«¯AIæ¥å£
                if (window.bridge && window.bridge.chatWithAI) {
                    window.bridge.chatWithAI(message, function(response) {
                        try {
                            const result = JSON.parse(response);
                            if (result.success) {
                                addMessage(result.message, 'ai');
                            } else {
                                addMessage('æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜ã€‚', 'ai');
                            }
                        } catch (e) {
                            addMessage('æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜ã€‚', 'ai');
                        }
                    });
                } else {
                    // æ¨¡æ‹ŸAIå›å¤
                    setTimeout(() => {
                        const aiResponse = generateAIResponse(message);
                        addMessage(aiResponse, 'ai');
                    }, 1000);
                }
            }
            
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }
            
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            
            // åˆ‡æ¢èŠå¤©çª—å£æ˜¾ç¤º
            function toggleChatWindow() {
                isWindowOpen = !isWindowOpen;
                if (isWindowOpen) {
                    chatWindow.classList.add('show');
                    if (chatInput) chatInput.focus();
                    globalDebugLog('AIåŠ©æ‰‹èŠå¤©çª—å£å·²æ‰“å¼€');
                } else {
                    chatWindow.classList.remove('show');
                    globalDebugLog('AIåŠ©æ‰‹èŠå¤©çª—å£å·²å…³é—­');
                }
            }
            
            // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
            function addMessage(content, type) {
                if (!messagesContainer) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                
                if (type === 'ai') {
                    avatar.className += ' bg-primary';
                    avatar.innerHTML = '<span class="material-icons-outlined text-white text-sm">pets</span>';
                } else {
                    avatar.className += ' bg-blue-500';
                    avatar.innerHTML = '<span class="material-icons-outlined text-white text-sm">person</span>';
                }
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                messageContent.innerHTML = content.replace(/\n/g, '<br>');
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(messageContent);
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // ç”ŸæˆAIå›å¤ï¼ˆç®€å•ç¤ºä¾‹ï¼‰
            function generateAIResponse(userMessage) {
                const responses = [
                    "è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼è®©æˆ‘æ¥å¸®ä½ åˆ†æä¸€ä¸‹ã€‚",
                    "æ ¹æ®æˆ‘çš„ç†è§£ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥ä»å‡ ä¸ªè§’åº¦æ¥çœ‹...",
                    "æˆ‘å»ºè®®ä½ å¯ä»¥å°è¯•è¿™æ ·çš„æ–¹æ³•...",
                    "è¿™è®©æˆ‘æƒ³åˆ°äº†ä¸€ä¸ªç›¸å…³çš„æ¦‚å¿µ...",
                    "è®©æˆ‘ä¸ºä½ è¯¦ç»†è§£é‡Šä¸€ä¸‹è¿™ä¸ªçŸ¥è¯†ç‚¹ã€‚",
                    "æ±ªï¼ä½œä¸ºä½ çš„å­¦ä¹ ä¼™ä¼´ï¼Œæˆ‘è§‰å¾—ä½ å¯ä»¥è¿™æ ·æ€è€ƒ...",
                    "è¿™ä¸ªé—®é¢˜å¾ˆæœ‰è¶£ï¼æˆ‘ä»¬ä¸€èµ·æ¥æ¢è®¨ä¸€ä¸‹å§ã€‚"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            globalDebugLog('AIåŠ©æ‰‹æµ®çª—åˆå§‹åŒ–å®Œæˆ');
        }

        // åˆå§‹åŒ–WebChannel
        new QWebChannel(qt.webChannelTransport, function (channel) {
            window.bridge = channel.objects.bridge;
            console.log("WebChannelè¿æ¥æˆåŠŸ");
            
            // è§¦å‘bridgeå‡†å¤‡å°±ç»ªäº‹ä»¶
            const bridgeReadyEvent = new CustomEvent('bridgeReady');
            document.dispatchEvent(bridgeReadyEvent);
            
            // è°ƒç”¨å­æ¨¡æ¿çš„åˆå§‹åŒ–ä»£ç 
            if (typeof onBridgeReady === 'function') {
                onBridgeReady();
            }
        });
        
        // è°ƒç”¨Pythonå‡½æ•°
        function callPythonFunction(functionName, ...args) {
            if (bridge && bridge[functionName]) {
                bridge[functionName](...args);
            }
        }
    </script>
    {% endblock %}
    
    <!-- å­æ¨¡æ¿çš„bridgeåˆå§‹åŒ–ä»£ç  -->
    {% block on_bridge_ready %}{% endblock %}
</body>
</html>
