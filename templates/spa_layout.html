{% extends "base.html" %}

{% block title %}柯基学习小助手{% endblock %}

{% block content %}
<div class="flex h-screen bg-white">
    {% include "components/sidebar.html" %}
    
    <!-- 右侧内容区域 -->
    <main class="flex-1 flex flex-col">
        {% include "components/header.html" %}
        
        <!-- 动态内容区域 -->
        <div id="content-area" class="flex-1 bg-bg-light-blue-gray overflow-auto">
            {% block page_content %}
            <!-- 默认加载工作台内容 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                            <span class="material-icons-outlined text-blue-600">school</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-text-dark-brown">学习模块</h3>
                            <p class="text-sm text-text-gray">从资料和音视频中学习</p>
                        </div>
                    </div>
                    <div class="text-2xl font-bold text-blue-600 mb-2">12</div>
                    <p class="text-sm text-text-gray">本周学习资料数</p>
                    <div class="mt-4">
                        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700" onclick="handleMenuClick('learn_from_materials')">
                            开始学习
                        </button>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                            <span class="material-icons-outlined text-green-600">fitness_center</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-text-dark-brown">练习模块</h3>
                            <p class="text-sm text-text-gray">知识点和错题练习</p>
                        </div>
                    </div>
                    <div class="text-2xl font-bold text-green-600 mb-2">85%</div>
                    <p class="text-sm text-text-gray">本周练习正确率</p>
                    <div class="mt-4">
                        <button class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700" onclick="handleMenuClick('practice_knowledge')">
                            开始练习
                        </button>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                            <span class="material-icons-outlined text-purple-600">psychology</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-text-dark-brown">记忆模块</h3>
                            <p class="text-sm text-text-gray">知识点记忆和复习</p>
                        </div>
                    </div>
                    <div class="text-2xl font-bold text-purple-600 mb-2">156</div>
                    <p class="text-sm text-text-gray">已掌握知识点数</p>
                    <div class="mt-4">
                        <button class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700" onclick="handleMenuClick('memory_knowledge')">
                            开始记忆
                        </button>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm col-span-full">
                    <h3 class="text-lg font-semibold text-text-dark-brown mb-4">最近学习活动</h3>
                    <div class="space-y-3">
                        <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                <span class="material-icons-outlined text-blue-600 text-sm">article</span>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-text-dark-brown">学习了《机器学习基础》</p>
                                <p class="text-sm text-text-gray">2小时前</p>
                            </div>
                        </div>
                        <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                <span class="material-icons-outlined text-green-600 text-sm">quiz</span>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-text-dark-brown">完成了线性回归练习</p>
                                <p class="text-sm text-text-gray">4小时前</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endblock %}
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    let sidebarCollapsed = false;
    
    // 侧边栏收缩/展开
    window.toggleSidebar = function() {
        console.log('toggleSidebar被调用，当前状态:', sidebarCollapsed);
        const sidebar = document.getElementById('sidebar');
        const appTitle = document.getElementById('app-title');
        const userInfo = document.getElementById('user-info');
        const menuTexts = document.querySelectorAll('.menu-text');
        const expandIcons = document.querySelectorAll('.expand-icon');
        const toggleIcon = document.getElementById('toggle-icon');
        
        console.log('找到的元素:', {sidebar, appTitle, userInfo, menuTexts: menuTexts.length, expandIcons: expandIcons.length, toggleIcon});
        
        sidebarCollapsed = !sidebarCollapsed;
        
        if (sidebarCollapsed) {
            // 收缩状态
            sidebar.classList.remove('w-64');
            sidebar.classList.add('w-16');
            sidebar.classList.add('collapsed');
            
            // 隐藏文字元素
            appTitle.classList.add('hidden');
            userInfo.classList.add('hidden');
            menuTexts.forEach(text => text.classList.add('hidden'));
            expandIcons.forEach(icon => icon.classList.add('hidden'));
            
            // 隐藏所有子菜单
            document.querySelectorAll('.submenu').forEach(submenu => {
                submenu.classList.add('hidden');
            });
            
            // 更改图标
            if (toggleIcon) {
                toggleIcon.textContent = 'chevron_right';
            }
        } else {
            // 展开状态
            sidebar.classList.remove('w-16');
            sidebar.classList.add('w-64');
            sidebar.classList.remove('collapsed');
            
            // 显示文字元素
            appTitle.classList.remove('hidden');
            userInfo.classList.remove('hidden');
            menuTexts.forEach(text => text.classList.remove('hidden'));
            expandIcons.forEach(icon => icon.classList.remove('hidden'));
            
            // 更改图标
            if (toggleIcon) {
                toggleIcon.textContent = 'chevron_left';
            }
        }
    }
    
    // 处理菜单点击
    function handleMenuClick(menuId) {
        if (sidebarCollapsed) {
            // 如果侧边栏收缩，先展开
            toggleSidebar();
            return;
        }
        
        if (bridge && bridge.toggleMenu) {
            bridge.toggleMenu(menuId).then(function(menuStateJson) {
                const menuState = JSON.parse(menuStateJson);
                updateMenuDisplay(menuState);
            });
        }
    }
    
    // 更新菜单显示状态
    function updateMenuDisplay(menuState) {
        Object.keys(menuState).forEach(menuId => {
            const menuItem = document.querySelector(`[onclick="handleMenuClick('${menuId}')"]`);
            if (menuItem) {
                const submenu = menuItem.parentElement.querySelector('.submenu');
                const expandIcon = menuItem.querySelector('.expand-icon');
                
                if (submenu && expandIcon) {
                    if (menuState[menuId].expanded) {
                        submenu.classList.remove('hidden');
                        expandIcon.textContent = 'expand_less';
                    } else {
                        submenu.classList.add('hidden');
                        expandIcon.textContent = 'expand_more';
                    }
                }
            }
        });
    }
    
    // 更新内容区域（确保动态插入的<script>被执行）
    function updateContentArea(htmlContent) {
        const contentArea = document.getElementById('content-area');
        if (!contentArea) {
            console.error('[SPA] 未找到content-area容器');
            return;
        }

        // 注入HTML
        contentArea.innerHTML = htmlContent;
        console.log('[SPA] 已注入HTML，开始处理脚本');

        // 选出当前容器内的所有<script>，逐个重新创建执行
        const scripts = Array.from(contentArea.querySelectorAll('script'));
        console.log(`[SPA] 发现脚本数量: ${scripts.length}`);

        scripts.forEach((oldScript, idx) => {
            const newScript = document.createElement('script');
            // 复制属性（如type、src、async等）
            Array.from(oldScript.attributes).forEach(attr => {
                newScript.setAttribute(attr.name, attr.value);
            });

            if (oldScript.src) {
                // 外部脚本：重新加载
                newScript.onload = () => console.log(`[SPA] 外部脚本加载完成(${idx+1}/${scripts.length}):`, oldScript.src);
                newScript.onerror = (e) => console.error(`[SPA] 外部脚本加载失败:`, oldScript.src, e);
                newScript.src = oldScript.src;
            } else {
                // 内联脚本：直接复制文本以触发执行
                newScript.text = oldScript.textContent || '';
            }

            // 用新脚本替换旧脚本节点
            oldScript.parentNode.replaceChild(newScript, oldScript);
        });

        console.log('[SPA] 脚本处理完成');

        // 调用注入页面的挂载钩子（如有）
        try {
            if (typeof window.onPageMounted === 'function') {
                console.log('[SPA] 发现 onPageMounted 钩子，开始调用');
                window.onPageMounted();
                console.log('[SPA] onPageMounted 调用结束');
            } else {
                console.log('[SPA] 未发现 onPageMounted 钩子');
            }
        } catch (hookErr) {
            console.error('[SPA] 调用 onPageMounted 出错:', hookErr);
        }
    }
    
    // 更新页面标题
    function updatePageTitle(title) {
        const pageTitle = document.getElementById('page-title');
        if (pageTitle) {
            pageTitle.textContent = title;
        }
    }
    
    // 设置活动菜单项
    function setActiveMenuItem(menuId) {
        // 移除所有活动状态
        document.querySelectorAll('.menu-item a').forEach(item => {
            item.classList.remove('text-white', 'bg-primary');
            item.classList.add('text-text-gray');
        });
        
        // 设置当前活动项
        const activeItem = document.querySelector(`[onclick="handleMenuClick('${menuId}')"]`);
        if (activeItem) {
            activeItem.classList.remove('text-text-gray');
            activeItem.classList.add('text-white', 'bg-primary');
        }
    }
</script>

{% block on_bridge_ready %}
<script>
    // SPA特定的初始化代码
    console.log('SPA布局初始化');
</script>
{% endblock %}
{% endblock %}
