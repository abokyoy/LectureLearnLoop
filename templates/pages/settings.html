<!-- è®¾ç½®é¡µé¢ -->
<style>
    .config-group {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        padding: 20px;
    }
    .config-group h3 {
        color: #2d3748;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 16px;
        border-bottom: 2px solid #32C77F;
        padding-bottom: 8px;
    }
    .form-row {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
    }
    .form-row label {
        width: 120px;
        color: #4a5568;
        font-weight: 500;
    }
    .form-row input, .form-row select {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        font-size: 14px;
    }
    .form-row input:focus, .form-row select:focus {
        outline: none;
        border-color: #32C77F;
        box-shadow: 0 0 0 3px rgba(50, 199, 127, 0.1);
    }
    .provider-radio {
        margin-bottom: 8px;
    }
    .provider-radio input[type="radio"] {
        margin-right: 8px;
    }
    .provider-radio label {
        color: #2d3748;
        font-weight: 500;
        cursor: pointer;
    }
    .save-btn {
        background: #32C77F;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .save-btn:hover {
        background: #2bb06a;
    }
    .save-btn:disabled {
        background: #a0aec0;
        cursor: not-allowed;
    }
    .status-message {
        padding: 10px 15px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 14px;
    }
    .status-success {
        background: #f0fff4;
        color: #22543d;
        border: 1px solid #9ae6b4;
    }
    .status-error {
        background: #fed7d7;
        color: #742a2a;
        border: 1px solid #feb2b2;
    }
</style>

<div class="p-8">
    <h1 class="text-2xl font-bold text-text-dark-brown mb-6">ç³»ç»Ÿè®¾ç½®</h1>
    
    <!-- å¤§è¯­è¨€æ¨¡å‹æä¾›å•† -->
    <div class="config-group">
        <h3>å¤§è¯­è¨€æ¨¡å‹æä¾›å•†</h3>
        <div class="provider-radio">
            <input type="radio" id="provider-deepseek" name="llm_provider" value="DeepSeek">
            <label for="provider-deepseek">DeepSeek (åœ¨çº¿)</label>
        </div>
        <div class="provider-radio">
            <input type="radio" id="provider-gemini" name="llm_provider" value="Gemini">
            <label for="provider-gemini">Gemini (äº‘ç«¯)</label>
        </div>
        <div class="provider-radio">
            <input type="radio" id="provider-qwen" name="llm_provider" value="Qwen">
            <label for="provider-qwen">é€šä¹‰åƒé—® (é˜¿é‡Œäº‘)</label>
        </div>
        <div class="provider-radio">
            <input type="radio" id="provider-ollama" name="llm_provider" value="Ollama">
            <label for="provider-ollama">Ollama (æœ¬åœ°)</label>
        </div>
    </div>

    <!-- DeepSeek è®¾ç½® -->
    <div class="config-group" id="deepseek-config">
        <h3>DeepSeek è®¾ç½®</h3>
        <div class="form-row">
            <label for="deepseek-key">API Key:</label>
            <input type="password" id="deepseek-key" placeholder="è¾“å…¥DeepSeek API Key">
        </div>
        <div class="form-row">
            <label for="deepseek-model">æ¨¡å‹åç§°:</label>
            <input type="text" id="deepseek-model" placeholder="deepseek-chat">
        </div>
        <div class="form-row">
            <label for="deepseek-url">API URL:</label>
            <input type="text" id="deepseek-url" placeholder="https://api.deepseek.com/v1/chat/completions">
        </div>
        <div class="form-row">
            <label></label>
            <button type="button" class="save-btn" onclick="testConnection('DeepSeek', 'DeepSeek')" style="margin-right: 10px;">
                ğŸ”— æµ‹è¯•è¿æ¥
            </button>
        </div>
    </div>

    <!-- Gemini è®¾ç½® -->
    <div class="config-group" id="gemini-config">
        <h3>Gemini è®¾ç½®</h3>
        <div class="form-row">
            <label for="gemini-key">API Key:</label>
            <input type="password" id="gemini-key" placeholder="è¾“å…¥Gemini API Key">
        </div>
        <div class="form-row">
            <label for="gemini-model">æ¨¡å‹åç§°:</label>
            <input type="text" id="gemini-model" placeholder="gemini-1.5-flash-002">
        </div>
        <div class="form-row">
            <label></label>
            <button type="button" class="save-btn" onclick="testConnection('Gemini', 'Gemini')" style="margin-right: 10px;">
                ğŸ”— æµ‹è¯•è¿æ¥
            </button>
        </div>
    </div>

    <!-- é€šä¹‰åƒé—®è®¾ç½® -->
    <div class="config-group" id="qwen-config">
        <h3>é€šä¹‰åƒé—®è®¾ç½®</h3>
        <div class="form-row">
            <label for="qwen-key">API Key:</label>
            <input type="password" id="qwen-key" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" value="sk-36e5536af09040f998b75ba48b17c421">
        </div>
        <div class="form-row">
            <label for="qwen-model">æ¨¡å‹åç§°:</label>
            <select id="qwen-model">
                <option value="qwen-flash">qwen-flash (æ¨è)</option>
                <option value="qwen-plus">qwen-plus</option>
                <option value="qwen-max">qwen-max</option>
            </select>
        </div>
        <div class="form-row">
            <label for="qwen-url">API URL:</label>
            <input type="text" id="qwen-url" placeholder="https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation" value="https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation">
        </div>
        <div class="form-row">
            <label></label>
            <button type="button" class="save-btn" onclick="testQwenConnection()" style="margin-right: 10px;">
                ğŸ”— æµ‹è¯•è¿æ¥
            </button>
        </div>
    </div>

    <!-- Ollama è®¾ç½® -->
    <div class="config-group" id="ollama-config">
        <h3>Ollama è®¾ç½®</h3>
        <div class="form-row">
            <label for="ollama-url">API URL:</label>
            <input type="text" id="ollama-url" placeholder="http://localhost:11434/api/generate">
        </div>
        <div class="form-row">
            <label for="ollama-model">æ¨¡å‹åç§°:</label>
            <input type="text" id="ollama-model" placeholder="deepseek-r1:1.5b">
        </div>
        <div class="form-row">
            <label></label>
            <button type="button" class="save-btn" onclick="testConnection('Ollama', 'Ollama')" style="margin-right: 10px;">
                ğŸ”— æµ‹è¯•è¿æ¥
            </button>
        </div>
    </div>

    <!-- æ€»ç»“è®¾ç½® -->
    <div class="config-group">
        <h3>æ€»ç»“è®¾ç½®</h3>
        <div class="form-row">
            <label for="summary-mode">æ€»ç»“æ¨¡å¼:</label>
            <select id="summary-mode">
                <option value="auto">è‡ªåŠ¨</option>
                <option value="manual">æ‰‹åŠ¨</option>
            </select>
        </div>
        <div class="form-row">
            <label for="auto-interval">è‡ªåŠ¨æ€»ç»“é—´éš”(ç§’):</label>
            <input type="number" id="auto-interval" min="10" max="3600" placeholder="300">
        </div>
        <div class="form-row">
            <label for="auto-max-chars">è‡ªåŠ¨æ€»ç»“æœ€å¤§å­—ç¬¦æ•°:</label>
            <input type="number" id="auto-max-chars" min="100" max="1000000" placeholder="8000">
        </div>
        <div class="form-row">
            <label for="manual-max-chars">æ‰‹åŠ¨æ€»ç»“æœ€å¤§å­—ç¬¦æ•°:</label>
            <input type="number" id="manual-max-chars" min="100" max="1000000" placeholder="20000">
        </div>
        <div class="form-row">
            <label for="whisper-language">Whisperè¯­è¨€:</label>
            <select id="whisper-language">
                <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                <option value="zh">ä¸­æ–‡</option>
                <option value="en">è‹±æ–‡</option>
            </select>
        </div>
    </div>

    <!-- ä¿å­˜æŒ‰é’® -->
    <div class="flex justify-end">
        <button class="save-btn" id="save-config-btn" onclick="saveConfiguration()">
            <span class="material-icons-outlined text-sm mr-1">save</span>
            ä¿å­˜é…ç½®
        </button>
    </div>

    <!-- çŠ¶æ€æ¶ˆæ¯ -->
    <div id="status-message" class="hidden"></div>
    
    <!-- æµ‹è¯•è¿æ¥ç»“æœå¼¹å‡ºé¢æ¿ -->
    <div id="test-connection-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="closeTestModal()">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">è¿æ¥æµ‹è¯•ç»“æœ</h3>
                    <button onclick="closeTestModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
                <div id="test-modal-content" class="mb-4">
                    <!-- æµ‹è¯•ç»“æœå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                <div class="flex justify-end">
                    <button onclick="closeTestModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        å…³é—­
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    let currentConfig = {};

    // è°ƒè¯•å‡½æ•°
    function debugLog(message) {
        console.log('[Settings Debug]', message);
    }

    function debugError(message) {
        console.error('[Settings Error]', message);
    }

    // é¡µé¢åˆå§‹åŒ–
    function initializeSettings() {
        debugLog('è®¾ç½®é¡µé¢åˆå§‹åŒ–å¼€å§‹');
        
        // åŠ è½½å½“å‰é…ç½®
        loadCurrentConfig();
        
        // æ·»åŠ æä¾›å•†åˆ‡æ¢äº‹ä»¶ç›‘å¬
        document.querySelectorAll('input[name="llm_provider"]').forEach(radio => {
            radio.addEventListener('change', updateProviderVisibility);
        });
    }

    // åŠ è½½å½“å‰é…ç½®
    function loadCurrentConfig() {
        debugLog('åŠ è½½å½“å‰é…ç½®');
        
        if (!window.bridge || !window.bridge.getConfig) {
            debugError('Bridgeå¯¹è±¡æˆ–getConfigæ–¹æ³•ä¸å¯ç”¨');
            return;
        }
        
        try {
            window.bridge.getConfig(function(configJson) {
                debugLog('æ”¶åˆ°é…ç½®æ•°æ®: ' + configJson.substring(0, 100) + '...');
                
                try {
                    currentConfig = JSON.parse(configJson);
                    populateConfigForm(currentConfig);
                } catch (parseError) {
                    debugError('è§£æé…ç½®JSONå¤±è´¥: ' + parseError.message);
                }
            });
        } catch (error) {
            debugError('è°ƒç”¨getConfigæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
        }
    }

    // å¡«å……é…ç½®è¡¨å•
    function populateConfigForm(config) {
        debugLog('å¡«å……é…ç½®è¡¨å•');
        
        // è®¾ç½®LLMæä¾›å•†
        const provider = config.llm_provider || 'DeepSeek';
        const providerRadio = document.querySelector(`input[name="llm_provider"][value="${provider}"]`);
        if (providerRadio) {
            providerRadio.checked = true;
        }
        
        // DeepSeeké…ç½®
        document.getElementById('deepseek-key').value = config.deepseek_api_key || '';
        document.getElementById('deepseek-model').value = config.deepseek_model || 'deepseek-chat';
        document.getElementById('deepseek-url').value = config.deepseek_api_url || 'https://api.deepseek.com/v1/chat/completions';
        
        // Geminié…ç½®
        document.getElementById('gemini-key').value = config.gemini_api_key || '';
        document.getElementById('gemini-model').value = config.gemini_model || 'gemini-1.5-flash-002';
        
        // é€šä¹‰åƒé—®é…ç½®
        document.getElementById('qwen-key').value = config.qwen_api_key || 'sk-36e5536af09040f998b75ba48b17c421';
        document.getElementById('qwen-model').value = config.qwen_model || 'qwen-flash';
        document.getElementById('qwen-url').value = config.qwen_api_url || 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation';
        
        // Ollamaé…ç½®
        document.getElementById('ollama-url').value = config.ollama_api_url || 'http://localhost:11434/api/generate';
        document.getElementById('ollama-model').value = config.ollama_model || 'deepseek-r1:1.5b';
        
        // æ€»ç»“è®¾ç½®
        document.getElementById('summary-mode').value = config.summary_mode || 'auto';
        document.getElementById('auto-interval').value = config.auto_summary_interval || 300;
        document.getElementById('auto-max-chars').value = config.auto_summary_max_chars || 8000;
        document.getElementById('manual-max-chars').value = config.manual_summary_max_chars || 20000;
        document.getElementById('whisper-language').value = config.whisper_language || 'auto';
        
        // æ›´æ–°æä¾›å•†å¯è§æ€§
        updateProviderVisibility();
        
        debugLog('é…ç½®è¡¨å•å¡«å……å®Œæˆ');
    }

    // æ›´æ–°æä¾›å•†é…ç½®åŒºåŸŸçš„å¯è§æ€§
    function updateProviderVisibility() {
        const selectedProvider = document.querySelector('input[name="llm_provider"]:checked')?.value;
        
        // éšè—æ‰€æœ‰é…ç½®åŒºåŸŸ
        document.getElementById('deepseek-config').style.display = 'none';
        document.getElementById('gemini-config').style.display = 'none';
        document.getElementById('qwen-config').style.display = 'none';
        document.getElementById('ollama-config').style.display = 'none';
        
        // æ˜¾ç¤ºé€‰ä¸­çš„é…ç½®åŒºåŸŸ
        if (selectedProvider === 'DeepSeek') {
            document.getElementById('deepseek-config').style.display = 'block';
        } else if (selectedProvider === 'Gemini') {
            document.getElementById('gemini-config').style.display = 'block';
        } else if (selectedProvider === 'Qwen') {
            document.getElementById('qwen-config').style.display = 'block';
        } else if (selectedProvider === 'Ollama') {
            document.getElementById('ollama-config').style.display = 'block';
        }
    }

    // ä¿å­˜é…ç½®
    function saveConfiguration() {
        debugLog('å¼€å§‹ä¿å­˜é…ç½®');
        
        const saveBtn = document.getElementById('save-config-btn');
        const originalText = saveBtn.innerHTML;
        
        // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
        saveBtn.innerHTML = '<span class="material-icons-outlined text-sm mr-1 animate-spin">refresh</span>ä¿å­˜ä¸­...';
        saveBtn.disabled = true;
        
        try {
            // æ”¶é›†è¡¨å•æ•°æ®
            const newConfig = {
                llm_provider: document.querySelector('input[name="llm_provider"]:checked')?.value || 'DeepSeek',
                deepseek_api_key: document.getElementById('deepseek-key').value.trim(),
                deepseek_model: document.getElementById('deepseek-model').value.trim(),
                deepseek_api_url: document.getElementById('deepseek-url').value.trim(),
                gemini_api_key: document.getElementById('gemini-key').value.trim(),
                gemini_model: document.getElementById('gemini-model').value.trim(),
                qwen_api_key: document.getElementById('qwen-key').value.trim(),
                qwen_model: document.getElementById('qwen-model').value.trim(),
                qwen_api_url: document.getElementById('qwen-url').value.trim(),
                ollama_api_url: document.getElementById('ollama-url').value.trim(),
                ollama_model: document.getElementById('ollama-model').value.trim(),
                summary_mode: document.getElementById('summary-mode').value,
                auto_summary_interval: parseInt(document.getElementById('auto-interval').value) || 300,
                auto_summary_max_chars: parseInt(document.getElementById('auto-max-chars').value) || 8000,
                manual_summary_max_chars: parseInt(document.getElementById('manual-max-chars').value) || 20000,
                whisper_language: document.getElementById('whisper-language').value
            };
            
            debugLog('é…ç½®æ•°æ®æ”¶é›†å®Œæˆ: ' + JSON.stringify(newConfig, null, 2));
            
            if (!window.bridge || !window.bridge.saveConfig) {
                throw new Error('Bridgeå¯¹è±¡æˆ–saveConfigæ–¹æ³•ä¸å¯ç”¨');
            }
            
            // è°ƒç”¨åç«¯ä¿å­˜é…ç½®
            window.bridge.saveConfig(JSON.stringify(newConfig), function(success) {
                debugLog('é…ç½®ä¿å­˜ç»“æœ: ' + success);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                
                if (success) {
                    showStatusMessage('é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                    currentConfig = newConfig;
                } else {
                    showStatusMessage('é…ç½®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            });
            
        } catch (error) {
            debugError('ä¿å­˜é…ç½®æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            
            showStatusMessage('ä¿å­˜è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
        }
    }

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatusMessage(message, type) {
        const statusDiv = document.getElementById('status-message');
        statusDiv.className = `status-message status-${type}`;
        statusDiv.textContent = message;
        statusDiv.classList.remove('hidden');
        
        // 3ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
            statusDiv.classList.add('hidden');
        }, 3000);
    }

    // å¯¼èˆªå‡½æ•°ï¼ˆå…¼å®¹SPAï¼‰
    function loadContent(contentId) {
        if (window.bridge && window.bridge.loadContent) {
            window.bridge.loadContent(contentId);
        }
    }

    // æµ‹è¯•é€šä¹‰åƒé—®è¿æ¥
    function testQwenConnection() {
        testConnection('Qwen', 'é€šä¹‰åƒé—®');
    }
    
    // é€šç”¨æµ‹è¯•è¿æ¥å‡½æ•°
    function testConnection(provider, displayName) {
        debugLog('å¼€å§‹æµ‹è¯•' + displayName + 'è¿æ¥');
        
        if (!window.bridge || !window.bridge.testLLMConnection) {
            showTestModal('âŒ è¿æ¥æµ‹è¯•å¤±è´¥', 'Bridgeå¯¹è±¡æˆ–testLLMConnectionæ–¹æ³•ä¸å¯ç”¨', 'error');
            return;
        }
        
        // æ˜¾ç¤ºæµ‹è¯•ä¸­çŠ¶æ€
        showTestModal('ğŸ”„ æ­£åœ¨æµ‹è¯•è¿æ¥', 'æ­£åœ¨æµ‹è¯• ' + displayName + ' è¿æ¥ï¼Œè¯·ç¨å€™...', 'loading');
        
        try {
            window.bridge.testLLMConnection(provider).then(function(result) {
                debugLog(displayName + 'è¿æ¥æµ‹è¯•ç»“æœ: ' + result);
                
                if (result && result.includes('âœ…')) {
                    showTestModal('âœ… è¿æ¥æµ‹è¯•æˆåŠŸ', result, 'success');
                } else {
                    showTestModal('âŒ è¿æ¥æµ‹è¯•å¤±è´¥', result || 'æ— å“åº”', 'error');
                }
            }).catch(function(error) {
                debugError(displayName + 'è¿æ¥æµ‹è¯•å¼‚å¸¸: ' + error);
                showTestModal('âŒ è¿æ¥æµ‹è¯•å¼‚å¸¸', error.toString(), 'error');
            });
        } catch (error) {
            debugError('è°ƒç”¨testLLMConnectionæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            showTestModal('âŒ æµ‹è¯•å¼‚å¸¸', 'æµ‹è¯•è¿æ¥æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
        }
    }
    
    // æ˜¾ç¤ºæµ‹è¯•ç»“æœå¼¹å‡ºé¢æ¿
    function showTestModal(title, content, type) {
        const modal = document.getElementById('test-connection-modal');
        const modalContent = document.getElementById('test-modal-content');
        
        let bgColor = 'bg-blue-50';
        let textColor = 'text-blue-800';
        let borderColor = 'border-blue-200';
        
        if (type === 'success') {
            bgColor = 'bg-green-50';
            textColor = 'text-green-800';
            borderColor = 'border-green-200';
        } else if (type === 'error') {
            bgColor = 'bg-red-50';
            textColor = 'text-red-800';
            borderColor = 'border-red-200';
        }
        
        modalContent.innerHTML = `
            <div class="p-4 rounded-lg ${bgColor} ${borderColor} border">
                <h4 class="font-semibold ${textColor} mb-2">${title}</h4>
                <pre class="text-sm ${textColor} whitespace-pre-wrap">${content}</pre>
            </div>
        `;
        
        modal.classList.remove('hidden');
    }
    
    // å…³é—­æµ‹è¯•ç»“æœå¼¹å‡ºé¢æ¿
    function closeTestModal() {
        const modal = document.getElementById('test-connection-modal');
        modal.classList.add('hidden');
    }

    // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.saveConfiguration = saveConfiguration;
    window.testQwenConnection = testQwenConnection;
    window.testConnection = testConnection;
    window.closeTestModal = closeTestModal;
    window.loadContent = loadContent;

    // é¡µé¢åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeSettings);
    } else {
        initializeSettings();
    }

})();
</script>
