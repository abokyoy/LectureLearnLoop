<!-- 从资料学习页面 - 完整的树形文件管理 -->
<style>
    /* 侧边栏收缩样式 */
    #sidebar.collapsed .sidebar-text,
    #sidebar.collapsed #user-profile,
    #sidebar.collapsed .logo-text {
        display: none;
    }
    #sidebar.collapsed .nav-item-icon {
        margin-right: 0;
    }
    #sidebar.collapsed .nav-link {
        justify-content: center;
    }
    
    /* 文件树样式 */
    .file-item-content {
        transition: all 0.2s ease;
    }
    .file-item-content:hover {
        background-color: #f3f4f6;
    }
    .file-item-content.selected {
        background-color: #32C77F !important;
        color: white !important;
    }
    .file-item-content.drag-over {
        border: 2px dashed #10b981;
        background-color: rgba(16, 185, 129, 0.1);
    }
    .folder-toggle {
        transition: transform 0.2s ease;
    }
    
    /* 右键菜单样式 */
    .context-menu {
        position: fixed;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        min-width: 150px;
    }
    .context-menu-item {
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        font-size: 14px;
    }
    .context-menu-item:hover {
        background-color: #f3f4f6;
    }
    .context-menu-item .material-icons-outlined {
        margin-right: 8px;
        font-size: 16px;
    }
</style>

<div class="flex h-screen bg-white">
    <!-- 主内容区域 -->
    <div class="flex-1 flex bg-bg-light-blue-gray" id="main-content">
        
        <!-- 左侧文件结构面板 -->
        <div class="w-1/4 bg-white border-r border-gray-200 p-4 flex flex-col transition-all duration-300" id="file-structure">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-text-dark-brown">文件结构</h2>
                <div class="space-x-2">
                    <button class="text-text-gray hover:text-primary" onclick="createNewFolder()" title="新建文件夹">
                        <span class="material-icons-outlined">create_new_folder</span>
                    </button>
                    <button class="text-text-gray hover:text-primary" onclick="createNewNote()" title="新建笔记">
                        <span class="material-icons-outlined">note_add</span>
                    </button>
                    <button class="text-red-600 hover:text-red-800" onclick="validateBackendFunctions()" title="验证后端功能">
                        <span class="material-icons-outlined">bug_report</span>
                    </button>
                </div>
            </div>
            
            <!-- 文件树容器 -->
            <div class="flex-1 overflow-y-auto pr-2">
                <div id="loading-indicator" class="flex items-center justify-center py-8">
                    <div class="animate-spin">
                        <span class="material-icons-outlined text-primary">refresh</span>
                    </div>
                    <span class="ml-2 text-text-medium-brown">加载文件结构中...</span>
                </div>
                <div id="file-tree-container"></div>
            </div>
        </div>

        <!-- 中间文档预览/编辑区域 -->
        <div class="flex-1 bg-white border-r border-gray-200 flex flex-col">
            <!-- 顶部工具栏 -->
            <div class="border-b border-gray-200 p-4 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <h2 class="text-lg font-semibold text-text-dark-brown" id="preview-title">文档预览区</h2>
                    <span id="unsaved-indicator" class="text-orange-500 text-sm hidden">● 未保存</span>
                </div>
                <div class="flex space-x-2">
                    <button id="save-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hidden" onclick="saveCurrentFile()" title="保存文件">
                        <span class="material-icons-outlined text-sm mr-1">save</span>
                        保存
                    </button>
                    <button id="preview-btn" class="px-4 py-2 bg-primary text-white rounded-lg text-sm" onclick="switchToPreview()">预览</button>
                    <button id="edit-btn" class="px-4 py-2 bg-white border border-gray-300 text-text-gray rounded-lg text-sm" onclick="switchToEdit()">编辑</button>
                </div>
            </div>
            
            <!-- 内容区域 -->
            <div class="flex-1 p-4 overflow-y-auto">
                <div id="preview-content" class="prose max-w-none">
                    <div class="text-center py-16 text-text-medium-brown">
                        <span class="material-icons-outlined text-6xl mb-4">description</span>
                        <p>请选择一个Markdown文件进行预览</p>
                    </div>
                </div>
                <textarea id="edit-content" class="w-full h-full border border-gray-300 rounded-lg p-4 font-mono text-sm resize-none hidden" placeholder="在此编辑Markdown内容..."></textarea>
            </div>
        </div>

        <!-- 右侧知识点面板 -->
        <div class="w-1/4 bg-white p-4 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-text-dark-brown">知识点</h2>
                <div class="flex gap-2">
                    <button class="text-text-gray hover:text-primary" onclick="toggleDebugPanel()" title="切换调试面板" id="debug-toggle-btn">
                        <span class="material-icons-outlined">terminal</span>
                    </button>
                    <button class="text-text-gray hover:text-primary" onclick="testBridgeConnection()" title="测试Bridge连接" id="test-btn">
                        <span class="material-icons-outlined">bug_report</span>
                    </button>
                    <button class="text-text-gray hover:text-primary" onclick="extractKnowledgePoints()" title="提取全文知识点" id="extract-btn">
                        <span class="material-icons-outlined">lightbulb</span>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto">
                <div id="knowledge-points-container">
                    <div class="text-center py-16 text-text-medium-brown" id="knowledge-placeholder">
                        <span class="material-icons-outlined text-6xl mb-4">psychology</span>
                        <p>选择文档后可提取知识点</p>
                    </div>
                    <div id="knowledge-loading" class="text-center py-16 text-primary hidden">
                        <div class="animate-spin mb-4">
                            <span class="material-icons-outlined text-6xl">refresh</span>
                        </div>
                        <p>正在提取知识点...</p>
                    </div>
                    <div id="knowledge-content" class="hidden">
                        <!-- 知识点内容将在这里显示 -->
                    </div>
                    
                    <!-- 调试面板 -->
                    <div id="debug-panel" class="mt-4 p-3 bg-gray-100 border border-gray-300 rounded-lg hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-sm font-semibold text-gray-700">调试日志</h4>
                            <button onclick="clearDebugLog()" class="text-xs text-red-600 hover:text-red-800">清空</button>
                        </div>
                        <div id="debug-log" class="bg-white p-2 rounded border text-xs font-mono max-h-40 overflow-y-auto">
                            <!-- 调试日志将在这里显示 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 右键菜单 -->
<div id="context-menu" class="context-menu hidden">
    <div class="context-menu-item" onclick="contextMenuAction('rename')">
        <span class="material-icons-outlined">edit</span>
        重命名
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('delete')">
        <span class="material-icons-outlined">delete</span>
        删除
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('newNote')">
        <span class="material-icons-outlined">note_add</span>
        新建笔记
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('newFolder')">
        <span class="material-icons-outlined">create_new_folder</span>
        新建文件夹
    </div>
</div>

<script>
(function() {
    'use strict';
    
    let currentFilePath = '';
    let currentFileName = '';
    let isEditMode = false;
    let contextMenuTarget = null;
    let originalContent = '';  // 原始文件内容
    let hasUnsavedChanges = false;  // 是否有未保存的更改

    // 调试变量
    let debugEnabled = false;
    let debugLogCount = 0;

    // 调试函数
    function debugLog(message) {
        console.log('[Learn Materials Debug]', message);
        if (debugEnabled) {
            addToDebugPanel('INFO', message);
        }
    }

    function debugError(message) {
        console.error('[Learn Materials Error]', message);
        if (debugEnabled) {
            addToDebugPanel('ERROR', message);
        }
    }

    function debugWarn(message) {
        console.warn('[Learn Materials Warn]', message);
        if (debugEnabled) {
            addToDebugPanel('WARN', message);
        }
    }

    // 添加到调试面板
    function addToDebugPanel(level, message) {
        const debugLog = document.getElementById('debug-log');
        if (!debugLog) return;
        
        debugLogCount++;
        const timestamp = new Date().toLocaleTimeString();
        const levelColor = {
            'INFO': 'text-blue-600',
            'ERROR': 'text-red-600',
            'WARN': 'text-yellow-600',
            'SUCCESS': 'text-green-600'
        }[level] || 'text-gray-600';
        
        const logEntry = document.createElement('div');
        logEntry.className = 'mb-1';
        logEntry.innerHTML = `
            <span class="text-gray-500">[${timestamp}]</span>
            <span class="${levelColor} font-semibold">[${level}]</span>
            <span>${message}</span>
        `;
        
        debugLog.appendChild(logEntry);
        debugLog.scrollTop = debugLog.scrollHeight;
        
        // 限制日志条数，避免占用太多内存
        if (debugLogCount > 100) {
            const firstChild = debugLog.firstChild;
            if (firstChild) {
                debugLog.removeChild(firstChild);
                debugLogCount--;
            }
        }
    }

    // 切换调试面板
    function toggleDebugPanel() {
        const debugPanel = document.getElementById('debug-panel');
        const debugToggleBtn = document.getElementById('debug-toggle-btn');
        
        if (debugPanel.classList.contains('hidden')) {
            debugPanel.classList.remove('hidden');
            debugEnabled = true;
            debugToggleBtn.classList.add('text-primary');
            debugToggleBtn.classList.remove('text-text-gray');
            addToDebugPanel('SUCCESS', '调试面板已开启');
        } else {
            debugPanel.classList.add('hidden');
            debugEnabled = false;
            debugToggleBtn.classList.remove('text-primary');
            debugToggleBtn.classList.add('text-text-gray');
        }
    }

    // 清空调试日志
    function clearDebugLog() {
        const debugLog = document.getElementById('debug-log');
        if (debugLog) {
            debugLog.innerHTML = '';
            debugLogCount = 0;
            addToDebugPanel('INFO', '调试日志已清空');
        }
    }

    // 页面初始化
    function initializePage() {
        debugLog('页面初始化开始');
        
        // 检查Bridge连接
        if (window.bridge) {
            debugLog('Bridge对象已可用');
            loadFileStructure();
        } else {
            debugLog('Bridge对象不可用，等待连接...');
            // 等待Bridge连接
            setTimeout(() => {
                if (window.bridge) {
                    debugLog('Bridge连接成功，加载文件结构');
                    loadFileStructure();
                } else {
                    debugError('Bridge连接超时');
                }
            }, 1000);
        }
        
        // 添加全局事件监听器
        document.addEventListener('click', hideContextMenu);
        document.addEventListener('contextmenu', function(e) {
            if (!e.target.closest('.file-item-content')) {
                e.preventDefault();
                hideContextMenu();
            }
        });
        
        // 添加键盘快捷键支持
        document.addEventListener('keydown', function(e) {
            // Ctrl+S 保存文件
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (isEditMode && currentFilePath) {
                    saveCurrentFile();
                }
            }
        });
        
        // 页面离开前检查未保存的更改
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '您有未保存的更改，确定要离开吗？';
                return e.returnValue;
            }
        });
    }

    // 加载文件结构
    function loadFileStructure() {
        debugLog('开始加载文件结构');
        
        if (!window.bridge || typeof window.bridge.getFileStructure !== 'function') {
            debugError('Bridge对象或getFileStructure方法不可用');
            return;
        }
        
        try {
            window.bridge.getFileStructure(function(jsonString) {
                debugLog('收到文件结构数据: ' + jsonString.substring(0, 100) + '...');
                
                try {
                    const structure = JSON.parse(jsonString);
                    renderFileTree(structure);
                } catch (parseError) {
                    debugError('解析文件结构JSON失败: ' + parseError.message);
                }
            });
        } catch (error) {
            debugError('调用getFileStructure时发生错误: ' + error.message);
        }
    }

    // 文件树渲染函数
    function renderFileTree(data) {
        debugLog('渲染文件树，数据项数: ' + (data ? data.length : 0));
        
        const container = document.getElementById('file-tree-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }
        
        if (!container) {
            debugError('文件树容器未找到');
            return;
        }
        
        if (!data || data.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-text-medium-brown">暂无文件</div>';
            return;
        }
        
        let html = '<ul class="space-y-1">';
        data.forEach(item => {
            html += renderFileItem(item, 0);
        });
        html += '</ul>';
        
        container.innerHTML = html;
        
        // 添加事件监听器
        addFileTreeEventListeners();
        debugLog('文件树渲染完成');
    }

    function renderFileItem(item, level) {
        const indent = level * 20;
        const isFolder = item.type === 'folder';
        const icon = isFolder ? 'folder' : 'description';
        const itemClass = isFolder ? 'folder-item' : 'file-item';
        
        let html = `
            <li class="${itemClass}" data-path="${item.path}" data-type="${item.type}" data-name="${item.name}">
                <div class="flex items-center py-1 px-2 hover:bg-gray-100 rounded cursor-pointer file-item-content" 
                     style="margin-left: ${indent}px"
                     draggable="true">
                    ${isFolder ? '<span class="material-icons-outlined text-sm mr-1 folder-toggle">chevron_right</span>' : '<span class="w-5"></span>'}
                    <span class="material-icons-outlined text-sm mr-2 text-text-gray">${icon}</span>
                    <span class="text-sm text-text-dark-brown flex-1 file-name">${item.name}</span>
                </div>
        `;
        
        if (isFolder && item.children && item.children.length > 0) {
            html += '<ul class="folder-children hidden ml-4">';
            item.children.forEach(child => {
                html += renderFileItem(child, level + 1);
            });
            html += '</ul>';
        }
        
        html += '</li>';
        return html;
    }

    // 添加文件树事件监听器
    function addFileTreeEventListeners() {
        debugLog('添加文件树事件监听器');
        
        const fileItems = document.querySelectorAll('.file-item-content');
        
        fileItems.forEach(content => {
            // 点击事件
            content.addEventListener('click', function(e) {
                const item = this.closest('li');
                const path = item.getAttribute('data-path');
                const type = item.getAttribute('data-type');
                const name = item.getAttribute('data-name');
                
                handleFileClick(path, type, name, this);
            });
            
            // 右键菜单
            content.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                const item = this.closest('li');
                const path = item.getAttribute('data-path');
                const type = item.getAttribute('data-type');
                const name = item.getAttribute('data-name');
                
                showContextMenu(e, path, type, name);
            });
            
            // 拖拽事件
            content.addEventListener('dragstart', handleDragStart);
            content.addEventListener('dragover', handleDragOver);
            content.addEventListener('drop', handleDrop);
            content.addEventListener('dragenter', handleDragEnter);
            content.addEventListener('dragleave', handleDragLeave);
        });
        
        // 文件夹切换事件
        const folderToggles = document.querySelectorAll('.folder-toggle');
        folderToggles.forEach(toggle => {
            toggle.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleFolder(this);
            });
        });
    }

    // 处理文件点击
    function handleFileClick(path, type, name, element) {
        debugLog(`文件点击: ${name} (${type}) - ${path}`);
        
        // 移除之前的选中状态
        document.querySelectorAll('.file-item-content.selected').forEach(el => {
            el.classList.remove('selected');
        });
        
        // 添加选中状态
        element.classList.add('selected');
        
        if (type === 'file' && path.endsWith('.md')) {
            // 加载Markdown文件
            loadFileContent(path, name);
        }
    }

    // 加载文件内容
    function loadFileContent(filePath, fileName) {
        debugLog(`加载文件内容: ${fileName}`);
        
        currentFilePath = filePath;
        currentFileName = fileName;
        
        if (!window.bridge || !window.bridge.loadMarkdownFile) {
            debugError('Bridge对象或loadMarkdownFile方法不可用');
            return;
        }
        
        // 更新文档预览区标题
        const previewTitle = document.getElementById('preview-title');
        if (previewTitle) {
            previewTitle.textContent = fileName;
        }
        
        // 显示加载状态
        const previewContent = document.getElementById('preview-content');
        if (previewContent) {
            previewContent.innerHTML = '<div class="flex items-center justify-center py-8"><div class="animate-spin mr-2"><span class="material-icons-outlined">refresh</span></div><span>加载中...</span></div>';
        }
        
        // 调用后端加载文件
        try {
            window.bridge.loadMarkdownFile(filePath, function(htmlContent) {
                debugLog(`文件内容加载完成，长度: ${htmlContent.length}`);
                
                if (previewContent) {
                    if (htmlContent) {
                        previewContent.innerHTML = htmlContent;
                    } else {
                        previewContent.innerHTML = '<div class="text-center py-8 text-gray-500">文件内容为空或加载失败</div>';
                    }
                }
                
                // 确保处于预览模式（不重复调用switchToPreview）
                if (!isEditMode) {
                    // 只更新UI状态，不重新加载内容
                    document.getElementById('preview-content').classList.remove('hidden');
                    document.getElementById('edit-content').classList.add('hidden');
                    document.getElementById('save-btn').classList.add('hidden');
                    
                    // 更新按钮状态
                    document.getElementById('preview-btn').classList.add('bg-primary', 'text-white');
                    document.getElementById('preview-btn').classList.remove('bg-white', 'border-gray-300', 'text-text-gray');
                    document.getElementById('edit-btn').classList.add('bg-white', 'border-gray-300', 'text-text-gray');
                    document.getElementById('edit-btn').classList.remove('bg-primary', 'text-white');
                }
            });
        } catch (error) {
            debugError(`加载文件内容时发生错误: ${error.message}`);
            if (previewContent) {
                previewContent.innerHTML = '<div class="text-center py-8 text-red-500">加载文件失败</div>';
            }
        }
    }

    // 重新加载预览内容（不触发模式切换）
    function reloadPreviewContent(filePath, fileName) {
        debugLog(`重新加载预览内容: ${fileName}`);
        
        if (!window.bridge || !window.bridge.loadMarkdownFile) {
            debugError('Bridge对象或loadMarkdownFile方法不可用');
            return;
        }
        
        // 显示加载状态
        const previewContent = document.getElementById('preview-content');
        if (previewContent) {
            previewContent.innerHTML = '<div class="flex items-center justify-center py-8"><div class="animate-spin mr-2"><span class="material-icons-outlined">refresh</span></div><span>重新加载中...</span></div>';
        }
        
        // 调用后端加载文件
        try {
            window.bridge.loadMarkdownFile(filePath, function(htmlContent) {
                debugLog(`预览内容重新加载完成，长度: ${htmlContent.length}`);
                
                if (previewContent) {
                    if (htmlContent) {
                        previewContent.innerHTML = htmlContent;
                    } else {
                        previewContent.innerHTML = '<div class="text-center py-8 text-gray-500">文件内容为空或加载失败</div>';
                    }
                }
            });
        } catch (error) {
            debugError(`重新加载预览内容时发生错误: ${error.message}`);
            if (previewContent) {
                previewContent.innerHTML = '<div class="text-center py-8 text-red-500">重新加载失败</div>';
            }
        }
    }

    // 切换到预览模式
    function switchToPreview() {
        debugLog('切换到预览模式');
        
        // 如果当前是编辑模式且有未保存的更改，先保存
        if (isEditMode && hasUnsavedChanges) {
            debugLog('检测到未保存的更改，自动保存...');
            saveCurrentFile(function() {
                // 保存成功后切换到预览模式
                performPreviewSwitch();
            });
        } else {
            performPreviewSwitch();
        }
    }
    
    // 执行预览模式切换
    function performPreviewSwitch() {
        debugLog('执行预览模式切换');
        isEditMode = false;
        
        // 如果有当前文件，重新加载预览内容（但不调用switchToPreview避免循环）
        if (currentFilePath) {
            reloadPreviewContent(currentFilePath, currentFileName);
        }
        
        document.getElementById('preview-content').classList.remove('hidden');
        document.getElementById('edit-content').classList.add('hidden');
        document.getElementById('save-btn').classList.add('hidden');
        
        // 更新按钮状态
        document.getElementById('preview-btn').classList.add('bg-primary', 'text-white');
        document.getElementById('preview-btn').classList.remove('bg-white', 'border-gray-300', 'text-text-gray');
        document.getElementById('edit-btn').classList.add('bg-white', 'border-gray-300', 'text-text-gray');
        document.getElementById('edit-btn').classList.remove('bg-primary', 'text-white');
        
        // 隐藏未保存指示器
        hideUnsavedIndicator();
    }

    // 切换到编辑模式
    function switchToEdit() {
        debugLog('切换到编辑模式');
        
        if (!currentFilePath) {
            debugLog('没有选中的文件');
            return;
        }
        
        isEditMode = true;
        
        // 加载原始内容
        if (window.bridge && window.bridge.loadMarkdownRaw) {
            window.bridge.loadMarkdownRaw(currentFilePath, function(rawContent) {
                debugLog(`原始内容加载完成，长度: ${rawContent.length}`);
                
                const editContent = document.getElementById('edit-content');
                if (editContent) {
                    editContent.value = rawContent;
                    originalContent = rawContent;  // 保存原始内容
                    hasUnsavedChanges = false;     // 重置未保存状态
                    
                    // 添加内容变更监听
                    editContent.addEventListener('input', handleContentChange);
                }
                
                document.getElementById('preview-content').classList.add('hidden');
                document.getElementById('edit-content').classList.remove('hidden');
                document.getElementById('save-btn').classList.remove('hidden');
                
                // 更新按钮状态
                document.getElementById('edit-btn').classList.add('bg-primary', 'text-white');
                document.getElementById('edit-btn').classList.remove('bg-white', 'border-gray-300', 'text-text-gray');
                document.getElementById('preview-btn').classList.add('bg-white', 'border-gray-300', 'text-text-gray');
                document.getElementById('preview-btn').classList.remove('bg-primary', 'text-white');
                
                // 聚焦到编辑器
                editContent.focus();
            });
        }
    }

    // 处理内容变更
    function handleContentChange() {
        const editContent = document.getElementById('edit-content');
        if (editContent) {
            const currentContent = editContent.value;
            hasUnsavedChanges = (currentContent !== originalContent);
            
            if (hasUnsavedChanges) {
                showUnsavedIndicator();
                debugLog('检测到内容变更，显示未保存指示器');
            } else {
                hideUnsavedIndicator();
                debugLog('内容与原始内容相同，隐藏未保存指示器');
            }
        }
    }

    // 显示未保存指示器
    function showUnsavedIndicator() {
        const indicator = document.getElementById('unsaved-indicator');
        if (indicator) {
            indicator.classList.remove('hidden');
        }
    }

    // 隐藏未保存指示器
    function hideUnsavedIndicator() {
        const indicator = document.getElementById('unsaved-indicator');
        if (indicator) {
            indicator.classList.add('hidden');
        }
    }

    // 保存当前文件
    function saveCurrentFile(callback) {
        debugLog('开始保存当前文件');
        
        if (!currentFilePath) {
            debugError('没有当前文件路径');
            return;
        }
        
        const editContent = document.getElementById('edit-content');
        if (!editContent) {
            debugError('编辑器元素未找到');
            return;
        }
        
        const content = editContent.value;
        debugLog(`保存文件: ${currentFileName}, 内容长度: ${content.length}`);
        
        if (!window.bridge || !window.bridge.saveMarkdownFile) {
            debugError('Bridge对象或saveMarkdownFile方法不可用');
            return;
        }
        
        // 显示保存状态
        const saveBtn = document.getElementById('save-btn');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<span class="material-icons-outlined text-sm mr-1 animate-spin">refresh</span>保存中...';
        saveBtn.disabled = true;
        
        try {
            window.bridge.saveMarkdownFile(currentFilePath, content, function(success) {
                debugLog(`文件保存结果: ${success}`);
                
                // 恢复按钮状态
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                
                if (success) {
                    originalContent = content;  // 更新原始内容
                    hasUnsavedChanges = false;  // 重置未保存状态
                    hideUnsavedIndicator();
                    
                    // 显示保存成功提示
                    showSaveSuccessMessage();
                    
                    debugLog('✅ 文件保存成功');
                    
                    // 如果有回调函数，执行它
                    if (callback && typeof callback === 'function') {
                        callback();
                    }
                } else {
                    debugError('❌ 文件保存失败');
                    alert('保存失败，请重试');
                }
            });
        } catch (error) {
            debugError(`保存文件时发生错误: ${error.message}`);
            
            // 恢复按钮状态
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            
            alert('保存过程中发生错误: ' + error.message);
        }
    }

    // 显示保存成功消息
    function showSaveSuccessMessage() {
        const message = document.createElement('div');
        message.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        message.innerHTML = `
            <div class="flex items-center">
                <span class="material-icons-outlined text-sm mr-2">check_circle</span>
                <span>文件已保存</span>
            </div>
        `;
        document.body.appendChild(message);
        
        // 3秒后自动移除
        setTimeout(() => {
            if (message.parentElement) {
                message.remove();
            }
        }, 3000);
    }

    // 切换文件夹展开/折叠
    function toggleFolder(toggleElement) {
        debugLog('切换文件夹状态');
        
        const folderItem = toggleElement.closest('.folder-item');
        const children = folderItem.querySelector('.folder-children');
        
        if (children) {
            const isHidden = children.classList.contains('hidden');
            
            if (isHidden) {
                children.classList.remove('hidden');
                toggleElement.textContent = 'expand_more';
            } else {
                children.classList.add('hidden');
                toggleElement.textContent = 'chevron_right';
            }
        }
    }

    // 拖拽处理函数
    let draggedElement = null;

    function handleDragStart(e) {
        draggedElement = this.closest('li');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', draggedElement.outerHTML);
        
        const path = draggedElement.getAttribute('data-path');
        const name = draggedElement.getAttribute('data-name');
        debugLog(`开始拖拽: ${name} - ${path}`);
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(e) {
        const targetItem = this.closest('li');
        const targetType = targetItem.getAttribute('data-type');
        
        if (targetType === 'folder' && targetItem !== draggedElement) {
            this.classList.add('drag-over');
        }
    }

    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        const targetItem = this.closest('li');
        const targetType = targetItem.getAttribute('data-type');
        const targetPath = targetItem.getAttribute('data-path');
        
        if (targetType === 'folder' && targetItem !== draggedElement && draggedElement) {
            const sourcePath = draggedElement.getAttribute('data-path');
            const sourceName = draggedElement.getAttribute('data-name');
            
            debugLog(`拖拽移动: ${sourceName} -> ${targetPath}`);
            
            // 调用后端移动文件
            if (window.bridge && window.bridge.moveFileOrFolder) {
                window.bridge.moveFileOrFolder(sourcePath, targetPath, function(success) {
                    if (success) {
                        debugLog('文件移动成功');
                        loadFileStructure(); // 重新加载文件结构
                    } else {
                        debugError('文件移动失败');
                    }
                });
            }
        }
        
        draggedElement = null;
    }

    // 右键菜单功能
    function showContextMenu(e, path, type, name) {
        e.preventDefault();
        
        const contextMenu = document.getElementById('context-menu');
        contextMenuTarget = { path, type, name };
        
        contextMenu.style.left = e.pageX + 'px';
        contextMenu.style.top = e.pageY + 'px';
        contextMenu.classList.remove('hidden');
        
        debugLog(`显示右键菜单: ${name} (${type})`);
    }

    function hideContextMenu() {
        const contextMenu = document.getElementById('context-menu');
        contextMenu.classList.add('hidden');
        contextMenuTarget = null;
    }

    function contextMenuAction(action) {
        if (!contextMenuTarget) return;
        
        const { path, type, name } = contextMenuTarget;
        debugLog(`右键菜单操作: ${action} - ${name}`);
        
        switch (action) {
            case 'rename':
                renameItem(path, name);
                break;
            case 'delete':
                deleteItem(path, name);
                break;
            case 'newNote':
                createNewNote(path);
                break;
            case 'newFolder':
                createNewFolder(path);
                break;
        }
        
        hideContextMenu();
    }

    // 重命名功能
    function renameItem(path, currentName) {
        const newName = prompt('请输入新名称:', currentName);
        if (newName && newName !== currentName) {
            debugLog(`重命名: ${currentName} -> ${newName}`);
            
            if (window.bridge && window.bridge.renameFileOrFolder) {
                window.bridge.renameFileOrFolder(path, newName, function(success) {
                    if (success) {
                        debugLog('重命名成功');
                        loadFileStructure();
                    } else {
                        debugError('重命名失败');
                        alert('重命名失败，请检查名称是否已存在');
                    }
                });
            }
        }
    }

    // 删除功能
    function deleteItem(path, name) {
        if (confirm(`确定要删除 "${name}" 吗？此操作不可恢复。`)) {
            debugLog(`删除: ${name}`);
            
            if (window.bridge && window.bridge.deleteFileOrFolder) {
                window.bridge.deleteFileOrFolder(path, function(success) {
                    if (success) {
                        debugLog('删除成功');
                        loadFileStructure();
                    } else {
                        debugError('删除失败');
                        alert('删除失败');
                    }
                });
            }
        }
    }

    // 文件操作函数
    function createNewNote(parentPath = 'vault') {
        debugLog('创建新笔记');
        if (window.bridge && window.bridge.createNewNote) {
            window.bridge.createNewNote(parentPath, function(result) {
                debugLog('新笔记创建结果: ' + result);
                if (result) {
                    loadFileStructure();
                }
            });
        }
    }

    function createNewFolder(parentPath = 'vault') {
        debugLog('创建新文件夹');
        if (window.bridge && window.bridge.createNewFolder) {
            window.bridge.createNewFolder(parentPath, function(result) {
                debugLog('新文件夹创建结果: ' + result);
                if (result) {
                    loadFileStructure();
                }
            });
        }
    }

    // 验证后端功能
    function validateBackendFunctions() {
        debugLog('🔍 开始验证后端功能');
        
        if (!window.bridge || typeof window.bridge.validateAllFileOperations !== 'function') {
            debugError('❌ Bridge对象或validateAllFileOperations方法不可用');
            alert('❌ 无法连接到后端验证服务');
            return;
        }
        
        // 显示验证开始提示
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'validation-loading';
        loadingDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        loadingDiv.innerHTML = `
            <div class="flex items-center">
                <div class="animate-spin mr-2">
                    <span class="material-icons-outlined">refresh</span>
                </div>
                <span>正在验证后端功能...</span>
            </div>
        `;
        document.body.appendChild(loadingDiv);
        
        debugLog('调用后端验证功能...');
        
        try {
            window.bridge.validateAllFileOperations(function(result) {
                debugLog('🎯 后端验证完成');
                debugLog('验证结果: ' + result);
                
                // 移除加载提示
                const loadingElement = document.getElementById('validation-loading');
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                // 显示验证结果
                const resultDiv = document.createElement('div');
                resultDiv.className = 'fixed top-4 right-4 bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-w-md p-4';
                resultDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-800">后端功能验证结果</h3>
                        <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                            <span class="material-icons-outlined text-sm">close</span>
                        </button>
                    </div>
                    <div class="text-sm text-gray-600 whitespace-pre-line max-h-64 overflow-y-auto">
                        ${result}
                    </div>
                `;
                document.body.appendChild(resultDiv);
                
                // 10秒后自动关闭
                setTimeout(() => {
                    if (resultDiv.parentElement) {
                        resultDiv.remove();
                    }
                }, 10000);
                
                // 重新加载文件结构以反映任何更改
                loadFileStructure();
            });
        } catch (error) {
            debugError('调用后端验证时发生错误: ' + error.message);
            
            // 移除加载提示
            const loadingElement = document.getElementById('validation-loading');
            if (loadingElement) {
                loadingElement.remove();
            }
            
            alert('❌ 验证过程中发生错误: ' + error.message);
        }
    }

    // 测试Bridge连接
    function testBridgeConnection() {
        debugLog('=== 开始测试Bridge连接 ===');
        
        // 1. 检查window.bridge
        if (typeof window.bridge === 'undefined') {
            debugError('❌ window.bridge 未定义');
            alert('❌ window.bridge 未定义');
            return;
        }
        debugLog('✅ window.bridge 存在');
        
        // 2. 检查extractKnowledgePoints方法
        if (typeof window.bridge.extractKnowledgePoints !== 'function') {
            debugError('❌ extractKnowledgePoints 方法不存在');
            alert('❌ extractKnowledgePoints 方法不存在');
            return;
        }
        debugLog('✅ extractKnowledgePoints 方法存在');
        
        // 3. 测试简单调用
        try {
            debugLog('测试调用extractKnowledgePoints...');
            window.bridge.extractKnowledgePoints('test_path', function(result) {
                debugLog(`测试调用成功，收到结果: ${result}`);
                alert(`✅ Bridge连接正常！收到结果长度: ${result ? result.length : 'null'}`);
            });
        } catch (error) {
            debugError(`❌ 测试调用失败: ${error.message}`);
            alert(`❌ 测试调用失败: ${error.message}`);
        }
        
        debugLog('=== Bridge连接测试完成 ===');
    }

    // 提取知识点功能
    function extractKnowledgePoints() {
        addToDebugPanel('INFO', '=== 开始知识点提取流程 ===');
        debugLog('开始提取知识点');
        
        // 详细的调试信息
        addToDebugPanel('INFO', `当前文件路径: ${currentFilePath}`);
        addToDebugPanel('INFO', `当前文件名: ${currentFileName}`);
        addToDebugPanel('INFO', `Bridge对象存在: ${!!window.bridge}`);
        addToDebugPanel('INFO', `extractKnowledgePoints方法存在: ${!!(window.bridge && window.bridge.extractKnowledgePoints)}`);
        
        debugLog(`当前文件路径: ${currentFilePath}`);
        debugLog(`当前文件名: ${currentFileName}`);
        debugLog(`Bridge对象存在: ${!!window.bridge}`);
        debugLog(`extractKnowledgePoints方法存在: ${!!(window.bridge && window.bridge.extractKnowledgePoints)}`);
        
        if (!currentFilePath) {
            addToDebugPanel('ERROR', '没有选中的文件，无法提取知识点');
            debugError('没有选中的文件');
            alert('请先选择一个文档文件');
            return;
        }
        
        if (!window.bridge || !window.bridge.extractKnowledgePoints) {
            addToDebugPanel('ERROR', 'Bridge对象或extractKnowledgePoints方法不可用');
            addToDebugPanel('ERROR', `window.bridge: ${window.bridge}`);
            addToDebugPanel('ERROR', `window.bridge.extractKnowledgePoints: ${window.bridge ? window.bridge.extractKnowledgePoints : 'bridge不存在'}`);
            debugError('Bridge对象或extractKnowledgePoints方法不可用');
            debugError(`window.bridge: ${window.bridge}`);
            debugError(`window.bridge.extractKnowledgePoints: ${window.bridge ? window.bridge.extractKnowledgePoints : 'bridge不存在'}`);
            alert('知识点提取功能不可用');
            return;
        }
        
        // 显示加载状态
        showKnowledgeLoading();
        
        // 禁用提取按钮
        const extractBtn = document.getElementById('extract-btn');
        if (extractBtn) {
            extractBtn.style.opacity = '0.5';
            extractBtn.style.pointerEvents = 'none';
        }
        
        debugLog(`开始提取文件知识点: ${currentFileName}`);
        
        try {
            addToDebugPanel('INFO', `准备调用bridge.extractKnowledgePoints，文件路径: ${currentFilePath}`);
            debugLog(`调用bridge.extractKnowledgePoints，文件路径: ${currentFilePath}`);
            
            window.bridge.extractKnowledgePoints(currentFilePath, function(resultJson) {
                addToDebugPanel('SUCCESS', '知识点提取回调函数被触发');
                addToDebugPanel('INFO', `回调结果长度: ${resultJson ? resultJson.length : 'null'}`);
                addToDebugPanel('INFO', `原始结果前200字符: ${resultJson ? resultJson.substring(0, 200) : 'null'}`);
                
                debugLog(`知识点提取回调触发，结果长度: ${resultJson ? resultJson.length : 'null'}`);
                debugLog(`原始结果前200字符: ${resultJson ? resultJson.substring(0, 200) : 'null'}`);
                
                if (!resultJson) {
                    addToDebugPanel('ERROR', '收到空的API结果');
                    debugError('收到空的结果');
                    showKnowledgeError('收到空的提取结果');
                    return;
                }
                
                try {
                    addToDebugPanel('INFO', '开始解析JSON结果');
                    const result = JSON.parse(resultJson);
                    
                    addToDebugPanel('SUCCESS', `JSON解析成功，结果类型: ${typeof result}`);
                    addToDebugPanel('INFO', `结果是否为数组: ${Array.isArray(result)}`);
                    addToDebugPanel('INFO', `结果包含的键: ${Object.keys(result)}`);
                    addToDebugPanel('INFO', `success字段: ${result.success}`);
                    addToDebugPanel('INFO', `knowledge_points字段存在: ${!!result.knowledge_points}`);
                    addToDebugPanel('INFO', `knowledge_points长度: ${result.knowledge_points ? result.knowledge_points.length : 'undefined'}`);
                    
                    debugLog(`JSON解析成功，结果类型: ${typeof result}`);
                    debugLog(`结果包含的键: ${Object.keys(result)}`);
                    debugLog(`success字段: ${result.success}`);
                    debugLog(`knowledge_points长度: ${result.knowledge_points ? result.knowledge_points.length : 'undefined'}`);
                    
                    // 检查是否是直接返回的知识点数组格式
                    if (Array.isArray(result)) {
                        addToDebugPanel('INFO', `检测到数组格式，包含 ${result.length} 个元素`);
                        addToDebugPanel('INFO', '转换为标准格式');
                        
                        // 转换数组格式为标准格式
                        const convertedResult = {
                            success: true,
                            knowledge_points: result.map(item => ({
                                name: item.title || item.name || item.concept_name || '未命名知识点',
                                description: item.content || item.description || item.core_definition || '无描述',
                                category: item.category || '',
                                importance: item.importance || '中等'
                            })),
                            total_count: result.length
                        };
                        
                        addToDebugPanel('SUCCESS', `转换完成，包含 ${convertedResult.knowledge_points.length} 个知识点`);
                        addToDebugPanel('INFO', '转换后的知识点详情:');
                        convertedResult.knowledge_points.forEach((point, index) => {
                            addToDebugPanel('INFO', `  知识点${index + 1}: ${point.name} - ${point.description}`);
                        });
                        
                        displayKnowledgePoints(convertedResult);
                    } else {
                        // 标准对象格式
                        if (result.knowledge_points && result.knowledge_points.length > 0) {
                            addToDebugPanel('INFO', '标准对象格式，知识点详情:');
                            result.knowledge_points.forEach((point, index) => {
                                addToDebugPanel('INFO', `  知识点${index + 1}: ${JSON.stringify(point)}`);
                            });
                        }
                        
                        displayKnowledgePoints(result);
                    }
                } catch (parseError) {
                    addToDebugPanel('ERROR', `JSON解析失败: ${parseError.message}`);
                    addToDebugPanel('ERROR', `原始结果: ${resultJson}`);
                    debugError(`解析知识点结果失败: ${parseError.message}`);
                    debugError(`原始结果: ${resultJson}`);
                    showKnowledgeError('解析知识点结果失败: ' + parseError.message);
                }
                
                // 恢复提取按钮
                if (extractBtn) {
                    extractBtn.style.opacity = '1';
                    extractBtn.style.pointerEvents = 'auto';
                }
            });
        } catch (error) {
            debugError(`提取知识点时发生错误: ${error.message}`);
            showKnowledgeError('提取知识点时发生错误: ' + error.message);
            
            // 恢复提取按钮
            if (extractBtn) {
                extractBtn.style.opacity = '1';
                extractBtn.style.pointerEvents = 'auto';
            }
        }
    }

    // 显示知识点加载状态
    function showKnowledgeLoading() {
        const placeholderDiv = document.getElementById('knowledge-placeholder');
        const contentDiv = document.getElementById('knowledge-content');
        const loadingDiv = document.getElementById('knowledge-loading');
        
        if (placeholderDiv) placeholderDiv.classList.add('hidden');
        if (contentDiv) contentDiv.classList.add('hidden');
        if (loadingDiv) loadingDiv.classList.remove('hidden');
    }

    // 显示知识点内容
    function displayKnowledgePoints(result) {
        addToDebugPanel('INFO', '=== 开始显示知识点内容 ===');
        debugLog('显示知识点内容');
        debugLog(`传入的result: ${JSON.stringify(result)}`);
        
        const loadingDiv = document.getElementById('knowledge-loading');
        const contentDiv = document.getElementById('knowledge-content');
        const placeholderDiv = document.getElementById('knowledge-placeholder');
        
        addToDebugPanel('INFO', `DOM元素检查 - loading: ${!!loadingDiv}, content: ${!!contentDiv}, placeholder: ${!!placeholderDiv}`);
        debugLog(`DOM元素检查 - loading: ${!!loadingDiv}, content: ${!!contentDiv}, placeholder: ${!!placeholderDiv}`);
        
        // 隐藏加载状态
        if (loadingDiv) {
            loadingDiv.classList.add('hidden');
            addToDebugPanel('INFO', '隐藏加载状态');
        }
        if (placeholderDiv) {
            placeholderDiv.classList.add('hidden');
            addToDebugPanel('INFO', '隐藏占位符');
        }
        
        addToDebugPanel('INFO', `result.success: ${result.success}`);
        addToDebugPanel('INFO', `result.knowledge_points存在: ${!!result.knowledge_points}`);
        addToDebugPanel('INFO', `result.knowledge_points长度: ${result.knowledge_points ? result.knowledge_points.length : 'undefined'}`);
        
        debugLog(`result.success: ${result.success}`);
        debugLog(`result.knowledge_points存在: ${!!result.knowledge_points}`);
        debugLog(`result.knowledge_points长度: ${result.knowledge_points ? result.knowledge_points.length : 'undefined'}`);
        
        if (result.success && result.knowledge_points && result.knowledge_points.length > 0) {
            addToDebugPanel('SUCCESS', `准备显示 ${result.knowledge_points.length} 个知识点`);
            const knowledgePoints = result.knowledge_points;
            debugLog(`成功提取 ${knowledgePoints.length} 个知识点`);
            
            // 生成知识点HTML
            let html = `
                <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex items-center text-green-800">
                        <span class="material-icons-outlined text-sm mr-2">check_circle</span>
                        <span class="font-medium">成功提取 ${knowledgePoints.length} 个知识点</span>
                    </div>
                </div>
            `;
            
            knowledgePoints.forEach((point, index) => {
                const importanceColor = getImportanceColor(point.importance);
                html += `
                    <div class="mb-3 p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex items-start justify-between mb-2">
                            <h4 class="font-medium text-gray-800 text-sm">${point.name || '未命名知识点'}</h4>
                            <span class="px-2 py-1 text-xs rounded-full ${importanceColor}">${point.importance || '中等'}</span>
                        </div>
                        <p class="text-gray-600 text-sm leading-relaxed">${point.description || '暂无描述'}</p>
                        ${point.category ? `<div class="mt-2"><span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${point.category}</span></div>` : ''}
                    </div>
                `;
            });
            
            if (contentDiv) {
                contentDiv.innerHTML = html;
                contentDiv.classList.remove('hidden');
            }
            
        } else {
            const errorMsg = result.error || '未能提取到知识点';
            debugError(`知识点提取失败: ${errorMsg}`);
            showKnowledgeError(errorMsg);
        }
    }

    // 显示知识点错误
    function showKnowledgeError(errorMessage) {
        const loadingDiv = document.getElementById('knowledge-loading');
        const contentDiv = document.getElementById('knowledge-content');
        const placeholderDiv = document.getElementById('knowledge-placeholder');
        
        // 隐藏加载状态
        if (loadingDiv) loadingDiv.classList.add('hidden');
        if (placeholderDiv) placeholderDiv.classList.add('hidden');
        
        // 显示错误信息
        if (contentDiv) {
            contentDiv.innerHTML = `
                <div class="text-center py-8">
                    <div class="mb-4">
                        <span class="material-icons-outlined text-6xl text-red-400">error</span>
                    </div>
                    <p class="text-red-600 font-medium mb-2">知识点提取失败</p>
                    <p class="text-gray-500 text-sm">${errorMessage}</p>
                    <button class="mt-4 px-4 py-2 bg-primary text-white rounded-lg text-sm hover:bg-primary-dark" onclick="extractKnowledgePoints()">
                        重试
                    </button>
                </div>
            `;
            contentDiv.classList.remove('hidden');
        }
    }

    // 获取重要性颜色
    function getImportanceColor(importance) {
        switch (importance) {
            case '高':
            case '重要':
                return 'bg-red-100 text-red-800';
            case '中':
            case '中等':
                return 'bg-yellow-100 text-yellow-800';
            case '低':
            case '一般':
                return 'bg-green-100 text-green-800';
            default:
                return 'bg-gray-100 text-gray-800';
        }
    }

    // 导航函数（兼容SPA）
    function loadContent(contentId) {
        if (window.bridge && window.bridge.loadContent) {
            window.bridge.loadContent(contentId);
        }
    }

    // 将函数暴露到全局作用域
    window.toggleFolder = toggleFolder;
    window.handleFileClick = handleFileClick;
    window.switchToPreview = switchToPreview;
    window.switchToEdit = switchToEdit;
    window.saveCurrentFile = saveCurrentFile;
    window.createNewNote = createNewNote;
    window.createNewFolder = createNewFolder;
    window.validateBackendFunctions = validateBackendFunctions;
    window.contextMenuAction = contextMenuAction;
    window.testBridgeConnection = testBridgeConnection;
    window.toggleDebugPanel = toggleDebugPanel;
    window.clearDebugLog = clearDebugLog;
    window.extractKnowledgePoints = extractKnowledgePoints;
    window.loadContent = loadContent;

    // 页面初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePage);
    } else {
        initializePage();
    }

})();
</script>
