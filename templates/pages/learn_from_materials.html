<!-- 从资料学习页面 - 完整的树形文件管理 -->
<style>
    /* 侧边栏收缩样式 */
    #sidebar.collapsed .sidebar-text,
    #sidebar.collapsed #user-profile,
    #sidebar.collapsed .logo-text {
        display: none;
    }
    #sidebar.collapsed .nav-item-icon {
        margin-right: 0;
    }
    #sidebar.collapsed .nav-link {
        justify-content: center;
    }
    
    /* 文件树样式 */
    .file-item-content {
        transition: all 0.2s ease;
    }
    .file-item-content:hover {
        background-color: #f3f4f6;
    }
    .file-item-content.selected {
        background-color: #32C77F !important;
        color: white !important;
    }
    .file-item-content.drag-over {
        border: 2px dashed #10b981;
        background-color: rgba(16, 185, 129, 0.1);
    }
    .folder-toggle {
        transition: transform 0.2s ease;
    }
    
    /* 右键菜单样式 */
    .context-menu {
        position: fixed;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        min-width: 150px;
    }
    .context-menu-item {
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        font-size: 14px;
    }
    .context-menu-item:hover {
        background-color: #f3f4f6;
    }
    .context-menu-item .material-icons-outlined {
        margin-right: 8px;
        font-size: 16px;
    }
</style>

<div class="flex h-screen bg-white">
    <!-- 主内容区域 -->
    <div class="flex-1 flex bg-bg-light-blue-gray" id="main-content">
        
        <!-- 左侧文件结构面板 -->
        <div class="w-1/4 bg-white border-r border-gray-200 p-4 flex flex-col transition-all duration-300" id="file-structure">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-text-dark-brown">文件结构</h2>
                <div class="space-x-2">
                    <button class="text-text-gray hover:text-primary" onclick="createNewFolder()" title="新建文件夹">
                        <span class="material-icons-outlined">create_new_folder</span>
                    </button>
                    <button class="text-text-gray hover:text-primary" onclick="createNewNote()" title="新建笔记">
                        <span class="material-icons-outlined">note_add</span>
                    </button>
                    <button class="text-red-600 hover:text-red-800" onclick="validateBackendFunctions()" title="验证后端功能">
                        <span class="material-icons-outlined">bug_report</span>
                    </button>
                </div>
            </div>
            
            <!-- 文件树容器 -->
            <div class="flex-1 overflow-y-auto pr-2">
                <div id="loading-indicator" class="flex items-center justify-center py-8">
                    <div class="animate-spin">
                        <span class="material-icons-outlined text-primary">refresh</span>
                    </div>
                    <span class="ml-2 text-text-medium-brown">加载文件结构中...</span>
                </div>
                <div id="file-tree-container"></div>
            </div>
        </div>

        <!-- 中间文档预览/编辑区域 -->
        <div class="flex-1 bg-white border-r border-gray-200 flex flex-col">
            <!-- 顶部工具栏 -->
            <div class="border-b border-gray-200 p-4 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-text-dark-brown" id="preview-title">文档预览区</h2>
                <div class="flex space-x-2">
                    <button id="preview-btn" class="px-4 py-2 bg-primary text-white rounded-lg text-sm" onclick="switchToPreview()">预览</button>
                    <button id="edit-btn" class="px-4 py-2 bg-white border border-gray-300 text-text-gray rounded-lg text-sm" onclick="switchToEdit()">编辑</button>
                </div>
            </div>
            
            <!-- 内容区域 -->
            <div class="flex-1 p-4 overflow-y-auto">
                <div id="preview-content" class="prose max-w-none">
                    <div class="text-center py-16 text-text-medium-brown">
                        <span class="material-icons-outlined text-6xl mb-4">description</span>
                        <p>请选择一个Markdown文件进行预览</p>
                    </div>
                </div>
                <textarea id="edit-content" class="w-full h-full border border-gray-300 rounded-lg p-4 font-mono text-sm resize-none hidden" placeholder="在此编辑Markdown内容..."></textarea>
            </div>
        </div>

        <!-- 右侧知识点面板 -->
        <div class="w-1/4 bg-white p-4 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-text-dark-brown">知识点</h2>
                <button class="text-text-gray hover:text-primary" onclick="extractKnowledgePoints()" title="提取知识点">
                    <span class="material-icons-outlined">lightbulb</span>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto">
                <div id="knowledge-points-container">
                    <div class="text-center py-16 text-text-medium-brown">
                        <span class="material-icons-outlined text-6xl mb-4">psychology</span>
                        <p>选择文档后可提取知识点</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 右键菜单 -->
<div id="context-menu" class="context-menu hidden">
    <div class="context-menu-item" onclick="contextMenuAction('rename')">
        <span class="material-icons-outlined">edit</span>
        重命名
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('delete')">
        <span class="material-icons-outlined">delete</span>
        删除
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('newNote')">
        <span class="material-icons-outlined">note_add</span>
        新建笔记
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('newFolder')">
        <span class="material-icons-outlined">create_new_folder</span>
        新建文件夹
    </div>
</div>

<script>
(function() {
    'use strict';
    
    let currentFilePath = '';
    let currentFileName = '';
    let isEditMode = false;
    let contextMenuTarget = null;

    // 调试函数
    function debugLog(message) {
        console.log('[Learn Materials Debug]', message);
        if (window.sendDebugLog) {
            window.sendDebugLog('Learn Materials: ' + message);
        }
    }

    function debugError(message) {
        console.error('[Learn Materials Error]', message);
        if (window.sendDebugLog) {
            window.sendDebugLog('Learn Materials Error: ' + message);
        }
    }

    // 页面初始化
    function initializePage() {
        debugLog('页面初始化开始');
        
        // 检查Bridge连接
        if (window.bridge) {
            debugLog('Bridge对象已可用');
            loadFileStructure();
        } else {
            debugLog('Bridge对象不可用，等待连接...');
            // 等待Bridge连接
            setTimeout(() => {
                if (window.bridge) {
                    debugLog('Bridge连接成功，加载文件结构');
                    loadFileStructure();
                } else {
                    debugError('Bridge连接超时');
                }
            }, 1000);
        }
        
        // 添加全局事件监听器
        document.addEventListener('click', hideContextMenu);
        document.addEventListener('contextmenu', function(e) {
            if (!e.target.closest('.file-item-content')) {
                e.preventDefault();
                hideContextMenu();
            }
        });
    }

    // 加载文件结构
    function loadFileStructure() {
        debugLog('开始加载文件结构');
        
        if (!window.bridge || typeof window.bridge.getFileStructure !== 'function') {
            debugError('Bridge对象或getFileStructure方法不可用');
            return;
        }
        
        try {
            window.bridge.getFileStructure(function(jsonString) {
                debugLog('收到文件结构数据: ' + jsonString.substring(0, 100) + '...');
                
                try {
                    const structure = JSON.parse(jsonString);
                    renderFileTree(structure);
                } catch (parseError) {
                    debugError('解析文件结构JSON失败: ' + parseError.message);
                }
            });
        } catch (error) {
            debugError('调用getFileStructure时发生错误: ' + error.message);
        }
    }

    // 文件树渲染函数
    function renderFileTree(data) {
        debugLog('渲染文件树，数据项数: ' + (data ? data.length : 0));
        
        const container = document.getElementById('file-tree-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }
        
        if (!container) {
            debugError('文件树容器未找到');
            return;
        }
        
        if (!data || data.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-text-medium-brown">暂无文件</div>';
            return;
        }
        
        let html = '<ul class="space-y-1">';
        data.forEach(item => {
            html += renderFileItem(item, 0);
        });
        html += '</ul>';
        
        container.innerHTML = html;
        
        // 添加事件监听器
        addFileTreeEventListeners();
        debugLog('文件树渲染完成');
    }

    function renderFileItem(item, level) {
        const indent = level * 20;
        const isFolder = item.type === 'folder';
        const icon = isFolder ? 'folder' : 'description';
        const itemClass = isFolder ? 'folder-item' : 'file-item';
        
        let html = `
            <li class="${itemClass}" data-path="${item.path}" data-type="${item.type}" data-name="${item.name}">
                <div class="flex items-center py-1 px-2 hover:bg-gray-100 rounded cursor-pointer file-item-content" 
                     style="margin-left: ${indent}px"
                     draggable="true">
                    ${isFolder ? '<span class="material-icons-outlined text-sm mr-1 folder-toggle">chevron_right</span>' : '<span class="w-5"></span>'}
                    <span class="material-icons-outlined text-sm mr-2 text-text-gray">${icon}</span>
                    <span class="text-sm text-text-dark-brown flex-1 file-name">${item.name}</span>
                </div>
        `;
        
        if (isFolder && item.children && item.children.length > 0) {
            html += '<ul class="folder-children hidden ml-4">';
            item.children.forEach(child => {
                html += renderFileItem(child, level + 1);
            });
            html += '</ul>';
        }
        
        html += '</li>';
        return html;
    }

    // 添加文件树事件监听器
    function addFileTreeEventListeners() {
        debugLog('添加文件树事件监听器');
        
        const fileItems = document.querySelectorAll('.file-item-content');
        
        fileItems.forEach(content => {
            // 点击事件
            content.addEventListener('click', function(e) {
                const item = this.closest('li');
                const path = item.getAttribute('data-path');
                const type = item.getAttribute('data-type');
                const name = item.getAttribute('data-name');
                
                handleFileClick(path, type, name, this);
            });
            
            // 右键菜单
            content.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                const item = this.closest('li');
                const path = item.getAttribute('data-path');
                const type = item.getAttribute('data-type');
                const name = item.getAttribute('data-name');
                
                showContextMenu(e, path, type, name);
            });
            
            // 拖拽事件
            content.addEventListener('dragstart', handleDragStart);
            content.addEventListener('dragover', handleDragOver);
            content.addEventListener('drop', handleDrop);
            content.addEventListener('dragenter', handleDragEnter);
            content.addEventListener('dragleave', handleDragLeave);
        });
        
        // 文件夹切换事件
        const folderToggles = document.querySelectorAll('.folder-toggle');
        folderToggles.forEach(toggle => {
            toggle.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleFolder(this);
            });
        });
    }

    // 处理文件点击
    function handleFileClick(path, type, name, element) {
        debugLog(`文件点击: ${name} (${type}) - ${path}`);
        
        // 移除之前的选中状态
        document.querySelectorAll('.file-item-content.selected').forEach(el => {
            el.classList.remove('selected');
        });
        
        // 添加选中状态
        element.classList.add('selected');
        
        if (type === 'file' && path.endsWith('.md')) {
            // 加载Markdown文件
            loadFileContent(path, name);
        }
    }

    // 加载文件内容
    function loadFileContent(filePath, fileName) {
        debugLog(`加载文件内容: ${fileName}`);
        
        currentFilePath = filePath;
        currentFileName = fileName;
        
        if (!window.bridge || !window.bridge.loadMarkdownFile) {
            debugError('Bridge对象或loadMarkdownFile方法不可用');
            return;
        }
        
        // 更新文档预览区标题
        const previewTitle = document.getElementById('preview-title');
        if (previewTitle) {
            previewTitle.textContent = fileName;
        }
        
        // 显示加载状态
        const previewContent = document.getElementById('preview-content');
        if (previewContent) {
            previewContent.innerHTML = '<div class="flex items-center justify-center py-8"><div class="animate-spin mr-2"><span class="material-icons-outlined">refresh</span></div><span>加载中...</span></div>';
        }
        
        // 调用后端加载文件
        try {
            window.bridge.loadMarkdownFile(filePath, function(htmlContent) {
                debugLog(`文件内容加载完成，长度: ${htmlContent.length}`);
                
                if (previewContent) {
                    if (htmlContent) {
                        previewContent.innerHTML = htmlContent;
                    } else {
                        previewContent.innerHTML = '<div class="text-center py-8 text-gray-500">文件内容为空或加载失败</div>';
                    }
                }
                
                // 切换到预览模式
                switchToPreview();
            });
        } catch (error) {
            debugError(`加载文件内容时发生错误: ${error.message}`);
            if (previewContent) {
                previewContent.innerHTML = '<div class="text-center py-8 text-red-500">加载文件失败</div>';
            }
        }
    }

    // 切换到预览模式
    function switchToPreview() {
        debugLog('切换到预览模式');
        isEditMode = false;
        
        document.getElementById('preview-content').classList.remove('hidden');
        document.getElementById('edit-content').classList.add('hidden');
        
        // 更新按钮状态
        document.getElementById('preview-btn').classList.add('bg-primary', 'text-white');
        document.getElementById('preview-btn').classList.remove('bg-white', 'border-gray-300', 'text-text-gray');
        document.getElementById('edit-btn').classList.add('bg-white', 'border-gray-300', 'text-text-gray');
        document.getElementById('edit-btn').classList.remove('bg-primary', 'text-white');
    }

    // 切换到编辑模式
    function switchToEdit() {
        debugLog('切换到编辑模式');
        
        if (!currentFilePath) {
            debugLog('没有选中的文件');
            return;
        }
        
        isEditMode = true;
        
        // 加载原始内容
        if (window.bridge && window.bridge.loadMarkdownRaw) {
            window.bridge.loadMarkdownRaw(currentFilePath, function(rawContent) {
                debugLog(`原始内容加载完成，长度: ${rawContent.length}`);
                
                const editContent = document.getElementById('edit-content');
                if (editContent) {
                    editContent.value = rawContent;
                }
                
                document.getElementById('preview-content').classList.add('hidden');
                document.getElementById('edit-content').classList.remove('hidden');
                
                // 更新按钮状态
                document.getElementById('edit-btn').classList.add('bg-primary', 'text-white');
                document.getElementById('edit-btn').classList.remove('bg-white', 'border-gray-300', 'text-text-gray');
                document.getElementById('preview-btn').classList.add('bg-white', 'border-gray-300', 'text-text-gray');
                document.getElementById('preview-btn').classList.remove('bg-primary', 'text-white');
            });
        }
    }

    // 切换文件夹展开/折叠
    function toggleFolder(toggleElement) {
        debugLog('切换文件夹状态');
        
        const folderItem = toggleElement.closest('.folder-item');
        const children = folderItem.querySelector('.folder-children');
        
        if (children) {
            const isHidden = children.classList.contains('hidden');
            
            if (isHidden) {
                children.classList.remove('hidden');
                toggleElement.textContent = 'expand_more';
            } else {
                children.classList.add('hidden');
                toggleElement.textContent = 'chevron_right';
            }
        }
    }

    // 拖拽处理函数
    let draggedElement = null;

    function handleDragStart(e) {
        draggedElement = this.closest('li');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', draggedElement.outerHTML);
        
        const path = draggedElement.getAttribute('data-path');
        const name = draggedElement.getAttribute('data-name');
        debugLog(`开始拖拽: ${name} - ${path}`);
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(e) {
        const targetItem = this.closest('li');
        const targetType = targetItem.getAttribute('data-type');
        
        if (targetType === 'folder' && targetItem !== draggedElement) {
            this.classList.add('drag-over');
        }
    }

    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        const targetItem = this.closest('li');
        const targetType = targetItem.getAttribute('data-type');
        const targetPath = targetItem.getAttribute('data-path');
        
        if (targetType === 'folder' && targetItem !== draggedElement && draggedElement) {
            const sourcePath = draggedElement.getAttribute('data-path');
            const sourceName = draggedElement.getAttribute('data-name');
            
            debugLog(`拖拽移动: ${sourceName} -> ${targetPath}`);
            
            // 调用后端移动文件
            if (window.bridge && window.bridge.moveFileOrFolder) {
                window.bridge.moveFileOrFolder(sourcePath, targetPath, function(success) {
                    if (success) {
                        debugLog('文件移动成功');
                        loadFileStructure(); // 重新加载文件结构
                    } else {
                        debugError('文件移动失败');
                    }
                });
            }
        }
        
        draggedElement = null;
    }

    // 右键菜单功能
    function showContextMenu(e, path, type, name) {
        e.preventDefault();
        
        const contextMenu = document.getElementById('context-menu');
        contextMenuTarget = { path, type, name };
        
        contextMenu.style.left = e.pageX + 'px';
        contextMenu.style.top = e.pageY + 'px';
        contextMenu.classList.remove('hidden');
        
        debugLog(`显示右键菜单: ${name} (${type})`);
    }

    function hideContextMenu() {
        const contextMenu = document.getElementById('context-menu');
        contextMenu.classList.add('hidden');
        contextMenuTarget = null;
    }

    function contextMenuAction(action) {
        if (!contextMenuTarget) return;
        
        const { path, type, name } = contextMenuTarget;
        debugLog(`右键菜单操作: ${action} - ${name}`);
        
        switch (action) {
            case 'rename':
                renameItem(path, name);
                break;
            case 'delete':
                deleteItem(path, name);
                break;
            case 'newNote':
                createNewNote(path);
                break;
            case 'newFolder':
                createNewFolder(path);
                break;
        }
        
        hideContextMenu();
    }

    // 重命名功能
    function renameItem(path, currentName) {
        const newName = prompt('请输入新名称:', currentName);
        if (newName && newName !== currentName) {
            debugLog(`重命名: ${currentName} -> ${newName}`);
            
            if (window.bridge && window.bridge.renameFileOrFolder) {
                window.bridge.renameFileOrFolder(path, newName, function(success) {
                    if (success) {
                        debugLog('重命名成功');
                        loadFileStructure();
                    } else {
                        debugError('重命名失败');
                        alert('重命名失败，请检查名称是否已存在');
                    }
                });
            }
        }
    }

    // 删除功能
    function deleteItem(path, name) {
        if (confirm(`确定要删除 "${name}" 吗？此操作不可恢复。`)) {
            debugLog(`删除: ${name}`);
            
            if (window.bridge && window.bridge.deleteFileOrFolder) {
                window.bridge.deleteFileOrFolder(path, function(success) {
                    if (success) {
                        debugLog('删除成功');
                        loadFileStructure();
                    } else {
                        debugError('删除失败');
                        alert('删除失败');
                    }
                });
            }
        }
    }

    // 文件操作函数
    function createNewNote(parentPath = 'vault') {
        debugLog('创建新笔记');
        if (window.bridge && window.bridge.createNewNote) {
            window.bridge.createNewNote(parentPath, function(result) {
                debugLog('新笔记创建结果: ' + result);
                if (result) {
                    loadFileStructure();
                }
            });
        }
    }

    function createNewFolder(parentPath = 'vault') {
        debugLog('创建新文件夹');
        if (window.bridge && window.bridge.createNewFolder) {
            window.bridge.createNewFolder(parentPath, function(result) {
                debugLog('新文件夹创建结果: ' + result);
                if (result) {
                    loadFileStructure();
                }
            });
        }
    }

    // 验证后端功能
    function validateBackendFunctions() {
        debugLog('🔍 开始验证后端功能');
        
        if (!window.bridge || typeof window.bridge.validateAllFileOperations !== 'function') {
            debugError('❌ Bridge对象或validateAllFileOperations方法不可用');
            alert('❌ 无法连接到后端验证服务');
            return;
        }
        
        // 显示验证开始提示
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'validation-loading';
        loadingDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        loadingDiv.innerHTML = `
            <div class="flex items-center">
                <div class="animate-spin mr-2">
                    <span class="material-icons-outlined">refresh</span>
                </div>
                <span>正在验证后端功能...</span>
            </div>
        `;
        document.body.appendChild(loadingDiv);
        
        debugLog('调用后端验证功能...');
        
        try {
            window.bridge.validateAllFileOperations(function(result) {
                debugLog('🎯 后端验证完成');
                debugLog('验证结果: ' + result);
                
                // 移除加载提示
                const loadingElement = document.getElementById('validation-loading');
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                // 显示验证结果
                const resultDiv = document.createElement('div');
                resultDiv.className = 'fixed top-4 right-4 bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-w-md p-4';
                resultDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-800">后端功能验证结果</h3>
                        <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                            <span class="material-icons-outlined text-sm">close</span>
                        </button>
                    </div>
                    <div class="text-sm text-gray-600 whitespace-pre-line max-h-64 overflow-y-auto">
                        ${result}
                    </div>
                `;
                document.body.appendChild(resultDiv);
                
                // 10秒后自动关闭
                setTimeout(() => {
                    if (resultDiv.parentElement) {
                        resultDiv.remove();
                    }
                }, 10000);
                
                // 重新加载文件结构以反映任何更改
                loadFileStructure();
            });
        } catch (error) {
            debugError('调用后端验证时发生错误: ' + error.message);
            
            // 移除加载提示
            const loadingElement = document.getElementById('validation-loading');
            if (loadingElement) {
                loadingElement.remove();
            }
            
            alert('❌ 验证过程中发生错误: ' + error.message);
        }
    }

    // 导航函数（兼容SPA）
    function loadContent(contentId) {
        if (window.bridge && window.bridge.loadContent) {
            window.bridge.loadContent(contentId);
        }
    }

    // 将函数暴露到全局作用域
    window.toggleFolder = toggleFolder;
    window.handleFileClick = handleFileClick;
    window.switchToPreview = switchToPreview;
    window.switchToEdit = switchToEdit;
    window.createNewNote = createNewNote;
    window.createNewFolder = createNewFolder;
    window.validateBackendFunctions = validateBackendFunctions;
    window.contextMenuAction = contextMenuAction;
    window.loadContent = loadContent;

    // 页面初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePage);
    } else {
        initializePage();
    }

})();
</script>
