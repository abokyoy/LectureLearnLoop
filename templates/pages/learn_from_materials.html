<!-- ä»èµ„æ–™å­¦ä¹ é¡µé¢ - åƒç´ çº§è¿˜åŸç¬”è®°.htmlçš„å¸ƒå±€ -->
<style>
    /* æ‹–æ”¾æ ·å¼ä¼˜åŒ– */
    .drag-over {
        border: 2px dashed #32C77F !important;
        background-color: rgba(50, 199, 127, 0.1) !important;
    }
    
    .dragging {
        opacity: 0.5;
        transform: rotate(2deg);
        transition: all 0.2s ease;
    }
    
    /* æ–‡ä»¶æ ‘é¡¹ç›®æ ·å¼ - ä¸ç¬”è®°.htmlä¿æŒä¸€è‡´ */
    .file-item .flex:hover, .folder-item .flex:hover {
        background-color: #F2F0ED; /* ä½¿ç”¨bg-light-gray */
        transition: background-color 0.2s ease;
    }
    
    .file-item .flex.selected, .folder-item .flex.selected {
        background-color: #E2F2EB; /* ä½¿ç”¨bg-light-green */
        border-left: 3px solid #32C77F; /* ä½¿ç”¨primaryè‰² */
    }
    
    /* å³é”®èœå•åŠ¨ç”» */
    #context-menu {
        animation: fadeInScale 0.15s ease-out;
        transform-origin: top left;
    }
    
    @keyframes fadeInScale {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    /* çŸ¥è¯†ç‚¹å¡ç‰‡æ ·å¼ - ä¸ç¬”è®°.htmlä¿æŒä¸€è‡´ */
    .knowledge-card {
        transition: all 0.2s ease;
        border-left: 4px solid transparent;
    }
    
    .knowledge-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-left-color: #32C77F; /* ä½¿ç”¨primaryè‰² */
    }
    
    /* ç¼–è¾‘å™¨æ ·å¼ */
    #markdown-editor {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        line-height: 1.6;
        tab-size: 4;
    }
    
    #markdown-editor:focus {
        outline: none;
        box-shadow: inset 0 0 0 2px #32C77F; /* ä½¿ç”¨primaryè‰² */
    }
    
    /* åŠ è½½åŠ¨ç”» */
    .loading-spinner {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* æŒ‰é’®ç¦ç”¨çŠ¶æ€ */
    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>

<!-- ä¸»å†…å®¹åŒºåŸŸ - å®Œå…¨æŒ‰ç…§ç¬”è®°.htmlçš„ä¸‰æ å¸ƒå±€ -->
<div class="flex-1 flex bg-bg-light-blue-gray" id="main-content">
    <!-- å·¦ä¾§æ–‡ä»¶ç»“æ„é¢æ¿ - åƒç´ çº§è¿˜åŸç¬”è®°.html -->
    <div class="w-1/4 bg-white border-r border-gray-200 p-4 flex flex-col transition-all duration-300" id="file-structure">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-text-dark-brown">æ–‡ä»¶ç»“æ„</h2>
            <div class="space-x-2">
                <button class="text-text-gray hover:text-primary" onclick="createNewFolder()">
                    <span class="material-icons-outlined">create_new_folder</span>
                </button>
                <button class="text-text-gray hover:text-primary" onclick="createNewNote()">
                    <span class="material-icons-outlined">note_add</span>
                </button>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto pr-2">
            <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
            <div id="loading-indicator" class="flex items-center justify-center py-8">
                <div class="loading-spinner w-6 h-6 border-2 border-primary border-t-transparent rounded-full"></div>
                <span class="ml-2 text-text-medium-brown">åŠ è½½ä¸­...</span>
            </div>
            <!-- æ–‡ä»¶æ ‘å®¹å™¨ -->
            <ul class="space-y-1" id="file-tree">
                <!-- æ–‡ä»¶æ ‘å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆï¼Œæ ¼å¼ä¸ç¬”è®°.htmlä¿æŒä¸€è‡´ -->
            </ul>
        </div>
    </div>
    
    <!-- ä¸­é—´ä¸»å†…å®¹åŒºåŸŸ - å®Œå…¨æŒ‰ç…§ç¬”è®°.htmlçš„å¸ƒå±€ -->
    <main class="flex-1 p-6 flex flex-col">
        <header class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-text-dark-brown" id="current-file-title">é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¼€å§‹å­¦ä¹ </h2>
            <div class="flex items-center space-x-2">
                <button id="preview-btn" class="flex items-center bg-white border border-gray-300 px-3 py-1.5 rounded-lg text-text-gray hover:bg-gray-100" onclick="switchToPreview()">
                    <span class="material-icons-outlined text-sm mr-1">visibility</span>
                    <span>é¢„è§ˆ</span>
                </button>
                <button id="edit-btn" class="flex items-center bg-primary text-white px-3 py-1.5 rounded-lg hover:bg-green-600" onclick="switchToEdit()">
                    <span class="material-icons-outlined text-sm mr-1">edit</span>
                    <span>ç¼–è¾‘</span>
                </button>
            </div>
        </header>
        <div class="flex-1 bg-white rounded-xl shadow-sm p-6 overflow-y-auto">
            <!-- é¢„è§ˆæ¨¡å¼ -->
            <div id="preview-content" class="prose max-w-none">
                <div class="text-center py-16 text-gray-500">
                    <span class="material-icons-outlined text-6xl mb-4">description</span>
                    <h3 class="text-xl font-medium mb-2">æ¬¢è¿ä½¿ç”¨ä»èµ„æ–™å­¦ä¹ </h3>
                    <p>è¯·ä»å·¦ä¾§æ–‡ä»¶æ ‘ä¸­é€‰æ‹©ä¸€ä¸ªMarkdownæ–‡ä»¶å¼€å§‹å­¦ä¹ </p>
                </div>
            </div>
            <!-- ç¼–è¾‘æ¨¡å¼ -->
            <div id="edit-content" class="hidden h-full">
                <textarea id="markdown-editor" class="w-full h-full border-none resize-none p-4" placeholder="åœ¨è¿™é‡Œç¼–å†™Markdownå†…å®¹..."></textarea>
                <div class="flex justify-end mt-4 space-x-2">
                    <button onclick="saveMarkdownFile()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-green-600">
                        <span class="material-icons-outlined text-sm mr-1">save</span>
                        ä¿å­˜
                    </button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- å³ä¾§çŸ¥è¯†ç‚¹é¢æ¿ - å®Œå…¨æŒ‰ç…§ç¬”è®°.htmlçš„å¸ƒå±€ -->
    <aside class="w-1/5 bg-white border-l border-gray-200 p-4 flex flex-col">
        <h2 class="text-lg font-semibold text-text-dark-brown mb-4">çŸ¥è¯†ç‚¹åˆ—è¡¨</h2>
        <div class="flex-1 overflow-y-auto space-y-3" id="knowledge-points">
            <div class="bg-bg-light-green p-3 rounded-lg cursor-pointer hover:shadow-md transition-shadow knowledge-card">
                <h3 class="font-semibold text-primary">å…´è¶£é©±åŠ¨</h3>
                <p class="text-sm text-text-medium-brown mt-1">å­¦ä¹ çš„æ ¸å¿ƒåŠ¨åŠ›æ¥æºï¼Œæé«˜ä¸»åŠ¨æ€§ã€‚</p>
            </div>
            <div class="bg-bg-light-gray p-3 rounded-lg cursor-pointer hover:shadow-md transition-shadow knowledge-card">
                <h3 class="font-semibold text-text-dark-brown">ç§¯æåé¦ˆ</h3>
                <p class="text-sm text-text-medium-brown mt-1">é€šè¿‡å¥–åŠ±æœºåˆ¶å·©å›ºå­¦ä¹ æˆæœï¼Œæå‡åŠ¨æœºã€‚</p>
            </div>
            <div class="bg-bg-light-gray p-3 rounded-lg cursor-pointer hover:shadow-md transition-shadow knowledge-card">
                <h3 class="font-semibold text-text-dark-brown">ç•ªèŒ„å·¥ä½œæ³•</h3>
                <p class="text-sm text-text-medium-brown mt-1">ä¸€ç§æ—¶é—´ç®¡ç†æ–¹æ³•ï¼Œç”¨äºä¿æŒä¸“æ³¨ã€‚</p>
            </div>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-200">
            <button onclick="extractKnowledgePoints()" class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center">
                <span class="material-icons-outlined text-sm mr-1">psychology</span>
                æå–çŸ¥è¯†ç‚¹
            </button>
        </div>
    </aside>
</div>

<!-- è°ƒè¯•é¢æ¿ -->
<div id="debug-panel" class="fixed bottom-4 right-4 w-96 bg-white border border-gray-300 rounded-lg shadow-lg z-50" style="display: none;">
    <div class="flex justify-between items-center p-3 border-b border-gray-200">
        <h4 class="font-bold text-gray-700">è°ƒè¯•ä¿¡æ¯</h4>
        <button onclick="toggleDebugPanel()" class="text-gray-500 hover:text-gray-700">Ã—</button>
    </div>
    <div id="debug-content" class="p-3 text-xs font-mono text-gray-600 max-h-60 overflow-y-auto whitespace-pre-wrap"></div>
</div>

<script>
    // ä½¿ç”¨IIFEï¼ˆç«‹å³è°ƒç”¨å‡½æ•°è¡¨è¾¾å¼ï¼‰åˆ›å»ºç‹¬ç«‹ä½œç”¨åŸŸï¼Œé¿å…é‡å¤å£°æ˜
    (function() {
    // --- è°ƒè¯•ä»£ç å¼€å§‹ ---
    // å‰ç«¯æ—¥å¿—è®°å½•æ•°ç»„
    let frontendLogs = [];
    
    function debugLog(message) {
        const timestamp = new Date().toISOString();
        const logEntry = `${timestamp} - INFO - ${message}`;
        
        // æ·»åŠ åˆ°æ—¥å¿—æ•°ç»„
        frontendLogs.push(logEntry);
        
        // æ˜¾ç¤ºåœ¨è°ƒè¯•é¢æ¿
        const debugContent = document.getElementById('debug-content');
        if (debugContent) {
            const displayTime = new Date().toLocaleTimeString();
            debugContent.textContent += `[${displayTime}] ${message}\n`;
            debugContent.scrollTop = debugContent.scrollHeight;
        }
        console.log(message);
        
        // å‘é€åˆ°Pythonåç«¯è®°å½•åˆ°æ–‡ä»¶
        if (window.bridge && window.bridge.logFrontendMessage) {
            try {
                window.bridge.logFrontendMessage(logEntry);
            } catch (e) {
                console.warn('æ— æ³•å‘é€æ—¥å¿—åˆ°åç«¯:', e);
            }
        }
    }

    function debugError(message) {
        const timestamp = new Date().toISOString();
        const logEntry = `${timestamp} - ERROR - ${message}`;
        
        // æ·»åŠ åˆ°æ—¥å¿—æ•°ç»„
        frontendLogs.push(logEntry);
        
        // æ˜¾ç¤ºåœ¨è°ƒè¯•é¢æ¿
        const debugContent = document.getElementById('debug-content');
        if (debugContent) {
            const displayTime = new Date().toLocaleTimeString();
            debugContent.textContent += `[${displayTime}] ERROR: ${message}\n`;
            debugContent.scrollTop = debugContent.scrollHeight;
        }
        console.error(message);
        
        // å‘é€åˆ°Pythonåç«¯è®°å½•åˆ°æ–‡ä»¶
        if (window.bridge && window.bridge.logFrontendMessage) {
            try {
                window.bridge.logFrontendMessage(logEntry);
            } catch (e) {
                console.warn('æ— æ³•å‘é€é”™è¯¯æ—¥å¿—åˆ°åç«¯:', e);
            }
        }
    }
    
    // å¯¼å‡ºå‰ç«¯æ—¥å¿—çš„å‡½æ•°
    function exportFrontendLogs() {
        return frontendLogs.join('\n');
    }

    function toggleDebugPanel() {
        const panel = document.getElementById('debug-panel');
        if (panel) {
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
    }

    function showDebugPanel() {
        const panel = document.getElementById('debug-panel');
        if (panel) {
            panel.style.display = 'block';
        }
    }
    // --- è°ƒè¯•ä»£ç ç»“æŸ ---
    
    debugLog('ä»èµ„æ–™å­¦ä¹ é¡µé¢è„šæœ¬åŠ è½½');
    debugLog('å½“å‰æ—¶é—´: ' + new Date().toLocaleTimeString());
    debugLog('document.readyState: ' + document.readyState);
    
    // è°ƒè¯•WebChannelçŠ¶æ€
    debugLog('å½“å‰windowå¯¹è±¡: ' + typeof window);
    debugLog('å½“å‰bridgeå¯¹è±¡: ' + (window.bridge ? 'exists' : 'undefined'));
    debugLog('Qtå¯¹è±¡: ' + (window.qt ? 'exists' : 'undefined'));
    debugLog('QWebChannelç±»å‹: ' + typeof QWebChannel);
    
    // éšè—å…¨å±€headerï¼Œå› ä¸ºæˆ‘ä»¬æœ‰è‡ªå·±çš„header
    const globalHeader = document.querySelector('header');
    if (globalHeader && globalHeader.querySelector('#page-title')) {
        globalHeader.style.display = 'none';
        debugLog('å·²éšè—å…¨å±€header');
    }
    
    // ç›‘å¬WebChannelè¿æ¥äº‹ä»¶
    if (window.qt && window.qt.webChannelTransport) {
        debugLog('WebChannel transport å¯ç”¨');
    } else {
        debugLog('WebChannel transport ä¸å¯ç”¨');
    }
    
    // å…¨å±€å˜é‡
    let currentFilePath = null;
    let currentMode = 'preview'; // 'preview' or 'edit'
    let selectedTreeItem = null; // å½“å‰é€‰ä¸­çš„æ ‘èŠ‚ç‚¹
    
    // é¡µé¢åˆå§‹åŒ–å‡½æ•°
    function initializePage() {
        debugLog('ğŸš€ é¡µé¢åˆå§‹åŒ–å¼€å§‹');
        showDebugPanel(); // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ˜¾ç¤ºè°ƒè¯•é¢æ¿
        
        // å¦‚æœbridgeå·²ç»é€šè¿‡base.htmlæå‰åŠ è½½å¥½äº†ï¼Œç›´æ¥å¼€å§‹
        if (window.bridge && typeof window.bridge.getFileStructure === 'function') {
            debugLog('âœ… Bridgeå·²å¯ç”¨ï¼Œç›´æ¥åŠ è½½æ–‡ä»¶ç»“æ„');
            loadFileStructure();
            return;
        }
        
        // å¦åˆ™ï¼Œç­‰å¾…WebChannelåˆå§‹åŒ–
        if (typeof QWebChannel !== 'undefined' && window.qt && window.qt.webChannelTransport) {
            debugLog('ğŸ”„ å¼€å§‹WebChannelåˆå§‹åŒ–');
            initializeWebChannel();
        } else {
            debugLog('â° å»¶è¿Ÿ500msåé‡è¯•åˆå§‹åŒ–');
            // å…œåº•ï¼Œå»¶è¿Ÿåå†æ¬¡å°è¯•åˆå§‹åŒ–
            setTimeout(initializeWebChannel, 500);
        }
    }
    
    // é¡µé¢åˆå§‹åŒ– - å¤šç§æ–¹å¼ç¡®ä¿æ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', initializePage);
    
    // å¦‚æœDOMContentLoadedå·²ç»è§¦å‘ï¼Œç«‹å³æ‰§è¡Œ
    if (document.readyState === 'loading') {
        debugLog('ğŸ“„ æ–‡æ¡£æ­£åœ¨åŠ è½½ï¼Œç­‰å¾…DOMContentLoaded');
    } else {
        debugLog('ğŸ“„ æ–‡æ¡£å·²åŠ è½½å®Œæˆï¼Œç«‹å³åˆå§‹åŒ–');
        initializePage();
    }
    
    // åˆå§‹åŒ–WebChannelè¿æ¥
    function initializeWebChannel() {
        debugLog('ğŸš€ å¼€å§‹åˆå§‹åŒ–WebChannelè¿æ¥');
        
        if (typeof QWebChannel !== 'undefined' && window.qt && window.qt.webChannelTransport) {
            debugLog('âœ… QWebChannelå’Œtransportéƒ½å¯ç”¨');
            
            new QWebChannel(window.qt.webChannelTransport, function(channel) {
                debugLog('ğŸ‰ WebChannelè¿æ¥æˆåŠŸï¼');
                debugLog('ğŸ“‹ Channelå¯¹è±¡: exists');
                debugLog('ğŸ“‹ Channel.objects: ' + (channel.objects ? 'exists' : 'undefined'));
                
                window.bridge = channel.objects.bridge;
                debugLog('ğŸ”— Bridgeå¯¹è±¡è®¾ç½®å®Œæˆ: ' + (window.bridge ? 'success' : 'failed'));
                
                if (window.bridge) {
                    debugLog('âœ… Bridgeå¯¹è±¡å¯ç”¨ï¼Œå¼€å§‹åŠ è½½æ–‡ä»¶ç»“æ„');
                    try {
                        const methods = Object.getOwnPropertyNames(window.bridge);
                        debugLog('ğŸ“‹ Bridgeæ–¹æ³•åˆ—è¡¨: ' + methods.join(', '));
                    } catch (e) {
                        debugLog('ğŸ“‹ æ— æ³•è·å–Bridgeæ–¹æ³•åˆ—è¡¨: ' + e.message);
                    }
                    loadFileStructure();
                } else {
                    debugError('âŒ Bridgeå¯¹è±¡ä¸å¯ç”¨');
                    showError('WebChannelè¿æ¥å¤±è´¥ï¼šbridgeå¯¹è±¡ä¸å¯ç”¨');
                }
            });
        } else {
            debugError('âŒ WebChannelç¯å¢ƒä¸å®Œæ•´');
            debugLog('  - QWebChannel: ' + typeof QWebChannel);
            debugLog('  - window.qt: ' + (window.qt ? 'exists' : 'undefined'));
            debugLog('  - webChannelTransport: ' + (window.qt && window.qt.webChannelTransport ? 'exists' : 'undefined'));
            
            // ç›´æ¥å°è¯•åŠ è½½ï¼Œå¯èƒ½bridgeå·²ç»å¯ç”¨
            if (window.bridge) {
                debugLog('ğŸ”„ å‘ç°å·²æœ‰bridgeå¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨');
                loadFileStructure();
            } else {
                debugError('WebChannelåˆå§‹åŒ–å¤±è´¥');
                showError('WebChannelåˆå§‹åŒ–å¤±è´¥');
            }
        }
    }
    
    // ç­‰å¾…WebChannelåˆå§‹åŒ–
    function waitForBridge(callback, maxAttempts = 20) {
        let attempts = 0;
        const checkBridge = () => {
            attempts++;
            debugLog(`æ£€æŸ¥WebChannelè¿æ¥çŠ¶æ€ (${attempts}/${maxAttempts})`);
            debugLog('window.bridge: ' + (window.bridge ? 'exists' : 'undefined'));
            
            if (window.bridge && typeof window.bridge.getFileStructure === 'function') {
                debugLog('WebChannelè¿æ¥æˆåŠŸï¼Œæ‰€æœ‰æ–¹æ³•å¯ç”¨');
                callback();
            } else if (attempts < maxAttempts) {
                debugLog(`ç­‰å¾…WebChannelè¿æ¥... (${attempts}/${maxAttempts})`);
                setTimeout(checkBridge, 300);
            } else {
                debugError('WebChannelè¿æ¥è¶…æ—¶');
                const fileTree = document.getElementById('file-tree');
                if (fileTree) {
                    fileTree.innerHTML = `
                        <div class="text-center text-red-500 py-8">
                            <span class="material-icons-outlined text-4xl mb-2">error</span>
                            <p class="text-sm mb-2">WebChannelè¿æ¥å¤±è´¥</p>
                            <button class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700" onclick="location.reload()">
                                é‡æ–°åŠ è½½
                            </button>
                        </div>
                    `;
                }
                showError('ç³»ç»Ÿåˆå§‹åŒ–è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        };
        checkBridge();
    }
    
    // åŠ è½½æ–‡ä»¶ç»“æ„
    function loadFileStructure() {
        debugLog('=' + '='.repeat(79));
        debugLog('ğŸ” ã€æ­¥éª¤2ã€‘å‰ç«¯å¼€å§‹åŠ è½½æ–‡ä»¶ç»“æ„');
        debugLog('=' + '='.repeat(79));
        
        debugLog('ğŸ” æ£€æŸ¥bridgeå¯¹è±¡çŠ¶æ€:');
        debugLog('  - window.bridgeå­˜åœ¨: ' + (window.bridge ? 'YES' : 'NO'));
        debugLog('  - bridgeç±»å‹: ' + typeof window.bridge);
        debugLog('  - getFileStructureæ–¹æ³•å­˜åœ¨: ' + (window.bridge && typeof window.bridge.getFileStructure === 'function' ? 'YES' : 'NO'));
        
        if (!window.bridge || typeof window.bridge.getFileStructure !== 'function') {
            debugError('âŒ ç³»ç»Ÿæ¥å£æœªå‡†å¤‡å°±ç»ª');
            showError('ç³»ç»Ÿæ¥å£æœªå‡†å¤‡å°±ç»ªï¼Œè¯·ç¨åé‡è¯•');
            return;
        }

        debugLog('âœ… Bridgeå¯¹è±¡éªŒè¯é€šè¿‡ï¼Œå‡†å¤‡è°ƒç”¨getFileStructure');

        try {
            debugLog('ğŸš€ å¼€å§‹è°ƒç”¨Pythonçš„getFileStructureæ–¹æ³•...');
            
            // Qt WebChannelçš„è¿”å›å€¼å¯èƒ½æ˜¯Promiseï¼Œä¹Ÿå¯èƒ½ç›´æ¥æ˜¯ç»“æœï¼Œæˆ–è€…é€šè¿‡å›è°ƒè¿”å›
            // è¿™é‡Œé‡‡ç”¨æœ€å¥å£®çš„æ–¹å¼ï¼šä¼˜å…ˆä½¿ç”¨å›è°ƒï¼Œå¹¶æ£€æŸ¥è¿”å›å€¼
            let handled = false;
            let callStartTime = Date.now();

            const handleData = (jsonData) => {
                if (handled) {
                    debugLog('âš ï¸ æ•°æ®å·²å¤„ç†è¿‡ï¼Œè·³è¿‡é‡å¤å¤„ç†');
                    return;
                }
                handled = true;
                
                let callEndTime = Date.now();
                debugLog('ğŸ“¨ ã€æ­¥éª¤2ã€‘ä»Pythonæ¥æ”¶åˆ°æ•°æ®:');
                debugLog('  - è°ƒç”¨è€—æ—¶: ' + (callEndTime - callStartTime) + 'ms');
                debugLog('  - æ•°æ®ç±»å‹: ' + typeof jsonData);
                debugLog('  - æ•°æ®é•¿åº¦: ' + (jsonData ? jsonData.length : 'null'));
                debugLog('  - æ•°æ®ä¸ºç©º: ' + (!jsonData ? 'YES' : 'NO'));
                
                if (jsonData) {
                    debugLog('ğŸ“„ æ•°æ®é¢„è§ˆ (å‰200å­—ç¬¦):');
                    debugLog('  ' + String(jsonData).slice(0, 200) + (jsonData.length > 200 ? '...' : ''));
                }
                
                try {
                    debugLog('ğŸ”„ å¼€å§‹è§£æJSONæ•°æ®...');
                    const structure = JSON.parse(jsonData);
                    debugLog('âœ… JSONè§£ææˆåŠŸ!');
                    debugLog('  - ç»“æ„ç±»å‹: ' + typeof structure);
                    debugLog('  - æ˜¯å¦ä¸ºæ•°ç»„: ' + Array.isArray(structure));
                    debugLog('  - æ•°ç»„é•¿åº¦: ' + (Array.isArray(structure) ? structure.length : 'N/A'));
                    
                    if (Array.isArray(structure) && structure.length > 0) {
                        debugLog('ğŸ“‹ æ–‡ä»¶ç»“æ„å†…å®¹æ¦‚è§ˆ:');
                        structure.forEach((item, index) => {
                            debugLog(`  ${index + 1}. ${item.name} (${item.type}) - è·¯å¾„: ${item.path}`);
                            if (item.type === 'folder' && item.children) {
                                debugLog(`     â””â”€ å­é¡¹ç›®æ•°: ${item.children.length}`);
                            }
                        });
                    }
                    
                    debugLog('ğŸ¨ å‡†å¤‡æ¸²æŸ“æ–‡ä»¶æ ‘...');
                    renderFileTree(structure);
                    debugLog('âœ… ã€æ­¥éª¤2å®Œæˆã€‘æ–‡ä»¶ç»“æ„ä¼ é€’å’Œæ¸²æŸ“å®Œæˆ');
                    
                } catch (e) {
                    debugError('âŒ JSONè§£æå¤±è´¥: ' + e.message);
                    debugLog('âŒ è§£æå¤±è´¥çš„åŸå§‹æ•°æ®: ' + (jsonData ? String(jsonData).slice(0, 500) : 'null'));
                    showError('æ–‡ä»¶ç»“æ„è§£æå¤±è´¥: ' + e.message);
                }
            };

            debugLog('ğŸ“ æ­£åœ¨è°ƒç”¨bridge.getFileStructure...');
            const result = window.bridge.getFileStructure(handleData);
            debugLog('ğŸ“ getFileStructureè°ƒç”¨å®Œæˆï¼Œè¿”å›å€¼ç±»å‹: ' + typeof result);

            // å¦‚æœè¿”å›å€¼æ˜¯Promise
            if (result && typeof result.then === 'function') {
                debugLog('ğŸ”„ æ£€æµ‹åˆ°Promiseè¿”å›å€¼ï¼Œç­‰å¾…å¼‚æ­¥ç»“æœ...');
                result.then(data => {
                    debugLog('âœ… Promise resolvedï¼Œæ•°æ®ç±»å‹: ' + typeof data);
                    handleData(data);
                }).catch(error => {
                    debugError('âŒ Promise rejected: ' + error);
                    showError('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + error);
                });
            } 
            // å¦‚æœç›´æ¥è¿”å›äº†å­—ç¬¦ä¸²
            else if (typeof result === 'string') {
                debugLog('ğŸ“„ æ£€æµ‹åˆ°ç›´æ¥è¿”å›å­—ç¬¦ä¸²ï¼Œé•¿åº¦: ' + result.length);
                handleData(result);
            }
            // å¦‚æœè¿”å›undefinedæˆ–null
            else if (result === undefined || result === null) {
                debugLog('âš ï¸ è¿”å›å€¼ä¸ºç©ºï¼Œç­‰å¾…å›è°ƒå¤„ç†...');
            }
            // å…¶ä»–ç±»å‹
            else {
                debugLog('âš ï¸ æœªçŸ¥è¿”å›å€¼ç±»å‹: ' + typeof result + ', å€¼: ' + result);
            }

        } catch (e) {
            debugError('âŒ è°ƒç”¨getFileStructureæ—¶å‘ç”Ÿå¼‚å¸¸: ' + e.message);
            debugError('âŒ å¼‚å¸¸å †æ ˆ: ' + e.stack);
            showError('è°ƒç”¨æ–‡ä»¶åˆ—è¡¨æ¥å£å¤±è´¥: ' + e.message);
        }
        
        debugLog('=' + '='.repeat(79));
        debugLog('ğŸ ã€æ­¥éª¤2ã€‘loadFileStructureå‡½æ•°æ‰§è¡Œå®Œæˆ');
        debugLog('=' + '='.repeat(79));
    }
    
    // å¤„ç†æ–‡ä»¶ç»“æ„æ•°æ®
    function handleFileStructureData(structureJson) {
        debugLog('ğŸ“„ å¤„ç†æ–‡ä»¶ç»“æ„æ•°æ®:');
        debugLog('  - æ•°æ®ç±»å‹: ' + typeof structureJson);
        debugLog('  - æ•°æ®é•¿åº¦: ' + (structureJson ? structureJson.length : 'null'));
        
        try {
            const structure = JSON.parse(structureJson);
            debugLog('âœ… JSONè§£ææˆåŠŸï¼Œç»“æ„æ•°ç»„é•¿åº¦: ' + structure.length);
            renderFileTree(structure);
        } catch (e) {
            debugError('âŒ JSONè§£æå¤±è´¥: ' + e.message);
            debugLog('âŒ åŸå§‹æ•°æ®ç‰‡æ®µ: ' + (structureJson ? String(structureJson).slice(0, 200) + '...' : 'null'));
            showError('è§£ææ–‡ä»¶ç»“æ„å¤±è´¥: ' + e.message);
        }
    }
    
    // æ¸²æŸ“æ–‡ä»¶æ ‘
    function renderFileTree(structure) {
        debugLog('ğŸ¨ ã€æ­¥éª¤2-æ¸²æŸ“ã€‘å¼€å§‹æ¸²æŸ“æ–‡ä»¶æ ‘');
        debugLog('  - æ¥æ”¶åˆ°çš„ç»“æ„ç±»å‹: ' + typeof structure);
        debugLog('  - æ˜¯å¦ä¸ºæ•°ç»„: ' + Array.isArray(structure));
        debugLog('  - ç»“æ„é•¿åº¦: ' + (structure ? structure.length : 'null'));
        
        const fileTree = document.getElementById('file-tree');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        debugLog('ğŸ” æ£€æŸ¥DOMå…ƒç´ :');
        debugLog('  - fileTreeå…ƒç´ å­˜åœ¨: ' + (fileTree ? 'YES' : 'NO'));
        debugLog('  - loadingIndicatorå­˜åœ¨: ' + (loadingIndicator ? 'YES' : 'NO'));
        
        if (loadingIndicator) {
            loadingIndicator.remove();
            debugLog('âœ… å·²ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨');
        }
        
        if (structure && structure.length > 0) {
            debugLog('ğŸ“‹ å‡†å¤‡æ„å»ºHTMLï¼Œç»“æ„æ¦‚è§ˆ:');
            structure.forEach((item, index) => {
                debugLog(`  ${index + 1}. ${item.name} (${item.type})`);
            });
            
            debugLog('ğŸ—ï¸ å¼€å§‹æ„å»ºæ ‘å½¢HTML...');
            const htmlContent = buildTreeHTML(structure);
            debugLog('âœ… HTMLæ„å»ºå®Œæˆï¼Œé•¿åº¦: ' + htmlContent.length + ' å­—ç¬¦');
            debugLog('ğŸ“„ HTMLé¢„è§ˆ (å‰300å­—ç¬¦):');
            debugLog('  ' + htmlContent.slice(0, 300) + (htmlContent.length > 300 ? '...' : ''));
            
            debugLog('ğŸ¯ è®¾ç½®fileTreeçš„innerHTML...');
            fileTree.innerHTML = htmlContent;
            debugLog('âœ… æ–‡ä»¶æ ‘DOMæ›´æ–°å®Œæˆ');
            
            // éªŒè¯æ¸²æŸ“ç»“æœ
            const renderedItems = fileTree.querySelectorAll('.file-item, .folder-item');
            debugLog('ğŸ” æ¸²æŸ“éªŒè¯:');
            debugLog('  - DOMä¸­çš„é¡¹ç›®æ•°: ' + renderedItems.length);
            debugLog('  - fileTreeå­å…ƒç´ æ•°: ' + fileTree.children.length);
            
        } else {
            debugLog('âš ï¸ æ–‡ä»¶ç»“æ„ä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€é¡µé¢');
            fileTree.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <span class="material-icons-outlined text-4xl mb-2 text-gray-300">folder_open</span>
                    <p class="text-sm">vaultç›®å½•ä¸ºç©º</p>
                    <button class="mt-2 px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700" onclick="createNewNote()">
                        åˆ›å»ºç¬¬ä¸€ä¸ªç¬”è®°
                    </button>
                </div>
            `;
            debugLog('âœ… ç©ºçŠ¶æ€é¡µé¢å·²è®¾ç½®');
        }
        
        debugLog('ğŸ‰ ã€æ­¥éª¤2-æ¸²æŸ“å®Œæˆã€‘æ–‡ä»¶æ ‘æ¸²æŸ“æµç¨‹ç»“æŸ');
    }
    
    // æ„å»ºæ ‘å½¢HTML - å®Œå…¨æŒ‰ç…§ç¬”è®°.htmlçš„ç»“æ„
    function buildTreeHTML(items, level = 0) {
        let html = '';
        items.forEach(item => {
            if (item.type === 'folder') {
                const hasChildren = item.children && item.children.length > 0;
                const expandIcon = hasChildren ? 'chevron_right' : '';
                
                html += `
                <li>
                    <div class="flex items-center p-2 rounded-md hover:bg-bg-light-gray cursor-pointer" 
                         onclick="toggleFolder(this)" 
                         oncontextmenu="showContextMenu(event, '${item.path}', 'folder')">
                        <span class="material-icons-outlined text-yellow-500 mr-2 folder-icon">folder</span>
                        <span class="text-text-dark-brown font-medium">${item.name}</span>
                        ${expandIcon ? `<span class="material-icons-outlined text-text-gray ml-auto expand-icon">${expandIcon}</span>` : ''}
                    </div>
                    ${hasChildren ? `<ul class="pl-6 mt-1 space-y-1 folder-content hidden">${buildTreeHTML(item.children, level + 1)}</ul>` : ''}
                </li>`;
            } else if (item.type === 'file') {
                html += `
                <li>
                    <div class="flex items-center p-2 rounded-md hover:bg-bg-light-gray cursor-pointer" 
                         onclick="selectFile('${item.path}', '${item.name}')"
                         oncontextmenu="showContextMenu(event, '${item.path}', 'file')">
                        <span class="material-icons-outlined text-primary mr-2">description</span>
                        <span class="text-text-medium-brown">${item.name}</span>
                    </div>
                </li>`;
            }
        });
        return html;
    }
    
    // åˆ‡æ¢æ–‡ä»¶å¤¹å±•å¼€/æŠ˜å  - ä¸ç¬”è®°.htmlä¿æŒä¸€è‡´
    function toggleFolder(element) {
        const content = element.nextElementSibling;
        const expandIcon = element.querySelector('.expand-icon');
        const folderIcon = element.querySelector('.folder-icon');
        
        if (content && content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            if (expandIcon) expandIcon.textContent = 'expand_more';
            if (folderIcon) folderIcon.textContent = 'folder_open';
        } else if (content) {
            content.classList.add('hidden');
            if (expandIcon) expandIcon.textContent = 'chevron_right';
            if (folderIcon) folderIcon.textContent = 'folder';
        }
    }
    
    
    // åŠ è½½æ–‡ä»¶å†…å®¹
    function loadFileContent(filePath) {
        if (!window.bridge) {
            showError('ç³»ç»Ÿæœªåˆå§‹åŒ–');
            return;
        }
        
        // éšè—ç©ºçŠ¶æ€
        document.getElementById('empty-state').classList.add('hidden');
        
        if (currentMode === 'preview') {
            // é¢„è§ˆæ¨¡å¼ - åŠ è½½HTMLå†…å®¹
            window.bridge.loadMarkdownFile(filePath).then(function(htmlContent) {
                const previewContent = document.getElementById('preview-content');
                previewContent.innerHTML = htmlContent;
                previewContent.classList.remove('hidden');
                document.getElementById('edit-content').classList.add('hidden');
            }).catch(function(error) {
                debugError('åŠ è½½é¢„è§ˆå†…å®¹å¤±è´¥:', error);
                showError('åŠ è½½æ–‡ä»¶å¤±è´¥');
            });
        } else {
            // ç¼–è¾‘æ¨¡å¼ - åŠ è½½åŸå§‹Markdownå†…å®¹
            window.bridge.loadMarkdownRaw(filePath).then(function(rawContent) {
                const editor = document.getElementById('markdown-editor');
                editor.value = rawContent;
                document.getElementById('edit-content').classList.remove('hidden');
                document.getElementById('preview-content').classList.add('hidden');
            }).catch(function(error) {
                debugError('åŠ è½½ç¼–è¾‘å†…å®¹å¤±è´¥:', error);
                showError('åŠ è½½æ–‡ä»¶å¤±è´¥');
            });
        }
    }
    
    // åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼ - ä¸ç¬”è®°.htmlä¿æŒä¸€è‡´çš„æŒ‰é’®æ ·å¼
    function switchToPreview() {
        currentMode = 'preview';
        document.getElementById('preview-btn').className = 'flex items-center bg-white border border-gray-300 px-3 py-1.5 rounded-lg text-text-gray hover:bg-gray-100';
        document.getElementById('edit-btn').className = 'flex items-center bg-primary text-white px-3 py-1.5 rounded-lg hover:bg-green-600';
        
        if (currentFilePath) {
            loadFileContent(currentFilePath);
        }
    }
    
    // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼ - ä¸ç¬”è®°.htmlä¿æŒä¸€è‡´çš„æŒ‰é’®æ ·å¼
    function switchToEdit() {
        currentMode = 'edit';
        document.getElementById('preview-btn').className = 'flex items-center bg-primary text-white px-3 py-1.5 rounded-lg hover:bg-green-600';
        document.getElementById('edit-btn').className = 'flex items-center bg-white border border-gray-300 px-3 py-1.5 rounded-lg text-text-gray hover:bg-gray-100';
        
        if (currentFilePath) {
            loadFileContent(currentFilePath);
        }
    }
    
    // é€‰æ‹©æ–‡ä»¶ - ä¸ç¬”è®°.htmlä¿æŒä¸€è‡´
    function selectFile(filePath, fileName) {
        debugLog(`é€‰æ‹©æ–‡ä»¶: ${fileName}`);
        
        // æ›´æ–°å½“å‰æ–‡ä»¶ä¿¡æ¯
        currentFilePath = filePath;
        document.getElementById('current-file-title').textContent = fileName;
        
        // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.file-item .flex').forEach(el => {
            el.classList.remove('bg-bg-light-green');
            el.querySelector('span:last-child').classList.remove('text-primary', 'font-semibold');
            el.querySelector('span:last-child').classList.add('text-text-medium-brown');
        });
        
        // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
        const selectedElement = document.querySelector(`[data-path="${filePath}"] .flex`);
        if (selectedElement) {
            selectedElement.classList.add('bg-bg-light-green');
            const textSpan = selectedElement.querySelector('span:last-child');
            textSpan.classList.remove('text-text-medium-brown');
            textSpan.classList.add('text-primary', 'font-semibold');
        }
        
        // åŠ è½½æ–‡ä»¶å†…å®¹
        loadFileContent(filePath);
    }
    
    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    function showError(message) {
        debugError(message);
        // è¿™é‡Œå¯ä»¥æ·»åŠ Toasté€šçŸ¥æˆ–å…¶ä»–é”™è¯¯æ˜¾ç¤ºæ–¹å¼
        alert('é”™è¯¯: ' + message);
    }
    
    // åˆ›å»ºæ–°ç¬”è®°
    function createNewNote() {
        debugLog('åˆ›å»ºæ–°ç¬”è®°');
        
        waitForBridge(function() {
            // ç¡®å®šåˆ›å»ºä½ç½®
            let targetPath = 'vault';
            if (selectedTreeItem && selectedTreeItem.type === 'folder') {
                targetPath = selectedTreeItem.path;
            }
            
            window.bridge.createNewNote(targetPath).then(function(success) {
                if (success) {
                    debugLog('æ–°ç¬”è®°åˆ›å»ºæˆåŠŸ');
                    // é‡æ–°åŠ è½½æ–‡ä»¶æ ‘
                    loadFileStructure();
                    showSuccess('æ–°ç¬”è®°åˆ›å»ºæˆåŠŸ');
                } else {
                    showError('åˆ›å»ºæ–°ç¬”è®°å¤±è´¥');
                }
            }).catch(function(error) {
                debugError('åˆ›å»ºæ–°ç¬”è®°å¤±è´¥: ' + (error && (error.message || error.toString())));
                showError('åˆ›å»ºæ–°ç¬”è®°å¤±è´¥: ' + (error && error.message ? error.message : 'æœªçŸ¥é”™è¯¯'));
            });
        });
    }
    
    // åˆ›å»ºæ–°æ–‡ä»¶å¤¹
    function createNewFolder() {
        debugLog('åˆ›å»ºæ–°æ–‡ä»¶å¤¹');
        
        waitForBridge(function() {
            // ç¡®å®šåˆ›å»ºä½ç½®
            let targetPath = 'vault';
            if (selectedTreeItem && selectedTreeItem.type === 'folder') {
                targetPath = selectedTreeItem.path;
            }
            
            window.bridge.createNewFolder(targetPath).then(function(success) {
                if (success) {
                    debugLog('æ–°æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ');
                    // é‡æ–°åŠ è½½æ–‡ä»¶æ ‘
                    loadFileStructure();
                    showSuccess('æ–°æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ');
                } else {
                    showError('åˆ›å»ºæ–°æ–‡ä»¶å¤¹å¤±è´¥');
                }
            }).catch(function(error) {
                debugError('åˆ›å»ºæ–°æ–‡ä»¶å¤¹å¤±è´¥: ' + (error && (error.message || error.toString())));
                showError('åˆ›å»ºæ–°æ–‡ä»¶å¤¹å¤±è´¥: ' + (error && error.message ? error.message : 'æœªçŸ¥é”™è¯¯'));
            });
        });
    }
    
    // ä¿å­˜å½“å‰æ–‡ä»¶
    function saveCurrentFile() {
        if (!currentFilePath || currentMode !== 'edit') {
            return;
        }
        
        const editor = document.getElementById('markdown-editor');
        const content = editor.value;
        
        if (!window.bridge) {
            showError('ç³»ç»Ÿæœªåˆå§‹åŒ–');
            return;
        }
        
        window.bridge.saveMarkdownFile(currentFilePath, content).then(function(success) {
            if (success) {
                debugLog('æ–‡ä»¶ä¿å­˜æˆåŠŸ');
                showSuccess('æ–‡ä»¶ä¿å­˜æˆåŠŸ');
                
                // å¦‚æœå½“å‰æ˜¯é¢„è§ˆæ¨¡å¼ï¼Œé‡æ–°åŠ è½½é¢„è§ˆå†…å®¹
                if (currentMode === 'preview') {
                    loadFileContent(currentFilePath);
                }
            } else {
                showError('æ–‡ä»¶ä¿å­˜å¤±è´¥');
            }
        }).catch(function(error) {
            debugError('æ–‡ä»¶ä¿å­˜å¤±è´¥:', error);
            showError('æ–‡ä»¶ä¿å­˜å¤±è´¥');
        });
    }
    
    // æå–çŸ¥è¯†ç‚¹
    function extractKnowledgePoints() {
        if (!currentFilePath) {
            return;
        }
        
        debugLog('æå–çŸ¥è¯†ç‚¹:', currentFilePath);
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const btn = document.getElementById('extract-knowledge-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="animate-spin material-icons-outlined text-sm mr-1">refresh</span>æå–ä¸­...';
        btn.disabled = true;
        
        if (window.bridge && window.bridge.extractKnowledgePoints) {
            window.bridge.extractKnowledgePoints(currentFilePath).then(function(result) {
                debugLog('çŸ¥è¯†ç‚¹æå–ç»“æœ:', result);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                if (result) {
                    try {
                        const knowledgePoints = JSON.parse(result);
                        displayKnowledgePoints(knowledgePoints);
                    } catch (e) {
                    }
                } else {
                }
            }).catch(function(error) {
            });
        } else {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
    
    // æ˜¾ç¤ºçŸ¥è¯†ç‚¹
    function displayKnowledgePoints(knowledgePoints) {
        const container = document.getElementById('knowledge-points');
        const noPointsMsg = document.getElementById('no-knowledge-points');
        
        if (noPointsMsg) {
            noPointsMsg.remove();
        }
        
        if (!knowledgePoints || knowledgePoints.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <span class="material-icons-outlined text-4xl mb-2 text-gray-300">lightbulb_outline</span>
                    <p class="text-sm">æœªæ‰¾åˆ°çŸ¥è¯†ç‚¹</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        knowledgePoints.forEach((point, index) => {
            html += `
                <div class="knowledge-card bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-3 cursor-pointer">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800 text-sm mb-1">${point.title || `çŸ¥è¯†ç‚¹ ${index + 1}`}</h4>
                            <p class="text-xs text-gray-600 leading-relaxed">${point.content || point.description || 'æš‚æ— æè¿°'}</p>
                        </div>
                        <div class="ml-2 flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="text-gray-400 hover:text-blue-600 text-xs" title="ç¼–è¾‘" onclick="editKnowledgePoint(${index})">
                                <span class="material-icons-outlined" style="font-size: 14px;">edit</span>
                            </button>
                            <button class="text-gray-400 hover:text-red-600 text-xs" title="åˆ é™¤" onclick="deleteKnowledgePoint(${index})">
                                <span class="material-icons-outlined" style="font-size: 14px;">delete</span>
                            </button>
                        </div>
                    </div>
                    ${point.keywords ? `
                        <div class="mt-2 flex flex-wrap gap-1">
                            ${point.keywords.map(keyword => `
                                <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full">${keyword}</span>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    function showSuccess(message) {
        showToast(message, 'success');
    }
    
    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
    function showError(message) {
        showToast(message, 'error');
    }
    
    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    function showToast(message, type = 'info') {
        // åˆ›å»ºtoastå…ƒç´ 
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white text-sm font-medium z-50 transform transition-all duration-300 translate-x-full opacity-0`;
        
        if (type === 'success') {
            toast.classList.add('bg-green-600');
        } else if (type === 'error') {
            toast.classList.add('bg-red-600');
        } else {
            toast.classList.add('bg-blue-600');
        }
        
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // æ˜¾ç¤ºåŠ¨ç”»
        setTimeout(() => {
            toast.classList.remove('translate-x-full', 'opacity-0');
        }, 100);
        
        // è‡ªåŠ¨éšè—
        setTimeout(() => {
            toast.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }
    
    // æ‹–æ”¾åŠŸèƒ½å˜é‡
    let draggedElement = null;
    let draggedPath = null;
    let draggedType = null;
    
    // æ·»åŠ æ‹–æ”¾äº‹ä»¶ç›‘å¬
    function addDragDropListeners() {
        // ä¸ºæ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹é¡¹æ·»åŠ æ‹–æ”¾åŠŸèƒ½
        document.querySelectorAll('.file-item, .folder-item').forEach(item => {
            const element = item.querySelector('.flex');
            if (element) {
                element.draggable = true;
                element.addEventListener('dragstart', handleDragStart);
                element.addEventListener('dragend', handleDragEnd);
            }
        });
        
        // ä¸ºæ–‡ä»¶å¤¹æ·»åŠ æ‹–æ”¾ç›®æ ‡åŠŸèƒ½
        document.querySelectorAll('.folder-item').forEach(folder => {
            const element = folder.querySelector('.flex');
            if (element) {
                element.addEventListener('dragover', handleDragOver);
                element.addEventListener('drop', handleDrop);
                element.addEventListener('dragenter', handleDragEnter);
                element.addEventListener('dragleave', handleDragLeave);
            }
        });
    }
    
    
    // æ‹–æ‹½æ‚¬åœ
    function handleDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
    }
    
    // æ‹–æ‹½è¿›å…¥
    function handleDragEnter(event) {
        event.preventDefault();
        const targetItem = event.currentTarget.closest('.folder-item');
        if (targetItem && targetItem.dataset.path !== draggedPath) {
            event.currentTarget.classList.add('drag-over', 'bg-green-100', 'border-green-300');
        }
    }
    
    // æ‹–æ‹½ç¦»å¼€
    function handleDragLeave(event) {
        // æ£€æŸ¥æ˜¯å¦çœŸçš„ç¦»å¼€äº†ç›®æ ‡åŒºåŸŸ
        const rect = event.currentTarget.getBoundingClientRect();
        const x = event.clientX;
        const y = event.clientY;
        
        if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
            event.currentTarget.classList.remove('drag-over', 'bg-green-100', 'border-green-300');
        }
    }
    
    // æ‹–æ‹½æ”¾ä¸‹
    function handleDrop(event) {
        event.preventDefault();
        
        const targetItem = event.currentTarget.closest('.folder-item');
        const targetPath = targetItem.dataset.path;
        
        // ç§»é™¤æ‹–æ”¾æ ·å¼
        event.currentTarget.classList.remove('drag-over', 'bg-green-100', 'border-green-300');
        
        if (draggedPath && targetPath && draggedPath !== targetPath) {
            debugLog('ç§»åŠ¨æ–‡ä»¶:', draggedPath, 'åˆ°', targetPath);
            moveFileOrFolder(draggedPath, targetPath);
        }
    }
    
    // ç§»åŠ¨æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
    function moveFileOrFolder(sourcePath, targetPath) {
        if (!window.bridge || !window.bridge.moveFileOrFolder) {
            showError('ç§»åŠ¨åŠŸèƒ½ä¸å¯ç”¨');
            return;
        }
        
        window.bridge.moveFileOrFolder(sourcePath, targetPath).then(function(success) {
            if (success) {
                debugLog('æ–‡ä»¶ç§»åŠ¨æˆåŠŸ');
                showSuccess('æ–‡ä»¶ç§»åŠ¨æˆåŠŸ');
                // é‡æ–°åŠ è½½æ–‡ä»¶æ ‘
                loadFileStructure();
            } else {
                showError('æ–‡ä»¶ç§»åŠ¨å¤±è´¥');
            }
        }).catch(function(error) {
            debugError('æ–‡ä»¶ç§»åŠ¨å¤±è´¥:', error);
            showError('æ–‡ä»¶ç§»åŠ¨å¤±è´¥');
        });
    }
    
    // å³é”®èœå•åŠŸèƒ½
    function showContextMenu(event, path, type) {
        event.preventDefault();
        
        // ç§»é™¤ç°æœ‰çš„å³é”®èœå•
        const existingMenu = document.getElementById('context-menu');
        if (existingMenu) {
            existingMenu.remove();
        }
        
        // åˆ›å»ºå³é”®èœå•
        const menu = document.createElement('div');
        menu.id = 'context-menu';
        menu.className = 'fixed bg-white border border-gray-200 rounded-lg shadow-lg py-2 z-50';
        menu.style.left = event.pageX + 'px';
        menu.style.top = event.pageY + 'px';
        
        const menuItems = [
            { text: 'é‡å‘½å', icon: 'edit', action: () => showRenameDialog(path, type) },
            { text: 'åˆ é™¤', icon: 'delete', action: () => showDeleteDialog(path, type) },
            { text: '---', divider: true },
            { text: 'æ–°å»ºç¬”è®°', icon: 'note_add', action: () => createNewNote(type === 'folder' ? path : path.substring(0, path.lastIndexOf('/'))) },
            { text: 'æ–°å»ºæ–‡ä»¶å¤¹', icon: 'create_new_folder', action: () => createNewFolder(type === 'folder' ? path : path.substring(0, path.lastIndexOf('/'))) }
        ];
        
        menuItems.forEach(item => {
            if (item.divider) {
                const divider = document.createElement('div');
                divider.className = 'border-t border-gray-200 my-1';
                menu.appendChild(divider);
            } else {
                const menuItem = document.createElement('div');
                menuItem.className = 'flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer';
                menuItem.innerHTML = `
                    <span class="material-icons-outlined text-sm mr-2">${item.icon}</span>
                    ${item.text}
                `;
                menuItem.onclick = () => {
                    item.action();
                    menu.remove();
                };
                menu.appendChild(menuItem);
            }
        });
        
        document.body.appendChild(menu);
        
        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
        setTimeout(() => {
            document.addEventListener('click', function closeMenu() {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            });
        }, 100);
    }
    
    // æ˜¾ç¤ºé‡å‘½åå¯¹è¯æ¡†
    function showRenameDialog(path, type) {
        const fileName = path.split('/').pop();
        const newName = prompt(`é‡å‘½å${type === 'folder' ? 'æ–‡ä»¶å¤¹' : 'æ–‡ä»¶'}:`, fileName);
        
        if (newName && newName !== fileName) {
            renameFileOrFolder(path, newName);
        }
    }
    
    // é‡å‘½åæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
    function renameFileOrFolder(oldPath, newName) {
        if (!window.bridge || !window.bridge.renameFileOrFolder) {
            showError('é‡å‘½ååŠŸèƒ½ä¸å¯ç”¨');
            return;
        }
        
        window.bridge.renameFileOrFolder(oldPath, newName).then(function(success) {
            if (success) {
                debugLog('é‡å‘½åæˆåŠŸ');
                showSuccess('é‡å‘½åæˆåŠŸ');
                // é‡æ–°åŠ è½½æ–‡ä»¶æ ‘
                loadFileStructure();
            } else {
                showError('é‡å‘½åå¤±è´¥ï¼Œå¯èƒ½æ–‡ä»¶åå·²å­˜åœ¨');
            }
        }).catch(function(error) {
            debugError('é‡å‘½åå¤±è´¥:', error);
            showError('é‡å‘½åå¤±è´¥');
        });
    }
    
    // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
    function showDeleteDialog(path, type) {
        const fileName = path.split('/').pop();
        const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤${type === 'folder' ? 'æ–‡ä»¶å¤¹' : 'æ–‡ä»¶'} "${fileName}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`);
        
        if (confirmed) {
            deleteFileOrFolder(path);
        }
    }
    
    // åˆ é™¤æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
    function deleteFileOrFolder(path) {
        if (!window.bridge || !window.bridge.deleteFileOrFolder) {
            showError('åˆ é™¤åŠŸèƒ½ä¸å¯ç”¨');
            return;
        }
        
        window.bridge.deleteFileOrFolder(path).then(function(success) {
            if (success) {
                debugLog('åˆ é™¤æˆåŠŸ');
                showSuccess('åˆ é™¤æˆåŠŸ');
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ‰“å¼€çš„æ–‡ä»¶ï¼Œæ¸…ç©ºå†…å®¹åŒº
                if (currentFilePath === path) {
                    currentFilePath = null;
                    document.getElementById('current-file-title').textContent = 'é€‰æ‹©æ–‡ä»¶å¼€å§‹å­¦ä¹ ';
                    document.getElementById('empty-state').classList.remove('hidden');
                    document.getElementById('preview-content').classList.add('hidden');
                    document.getElementById('edit-content').classList.add('hidden');
                    document.getElementById('extract-knowledge-btn').disabled = true;
                    document.getElementById('save-btn').disabled = true;
                }
                // é‡æ–°åŠ è½½æ–‡ä»¶æ ‘
                loadFileStructure();
            } else {
                showError('åˆ é™¤å¤±è´¥');
            }
        }).catch(function(error) {
            debugError('åˆ é™¤å¤±è´¥:', error);
            showError('åˆ é™¤å¤±è´¥');
        });
    }
    
    // çŸ¥è¯†ç‚¹ç®¡ç†åŠŸèƒ½
    let currentKnowledgePoints = [];
    
    // ç¼–è¾‘çŸ¥è¯†ç‚¹
    function editKnowledgePoint(index) {
        const point = currentKnowledgePoints[index];
        const newTitle = prompt('ç¼–è¾‘çŸ¥è¯†ç‚¹æ ‡é¢˜:', point.title || '');
        if (newTitle !== null && newTitle !== point.title) {
            currentKnowledgePoints[index].title = newTitle;
            displayKnowledgePoints(currentKnowledgePoints);
            showSuccess('çŸ¥è¯†ç‚¹å·²æ›´æ–°');
        }
    }
    
    // åˆ é™¤çŸ¥è¯†ç‚¹
    function deleteKnowledgePoint(index) {
        const point = currentKnowledgePoints[index];
        const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤çŸ¥è¯†ç‚¹ "${point.title || 'æœªå‘½å'}" å—ï¼Ÿ`);
        if (confirmed) {
            currentKnowledgePoints.splice(index, 1);
            displayKnowledgePoints(currentKnowledgePoints);
            showSuccess('çŸ¥è¯†ç‚¹å·²åˆ é™¤');
        }
    }
    
    // æ›´æ–°æ˜¾ç¤ºçŸ¥è¯†ç‚¹å‡½æ•°ï¼Œä¿å­˜å½“å‰æ•°æ®
    const originalDisplayKnowledgePoints = displayKnowledgePoints;
    displayKnowledgePoints = function(knowledgePoints) {
        currentKnowledgePoints = knowledgePoints || [];
        originalDisplayKnowledgePoints(knowledgePoints);
    };
    
    // ä¼˜åŒ–æ‹–æ‹½æ ·å¼
    function handleDragStart(event) {
        draggedElement = event.currentTarget;
        const item = draggedElement.closest('.file-item, .folder-item');
        draggedPath = item.dataset.path;
        draggedType = item.classList.contains('file-item') ? 'file' : 'folder';
        
        // è®¾ç½®æ‹–æ‹½æ•ˆæœ
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', draggedPath);
        
        // æ·»åŠ æ‹–æ‹½æ ·å¼
        draggedElement.classList.add('dragging');
        
        debugLog('å¼€å§‹æ‹–æ‹½:', draggedPath, draggedType);
    }
    
    // ä¼˜åŒ–æ‹–æ‹½ç»“æŸ
    function handleDragEnd(event) {
        // ç§»é™¤æ‹–æ‹½æ ·å¼
        if (draggedElement) {
            draggedElement.classList.remove('dragging');
        }
        
        // æ¸…ç†æ‹–æ”¾ç›®æ ‡æ ·å¼
        document.querySelectorAll('.drag-over').forEach(el => {
            el.classList.remove('drag-over');
        });
        
        draggedElement = null;
        draggedPath = null;
        draggedType = null;
    }
    
    // ä¼˜åŒ–æ–‡ä»¶é€‰æ‹©
    function selectFile(filePath, fileName) {
        debugLog('é€‰æ‹©æ–‡ä»¶:', filePath);
        
        // æ›´æ–°é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.file-item .flex, .folder-item .flex').forEach(el => {
            el.classList.remove('selected');
        });
        
        const selectedElement = document.querySelector(`[data-path="${filePath}"] .flex`);
        if (selectedElement) {
            selectedElement.classList.add('selected');
        }
        
        currentFilePath = filePath;
        
        // æ›´æ–°æ ‡é¢˜
        document.getElementById('current-file-title').textContent = fileName;
        
        // å¯ç”¨æŒ‰é’®
        document.getElementById('extract-knowledge-btn').disabled = false;
        document.getElementById('save-btn').disabled = false;
        
        // åŠ è½½æ–‡ä»¶å†…å®¹
        loadFileContent(filePath);
    }
    
    // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
    document.addEventListener('keydown', function(event) {
        // Ctrl+S ä¿å­˜æ–‡ä»¶
        if (event.ctrlKey && event.key === 's') {
            event.preventDefault();
            if (currentFilePath && currentMode === 'edit') {
                saveCurrentFile();
            }
        }
        
        // Ctrl+N æ–°å»ºç¬”è®°
        if (event.ctrlKey && event.key === 'n') {
            event.preventDefault();
            createNewNote();
        }
        
        // F2 é‡å‘½åï¼ˆå¦‚æœæœ‰é€‰ä¸­çš„æ–‡ä»¶ï¼‰
        if (event.key === 'F2' && currentFilePath) {
            event.preventDefault();
            const fileName = currentFilePath.split('/').pop();
            showRenameDialog(currentFilePath, currentFilePath.includes('.') ? 'file' : 'folder');
        }
    });
    
    // åˆ›å»ºæ–°æ–‡ä»¶å¤¹
    function createNewFolder() {
        debugLog('åˆ›å»ºæ–°æ–‡ä»¶å¤¹');
        
        if (!window.bridge) {
            showError('ç³»ç»Ÿæœªåˆå§‹åŒ–');
            return;
        }
        
        const folderName = prompt('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°:', 'æ–°æ–‡ä»¶å¤¹');
        if (folderName) {
            window.bridge.createNewFolder(folderName).then(function(result) {
                debugLog('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ');
                loadFileStructure(); // é‡æ–°åŠ è½½æ–‡ä»¶æ ‘
            }).catch(function(error) {
                debugError('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥:', error);
                showError('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥');
            });
        }
    }
    
    // ä¿å­˜Markdownæ–‡ä»¶
    function saveMarkdownFile() {
        if (!currentFilePath || !window.bridge) {
            showError('æ— æ³•ä¿å­˜æ–‡ä»¶');
            return;
        }
        
        const content = document.getElementById('markdown-editor').value;
        window.bridge.saveMarkdownFile(currentFilePath, content).then(function(result) {
            debugLog('æ–‡ä»¶ä¿å­˜æˆåŠŸ');
            // å¦‚æœå½“å‰æ˜¯é¢„è§ˆæ¨¡å¼ï¼Œé‡æ–°åŠ è½½é¢„è§ˆå†…å®¹
            if (currentMode === 'preview') {
                loadFileContent(currentFilePath);
            }
        }).catch(function(error) {
            debugError('ä¿å­˜æ–‡ä»¶å¤±è´¥:', error);
            showError('ä¿å­˜æ–‡ä»¶å¤±è´¥');
        });
    }
    
    // å³é”®èœå•åŠŸèƒ½ï¼ˆå ä½ç¬¦ï¼‰
    function showContextMenu(event, path, type) {
        event.preventDefault();
        debugLog(`å³é”®èœå•: ${type} - ${path}`);
        // è¿™é‡Œå¯ä»¥å®ç°å³é”®èœå•åŠŸèƒ½
    }
    
    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    function showError(message) {
        debugError(message);
        alert('é”™è¯¯: ' + message);
    }
    
    // æ›´æ–°æ¸²æŸ“æ–‡ä»¶æ ‘å‡½æ•°ï¼Œæ·»åŠ æ‹–æ”¾ç›‘å¬
    
    })(); // IIFEç»“æŸ
</script>
