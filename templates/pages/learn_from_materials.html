<!-- ä»èµ„æ–™å­¦ä¹ é¡µé¢ - å®Œæ•´çš„æ ‘å½¢æ–‡ä»¶ç®¡ç† -->
<style>
    /* ä¾§è¾¹æ æ”¶ç¼©æ ·å¼ */
    #sidebar.collapsed .sidebar-text,
    #sidebar.collapsed #user-profile,
    #sidebar.collapsed .logo-text {
        display: none;
    }
    #sidebar.collapsed .nav-item-icon {
        margin-right: 0;
    }
    #sidebar.collapsed .nav-link {
        justify-content: center;
    }
    
    /* æ–‡ä»¶æ ‘æ ·å¼ */
    .file-item-content {
        transition: all 0.2s ease;
    }
    .file-item-content:hover {
        background-color: #f3f4f6;
    }
    .file-item-content.selected {
        background-color: #32C77F !important;
        color: white !important;
    }
    .file-item-content.drag-over {
        border: 2px dashed #10b981;
        background-color: rgba(16, 185, 129, 0.1);
    }
    .folder-toggle {
        transition: transform 0.2s ease;
    }
    
    /* å³é”®èœå•æ ·å¼ */
    .context-menu {
        position: fixed;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        min-width: 150px;
    }
    .context-menu-item {
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        font-size: 14px;
    }
    .context-menu-item:hover {
        background-color: #f3f4f6;
    }
    .context-menu-item .material-icons-outlined {
        margin-right: 8px;
        font-size: 16px;
    }
</style>

<div class="flex h-screen bg-white">
    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="flex-1 flex bg-bg-light-blue-gray" id="main-content">
        
        <!-- å·¦ä¾§æ–‡ä»¶ç»“æ„é¢æ¿ -->
        <div class="w-1/4 bg-white border-r border-gray-200 p-4 flex flex-col transition-all duration-300" id="file-structure">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-text-dark-brown">æ–‡ä»¶ç»“æ„</h2>
                <div class="space-x-2">
                    <button class="text-text-gray hover:text-primary" onclick="createNewFolder()" title="æ–°å»ºæ–‡ä»¶å¤¹">
                        <span class="material-icons-outlined">create_new_folder</span>
                    </button>
                    <button class="text-text-gray hover:text-primary" onclick="createNewNote()" title="æ–°å»ºç¬”è®°">
                        <span class="material-icons-outlined">note_add</span>
                    </button>
                    <button class="text-red-600 hover:text-red-800" onclick="validateBackendFunctions()" title="éªŒè¯åç«¯åŠŸèƒ½">
                        <span class="material-icons-outlined">bug_report</span>
                    </button>
                </div>
            </div>
            
            <!-- æ–‡ä»¶æ ‘å®¹å™¨ -->
            <div class="flex-1 overflow-y-auto pr-2">
                <div id="loading-indicator" class="flex items-center justify-center py-8">
                    <div class="animate-spin">
                        <span class="material-icons-outlined text-primary">refresh</span>
                    </div>
                    <span class="ml-2 text-text-medium-brown">åŠ è½½æ–‡ä»¶ç»“æ„ä¸­...</span>
                </div>
                <div id="file-tree-container"></div>
            </div>
        </div>

        <!-- ä¸­é—´æ–‡æ¡£é¢„è§ˆ/ç¼–è¾‘åŒºåŸŸ -->
        <div class="flex-1 bg-white border-r border-gray-200 flex flex-col">
            <!-- é¡¶éƒ¨å·¥å…·æ  -->
            <div class="border-b border-gray-200 p-4 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-text-dark-brown" id="preview-title">æ–‡æ¡£é¢„è§ˆåŒº</h2>
                <div class="flex space-x-2">
                    <button id="preview-btn" class="px-4 py-2 bg-primary text-white rounded-lg text-sm" onclick="switchToPreview()">é¢„è§ˆ</button>
                    <button id="edit-btn" class="px-4 py-2 bg-white border border-gray-300 text-text-gray rounded-lg text-sm" onclick="switchToEdit()">ç¼–è¾‘</button>
                </div>
            </div>
            
            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="flex-1 p-4 overflow-y-auto">
                <div id="preview-content" class="prose max-w-none">
                    <div class="text-center py-16 text-text-medium-brown">
                        <span class="material-icons-outlined text-6xl mb-4">description</span>
                        <p>è¯·é€‰æ‹©ä¸€ä¸ªMarkdownæ–‡ä»¶è¿›è¡Œé¢„è§ˆ</p>
                    </div>
                </div>
                <textarea id="edit-content" class="w-full h-full border border-gray-300 rounded-lg p-4 font-mono text-sm resize-none hidden" placeholder="åœ¨æ­¤ç¼–è¾‘Markdownå†…å®¹..."></textarea>
            </div>
        </div>

        <!-- å³ä¾§çŸ¥è¯†ç‚¹é¢æ¿ -->
        <div class="w-1/4 bg-white p-4 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-text-dark-brown">çŸ¥è¯†ç‚¹</h2>
                <button class="text-text-gray hover:text-primary" onclick="extractKnowledgePoints()" title="æå–çŸ¥è¯†ç‚¹">
                    <span class="material-icons-outlined">lightbulb</span>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto">
                <div id="knowledge-points-container">
                    <div class="text-center py-16 text-text-medium-brown">
                        <span class="material-icons-outlined text-6xl mb-4">psychology</span>
                        <p>é€‰æ‹©æ–‡æ¡£åå¯æå–çŸ¥è¯†ç‚¹</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å³é”®èœå• -->
<div id="context-menu" class="context-menu hidden">
    <div class="context-menu-item" onclick="contextMenuAction('rename')">
        <span class="material-icons-outlined">edit</span>
        é‡å‘½å
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('delete')">
        <span class="material-icons-outlined">delete</span>
        åˆ é™¤
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('newNote')">
        <span class="material-icons-outlined">note_add</span>
        æ–°å»ºç¬”è®°
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('newFolder')">
        <span class="material-icons-outlined">create_new_folder</span>
        æ–°å»ºæ–‡ä»¶å¤¹
    </div>
</div>

<script>
(function() {
    'use strict';
    
    let currentFilePath = '';
    let currentFileName = '';
    let isEditMode = false;
    let contextMenuTarget = null;

    // è°ƒè¯•å‡½æ•°
    function debugLog(message) {
        console.log('[Learn Materials Debug]', message);
        if (window.sendDebugLog) {
            window.sendDebugLog('Learn Materials: ' + message);
        }
    }

    function debugError(message) {
        console.error('[Learn Materials Error]', message);
        if (window.sendDebugLog) {
            window.sendDebugLog('Learn Materials Error: ' + message);
        }
    }

    // é¡µé¢åˆå§‹åŒ–
    function initializePage() {
        debugLog('é¡µé¢åˆå§‹åŒ–å¼€å§‹');
        
        // æ£€æŸ¥Bridgeè¿æ¥
        if (window.bridge) {
            debugLog('Bridgeå¯¹è±¡å·²å¯ç”¨');
            loadFileStructure();
        } else {
            debugLog('Bridgeå¯¹è±¡ä¸å¯ç”¨ï¼Œç­‰å¾…è¿æ¥...');
            // ç­‰å¾…Bridgeè¿æ¥
            setTimeout(() => {
                if (window.bridge) {
                    debugLog('Bridgeè¿æ¥æˆåŠŸï¼ŒåŠ è½½æ–‡ä»¶ç»“æ„');
                    loadFileStructure();
                } else {
                    debugError('Bridgeè¿æ¥è¶…æ—¶');
                }
            }, 1000);
        }
        
        // æ·»åŠ å…¨å±€äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('click', hideContextMenu);
        document.addEventListener('contextmenu', function(e) {
            if (!e.target.closest('.file-item-content')) {
                e.preventDefault();
                hideContextMenu();
            }
        });
    }

    // åŠ è½½æ–‡ä»¶ç»“æ„
    function loadFileStructure() {
        debugLog('å¼€å§‹åŠ è½½æ–‡ä»¶ç»“æ„');
        
        if (!window.bridge || typeof window.bridge.getFileStructure !== 'function') {
            debugError('Bridgeå¯¹è±¡æˆ–getFileStructureæ–¹æ³•ä¸å¯ç”¨');
            return;
        }
        
        try {
            window.bridge.getFileStructure(function(jsonString) {
                debugLog('æ”¶åˆ°æ–‡ä»¶ç»“æ„æ•°æ®: ' + jsonString.substring(0, 100) + '...');
                
                try {
                    const structure = JSON.parse(jsonString);
                    renderFileTree(structure);
                } catch (parseError) {
                    debugError('è§£ææ–‡ä»¶ç»“æ„JSONå¤±è´¥: ' + parseError.message);
                }
            });
        } catch (error) {
            debugError('è°ƒç”¨getFileStructureæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
        }
    }

    // æ–‡ä»¶æ ‘æ¸²æŸ“å‡½æ•°
    function renderFileTree(data) {
        debugLog('æ¸²æŸ“æ–‡ä»¶æ ‘ï¼Œæ•°æ®é¡¹æ•°: ' + (data ? data.length : 0));
        
        const container = document.getElementById('file-tree-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }
        
        if (!container) {
            debugError('æ–‡ä»¶æ ‘å®¹å™¨æœªæ‰¾åˆ°');
            return;
        }
        
        if (!data || data.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-text-medium-brown">æš‚æ— æ–‡ä»¶</div>';
            return;
        }
        
        let html = '<ul class="space-y-1">';
        data.forEach(item => {
            html += renderFileItem(item, 0);
        });
        html += '</ul>';
        
        container.innerHTML = html;
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        addFileTreeEventListeners();
        debugLog('æ–‡ä»¶æ ‘æ¸²æŸ“å®Œæˆ');
    }

    function renderFileItem(item, level) {
        const indent = level * 20;
        const isFolder = item.type === 'folder';
        const icon = isFolder ? 'folder' : 'description';
        const itemClass = isFolder ? 'folder-item' : 'file-item';
        
        let html = `
            <li class="${itemClass}" data-path="${item.path}" data-type="${item.type}" data-name="${item.name}">
                <div class="flex items-center py-1 px-2 hover:bg-gray-100 rounded cursor-pointer file-item-content" 
                     style="margin-left: ${indent}px"
                     draggable="true">
                    ${isFolder ? '<span class="material-icons-outlined text-sm mr-1 folder-toggle">chevron_right</span>' : '<span class="w-5"></span>'}
                    <span class="material-icons-outlined text-sm mr-2 text-text-gray">${icon}</span>
                    <span class="text-sm text-text-dark-brown flex-1 file-name">${item.name}</span>
                </div>
        `;
        
        if (isFolder && item.children && item.children.length > 0) {
            html += '<ul class="folder-children hidden ml-4">';
            item.children.forEach(child => {
                html += renderFileItem(child, level + 1);
            });
            html += '</ul>';
        }
        
        html += '</li>';
        return html;
    }

    // æ·»åŠ æ–‡ä»¶æ ‘äº‹ä»¶ç›‘å¬å™¨
    function addFileTreeEventListeners() {
        debugLog('æ·»åŠ æ–‡ä»¶æ ‘äº‹ä»¶ç›‘å¬å™¨');
        
        const fileItems = document.querySelectorAll('.file-item-content');
        
        fileItems.forEach(content => {
            // ç‚¹å‡»äº‹ä»¶
            content.addEventListener('click', function(e) {
                const item = this.closest('li');
                const path = item.getAttribute('data-path');
                const type = item.getAttribute('data-type');
                const name = item.getAttribute('data-name');
                
                handleFileClick(path, type, name, this);
            });
            
            // å³é”®èœå•
            content.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                const item = this.closest('li');
                const path = item.getAttribute('data-path');
                const type = item.getAttribute('data-type');
                const name = item.getAttribute('data-name');
                
                showContextMenu(e, path, type, name);
            });
            
            // æ‹–æ‹½äº‹ä»¶
            content.addEventListener('dragstart', handleDragStart);
            content.addEventListener('dragover', handleDragOver);
            content.addEventListener('drop', handleDrop);
            content.addEventListener('dragenter', handleDragEnter);
            content.addEventListener('dragleave', handleDragLeave);
        });
        
        // æ–‡ä»¶å¤¹åˆ‡æ¢äº‹ä»¶
        const folderToggles = document.querySelectorAll('.folder-toggle');
        folderToggles.forEach(toggle => {
            toggle.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleFolder(this);
            });
        });
    }

    // å¤„ç†æ–‡ä»¶ç‚¹å‡»
    function handleFileClick(path, type, name, element) {
        debugLog(`æ–‡ä»¶ç‚¹å‡»: ${name} (${type}) - ${path}`);
        
        // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.file-item-content.selected').forEach(el => {
            el.classList.remove('selected');
        });
        
        // æ·»åŠ é€‰ä¸­çŠ¶æ€
        element.classList.add('selected');
        
        if (type === 'file' && path.endsWith('.md')) {
            // åŠ è½½Markdownæ–‡ä»¶
            loadFileContent(path, name);
        }
    }

    // åŠ è½½æ–‡ä»¶å†…å®¹
    function loadFileContent(filePath, fileName) {
        debugLog(`åŠ è½½æ–‡ä»¶å†…å®¹: ${fileName}`);
        
        currentFilePath = filePath;
        currentFileName = fileName;
        
        if (!window.bridge || !window.bridge.loadMarkdownFile) {
            debugError('Bridgeå¯¹è±¡æˆ–loadMarkdownFileæ–¹æ³•ä¸å¯ç”¨');
            return;
        }
        
        // æ›´æ–°æ–‡æ¡£é¢„è§ˆåŒºæ ‡é¢˜
        const previewTitle = document.getElementById('preview-title');
        if (previewTitle) {
            previewTitle.textContent = fileName;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const previewContent = document.getElementById('preview-content');
        if (previewContent) {
            previewContent.innerHTML = '<div class="flex items-center justify-center py-8"><div class="animate-spin mr-2"><span class="material-icons-outlined">refresh</span></div><span>åŠ è½½ä¸­...</span></div>';
        }
        
        // è°ƒç”¨åç«¯åŠ è½½æ–‡ä»¶
        try {
            window.bridge.loadMarkdownFile(filePath, function(htmlContent) {
                debugLog(`æ–‡ä»¶å†…å®¹åŠ è½½å®Œæˆï¼Œé•¿åº¦: ${htmlContent.length}`);
                
                if (previewContent) {
                    if (htmlContent) {
                        previewContent.innerHTML = htmlContent;
                    } else {
                        previewContent.innerHTML = '<div class="text-center py-8 text-gray-500">æ–‡ä»¶å†…å®¹ä¸ºç©ºæˆ–åŠ è½½å¤±è´¥</div>';
                    }
                }
                
                // åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼
                switchToPreview();
            });
        } catch (error) {
            debugError(`åŠ è½½æ–‡ä»¶å†…å®¹æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`);
            if (previewContent) {
                previewContent.innerHTML = '<div class="text-center py-8 text-red-500">åŠ è½½æ–‡ä»¶å¤±è´¥</div>';
            }
        }
    }

    // åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼
    function switchToPreview() {
        debugLog('åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼');
        isEditMode = false;
        
        document.getElementById('preview-content').classList.remove('hidden');
        document.getElementById('edit-content').classList.add('hidden');
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.getElementById('preview-btn').classList.add('bg-primary', 'text-white');
        document.getElementById('preview-btn').classList.remove('bg-white', 'border-gray-300', 'text-text-gray');
        document.getElementById('edit-btn').classList.add('bg-white', 'border-gray-300', 'text-text-gray');
        document.getElementById('edit-btn').classList.remove('bg-primary', 'text-white');
    }

    // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
    function switchToEdit() {
        debugLog('åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼');
        
        if (!currentFilePath) {
            debugLog('æ²¡æœ‰é€‰ä¸­çš„æ–‡ä»¶');
            return;
        }
        
        isEditMode = true;
        
        // åŠ è½½åŸå§‹å†…å®¹
        if (window.bridge && window.bridge.loadMarkdownRaw) {
            window.bridge.loadMarkdownRaw(currentFilePath, function(rawContent) {
                debugLog(`åŸå§‹å†…å®¹åŠ è½½å®Œæˆï¼Œé•¿åº¦: ${rawContent.length}`);
                
                const editContent = document.getElementById('edit-content');
                if (editContent) {
                    editContent.value = rawContent;
                }
                
                document.getElementById('preview-content').classList.add('hidden');
                document.getElementById('edit-content').classList.remove('hidden');
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('edit-btn').classList.add('bg-primary', 'text-white');
                document.getElementById('edit-btn').classList.remove('bg-white', 'border-gray-300', 'text-text-gray');
                document.getElementById('preview-btn').classList.add('bg-white', 'border-gray-300', 'text-text-gray');
                document.getElementById('preview-btn').classList.remove('bg-primary', 'text-white');
            });
        }
    }

    // åˆ‡æ¢æ–‡ä»¶å¤¹å±•å¼€/æŠ˜å 
    function toggleFolder(toggleElement) {
        debugLog('åˆ‡æ¢æ–‡ä»¶å¤¹çŠ¶æ€');
        
        const folderItem = toggleElement.closest('.folder-item');
        const children = folderItem.querySelector('.folder-children');
        
        if (children) {
            const isHidden = children.classList.contains('hidden');
            
            if (isHidden) {
                children.classList.remove('hidden');
                toggleElement.textContent = 'expand_more';
            } else {
                children.classList.add('hidden');
                toggleElement.textContent = 'chevron_right';
            }
        }
    }

    // æ‹–æ‹½å¤„ç†å‡½æ•°
    let draggedElement = null;

    function handleDragStart(e) {
        draggedElement = this.closest('li');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', draggedElement.outerHTML);
        
        const path = draggedElement.getAttribute('data-path');
        const name = draggedElement.getAttribute('data-name');
        debugLog(`å¼€å§‹æ‹–æ‹½: ${name} - ${path}`);
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(e) {
        const targetItem = this.closest('li');
        const targetType = targetItem.getAttribute('data-type');
        
        if (targetType === 'folder' && targetItem !== draggedElement) {
            this.classList.add('drag-over');
        }
    }

    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        const targetItem = this.closest('li');
        const targetType = targetItem.getAttribute('data-type');
        const targetPath = targetItem.getAttribute('data-path');
        
        if (targetType === 'folder' && targetItem !== draggedElement && draggedElement) {
            const sourcePath = draggedElement.getAttribute('data-path');
            const sourceName = draggedElement.getAttribute('data-name');
            
            debugLog(`æ‹–æ‹½ç§»åŠ¨: ${sourceName} -> ${targetPath}`);
            
            // è°ƒç”¨åç«¯ç§»åŠ¨æ–‡ä»¶
            if (window.bridge && window.bridge.moveFileOrFolder) {
                window.bridge.moveFileOrFolder(sourcePath, targetPath, function(success) {
                    if (success) {
                        debugLog('æ–‡ä»¶ç§»åŠ¨æˆåŠŸ');
                        loadFileStructure(); // é‡æ–°åŠ è½½æ–‡ä»¶ç»“æ„
                    } else {
                        debugError('æ–‡ä»¶ç§»åŠ¨å¤±è´¥');
                    }
                });
            }
        }
        
        draggedElement = null;
    }

    // å³é”®èœå•åŠŸèƒ½
    function showContextMenu(e, path, type, name) {
        e.preventDefault();
        
        const contextMenu = document.getElementById('context-menu');
        contextMenuTarget = { path, type, name };
        
        contextMenu.style.left = e.pageX + 'px';
        contextMenu.style.top = e.pageY + 'px';
        contextMenu.classList.remove('hidden');
        
        debugLog(`æ˜¾ç¤ºå³é”®èœå•: ${name} (${type})`);
    }

    function hideContextMenu() {
        const contextMenu = document.getElementById('context-menu');
        contextMenu.classList.add('hidden');
        contextMenuTarget = null;
    }

    function contextMenuAction(action) {
        if (!contextMenuTarget) return;
        
        const { path, type, name } = contextMenuTarget;
        debugLog(`å³é”®èœå•æ“ä½œ: ${action} - ${name}`);
        
        switch (action) {
            case 'rename':
                renameItem(path, name);
                break;
            case 'delete':
                deleteItem(path, name);
                break;
            case 'newNote':
                createNewNote(path);
                break;
            case 'newFolder':
                createNewFolder(path);
                break;
        }
        
        hideContextMenu();
    }

    // é‡å‘½ååŠŸèƒ½
    function renameItem(path, currentName) {
        const newName = prompt('è¯·è¾“å…¥æ–°åç§°:', currentName);
        if (newName && newName !== currentName) {
            debugLog(`é‡å‘½å: ${currentName} -> ${newName}`);
            
            if (window.bridge && window.bridge.renameFileOrFolder) {
                window.bridge.renameFileOrFolder(path, newName, function(success) {
                    if (success) {
                        debugLog('é‡å‘½åæˆåŠŸ');
                        loadFileStructure();
                    } else {
                        debugError('é‡å‘½åå¤±è´¥');
                        alert('é‡å‘½åå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç§°æ˜¯å¦å·²å­˜åœ¨');
                    }
                });
            }
        }
    }

    // åˆ é™¤åŠŸèƒ½
    function deleteItem(path, name) {
        if (confirm(`ç¡®å®šè¦åˆ é™¤ "${name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
            debugLog(`åˆ é™¤: ${name}`);
            
            if (window.bridge && window.bridge.deleteFileOrFolder) {
                window.bridge.deleteFileOrFolder(path, function(success) {
                    if (success) {
                        debugLog('åˆ é™¤æˆåŠŸ');
                        loadFileStructure();
                    } else {
                        debugError('åˆ é™¤å¤±è´¥');
                        alert('åˆ é™¤å¤±è´¥');
                    }
                });
            }
        }
    }

    // æ–‡ä»¶æ“ä½œå‡½æ•°
    function createNewNote(parentPath = 'vault') {
        debugLog('åˆ›å»ºæ–°ç¬”è®°');
        if (window.bridge && window.bridge.createNewNote) {
            window.bridge.createNewNote(parentPath, function(result) {
                debugLog('æ–°ç¬”è®°åˆ›å»ºç»“æœ: ' + result);
                if (result) {
                    loadFileStructure();
                }
            });
        }
    }

    function createNewFolder(parentPath = 'vault') {
        debugLog('åˆ›å»ºæ–°æ–‡ä»¶å¤¹');
        if (window.bridge && window.bridge.createNewFolder) {
            window.bridge.createNewFolder(parentPath, function(result) {
                debugLog('æ–°æ–‡ä»¶å¤¹åˆ›å»ºç»“æœ: ' + result);
                if (result) {
                    loadFileStructure();
                }
            });
        }
    }

    // éªŒè¯åç«¯åŠŸèƒ½
    function validateBackendFunctions() {
        debugLog('ğŸ” å¼€å§‹éªŒè¯åç«¯åŠŸèƒ½');
        
        if (!window.bridge || typeof window.bridge.validateAllFileOperations !== 'function') {
            debugError('âŒ Bridgeå¯¹è±¡æˆ–validateAllFileOperationsæ–¹æ³•ä¸å¯ç”¨');
            alert('âŒ æ— æ³•è¿æ¥åˆ°åç«¯éªŒè¯æœåŠ¡');
            return;
        }
        
        // æ˜¾ç¤ºéªŒè¯å¼€å§‹æç¤º
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'validation-loading';
        loadingDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        loadingDiv.innerHTML = `
            <div class="flex items-center">
                <div class="animate-spin mr-2">
                    <span class="material-icons-outlined">refresh</span>
                </div>
                <span>æ­£åœ¨éªŒè¯åç«¯åŠŸèƒ½...</span>
            </div>
        `;
        document.body.appendChild(loadingDiv);
        
        debugLog('è°ƒç”¨åç«¯éªŒè¯åŠŸèƒ½...');
        
        try {
            window.bridge.validateAllFileOperations(function(result) {
                debugLog('ğŸ¯ åç«¯éªŒè¯å®Œæˆ');
                debugLog('éªŒè¯ç»“æœ: ' + result);
                
                // ç§»é™¤åŠ è½½æç¤º
                const loadingElement = document.getElementById('validation-loading');
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                // æ˜¾ç¤ºéªŒè¯ç»“æœ
                const resultDiv = document.createElement('div');
                resultDiv.className = 'fixed top-4 right-4 bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-w-md p-4';
                resultDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-800">åç«¯åŠŸèƒ½éªŒè¯ç»“æœ</h3>
                        <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                            <span class="material-icons-outlined text-sm">close</span>
                        </button>
                    </div>
                    <div class="text-sm text-gray-600 whitespace-pre-line max-h-64 overflow-y-auto">
                        ${result}
                    </div>
                `;
                document.body.appendChild(resultDiv);
                
                // 10ç§’åè‡ªåŠ¨å…³é—­
                setTimeout(() => {
                    if (resultDiv.parentElement) {
                        resultDiv.remove();
                    }
                }, 10000);
                
                // é‡æ–°åŠ è½½æ–‡ä»¶ç»“æ„ä»¥åæ˜ ä»»ä½•æ›´æ”¹
                loadFileStructure();
            });
        } catch (error) {
            debugError('è°ƒç”¨åç«¯éªŒè¯æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            
            // ç§»é™¤åŠ è½½æç¤º
            const loadingElement = document.getElementById('validation-loading');
            if (loadingElement) {
                loadingElement.remove();
            }
            
            alert('âŒ éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message);
        }
    }

    // å¯¼èˆªå‡½æ•°ï¼ˆå…¼å®¹SPAï¼‰
    function loadContent(contentId) {
        if (window.bridge && window.bridge.loadContent) {
            window.bridge.loadContent(contentId);
        }
    }

    // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.toggleFolder = toggleFolder;
    window.handleFileClick = handleFileClick;
    window.switchToPreview = switchToPreview;
    window.switchToEdit = switchToEdit;
    window.createNewNote = createNewNote;
    window.createNewFolder = createNewFolder;
    window.validateBackendFunctions = validateBackendFunctions;
    window.contextMenuAction = contextMenuAction;
    window.loadContent = loadContent;

    // é¡µé¢åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePage);
    } else {
        initializePage();
    }

})();
</script>
