<!-- ä»èµ„æ–™å­¦ä¹ é¡µé¢ - å®Œæ•´çš„æ ‘å½¢æ–‡ä»¶ç®¡ç† -->
<style>
    /* ä¾§è¾¹æ æ”¶ç¼©æ ·å¼ */
    #sidebar.collapsed .sidebar-text,
    #sidebar.collapsed #user-profile,
    #sidebar.collapsed .logo-text {
        display: none;
    }
    #sidebar.collapsed .nav-item-icon {
        margin-right: 0;
    }
    #sidebar.collapsed .nav-link {
        justify-content: center;
    }
    
    /* æ–‡ä»¶æ ‘æ ·å¼ */
    .file-item-content {
        transition: all 0.2s ease;
    }
    .file-item-content:hover {
        background-color: #f3f4f6;
    }
    .file-item-content.selected {
        background-color: #32C77F !important;
        color: white !important;
    }
    .file-item-content.drag-over {
        border: 2px dashed #10b981;
        background-color: rgba(16, 185, 129, 0.1);
    }
    .folder-toggle {
        transition: transform 0.2s ease;
    }
    
    /* å³é”®èœå•æ ·å¼ */
    .context-menu {
        position: fixed;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        min-width: 150px;
    }
    .context-menu-item {
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        font-size: 14px;
    }
    .context-menu-item:hover {
        background-color: #f3f4f6;
    }
    .context-menu-item .material-icons-outlined {
        margin-right: 8px;
        font-size: 16px;
    }
</style>

<div class="flex h-screen bg-white">
    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="flex-1 flex bg-bg-light-blue-gray" id="main-content">
        
        <!-- å·¦ä¾§æ–‡ä»¶ç»“æ„é¢æ¿ -->
        <div class="w-1/4 bg-white border-r border-gray-200 p-4 flex flex-col transition-all duration-300" id="file-structure">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-text-dark-brown">æ–‡ä»¶ç»“æ„</h2>
                <div class="space-x-2">
                    <button class="text-text-gray hover:text-primary" onclick="createNewFolder()" title="æ–°å»ºæ–‡ä»¶å¤¹">
                        <span class="material-icons-outlined">create_new_folder</span>
                    </button>
                    <button class="text-text-gray hover:text-primary" onclick="createNewNote()" title="æ–°å»ºç¬”è®°">
                        <span class="material-icons-outlined">note_add</span>
                    </button>
                    <button class="text-red-600 hover:text-red-800" onclick="validateBackendFunctions()" title="éªŒè¯åç«¯åŠŸèƒ½">
                        <span class="material-icons-outlined">bug_report</span>
                    </button>
                </div>
            </div>
            
            <!-- æ–‡ä»¶æ ‘å®¹å™¨ -->
            <div class="flex-1 overflow-y-auto pr-2">
                <div id="loading-indicator" class="flex items-center justify-center py-8">
                    <div class="animate-spin">
                        <span class="material-icons-outlined text-primary">refresh</span>
                    </div>
                    <span class="ml-2 text-text-medium-brown">åŠ è½½æ–‡ä»¶ç»“æ„ä¸­...</span>
                </div>
                <div id="file-tree-container"></div>
            </div>
        </div>

        <!-- ä¸­é—´æ–‡æ¡£é¢„è§ˆ/ç¼–è¾‘åŒºåŸŸ -->
        <div class="flex-1 bg-white border-r border-gray-200 flex flex-col">
            <!-- é¡¶éƒ¨å·¥å…·æ  -->
            <div class="border-b border-gray-200 p-4 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <h2 class="text-lg font-semibold text-text-dark-brown" id="preview-title">æ–‡æ¡£é¢„è§ˆåŒº</h2>
                    <span id="unsaved-indicator" class="text-orange-500 text-sm hidden">â— æœªä¿å­˜</span>
                </div>
                <div class="flex space-x-2">
                    <button id="save-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hidden" onclick="saveCurrentFile()" title="ä¿å­˜æ–‡ä»¶">
                        <span class="material-icons-outlined text-sm mr-1">save</span>
                        ä¿å­˜
                    </button>
                    <button id="preview-btn" class="px-4 py-2 bg-primary text-white rounded-lg text-sm" onclick="switchToPreview()">é¢„è§ˆ</button>
                    <button id="edit-btn" class="px-4 py-2 bg-white border border-gray-300 text-text-gray rounded-lg text-sm" onclick="switchToEdit()">ç¼–è¾‘</button>
                </div>
            </div>
            
            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="flex-1 p-4 overflow-y-auto">
                <div id="preview-content" class="prose max-w-none">
                    <div class="text-center py-16 text-text-medium-brown">
                        <span class="material-icons-outlined text-6xl mb-4">description</span>
                        <p>è¯·é€‰æ‹©ä¸€ä¸ªMarkdownæ–‡ä»¶è¿›è¡Œé¢„è§ˆ</p>
                    </div>
                </div>
                <textarea id="edit-content" class="w-full h-full border border-gray-300 rounded-lg p-4 font-mono text-sm resize-none hidden" placeholder="åœ¨æ­¤ç¼–è¾‘Markdownå†…å®¹..."></textarea>
            </div>
        </div>

        <!-- å³ä¾§çŸ¥è¯†ç‚¹é¢æ¿ -->
        <div class="w-1/4 bg-white p-4 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-text-dark-brown">çŸ¥è¯†ç‚¹</h2>
                <div class="flex gap-2">
                    <button class="text-text-gray hover:text-primary" onclick="toggleDebugPanel()" title="åˆ‡æ¢è°ƒè¯•é¢æ¿" id="debug-toggle-btn">
                        <span class="material-icons-outlined">terminal</span>
                    </button>
                    <button class="text-text-gray hover:text-primary" onclick="testBridgeConnection()" title="æµ‹è¯•Bridgeè¿æ¥" id="test-btn">
                        <span class="material-icons-outlined">bug_report</span>
                    </button>
                    <button class="text-text-gray hover:text-primary" onclick="extractKnowledgePoints()" title="æå–å…¨æ–‡çŸ¥è¯†ç‚¹" id="extract-btn">
                        <span class="material-icons-outlined">lightbulb</span>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto">
                <div id="knowledge-points-container">
                    <div class="text-center py-16 text-text-medium-brown" id="knowledge-placeholder">
                        <span class="material-icons-outlined text-6xl mb-4">psychology</span>
                        <p>é€‰æ‹©æ–‡æ¡£åå¯æå–çŸ¥è¯†ç‚¹</p>
                    </div>
                    <div id="knowledge-loading" class="text-center py-16 text-primary hidden">
                        <div class="animate-spin mb-4">
                            <span class="material-icons-outlined text-6xl">refresh</span>
                        </div>
                        <p>æ­£åœ¨æå–çŸ¥è¯†ç‚¹...</p>
                    </div>
                    <div id="knowledge-content" class="hidden">
                        <!-- çŸ¥è¯†ç‚¹å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    
                    <!-- è°ƒè¯•é¢æ¿ -->
                    <div id="debug-panel" class="mt-4 p-3 bg-gray-100 border border-gray-300 rounded-lg hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-sm font-semibold text-gray-700">è°ƒè¯•æ—¥å¿—</h4>
                            <button onclick="clearDebugLog()" class="text-xs text-red-600 hover:text-red-800">æ¸…ç©º</button>
                        </div>
                        <div id="debug-log" class="bg-white p-2 rounded border text-xs font-mono max-h-40 overflow-y-auto">
                            <!-- è°ƒè¯•æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å³é”®èœå• -->
<div id="context-menu" class="context-menu hidden">
    <div class="context-menu-item" onclick="contextMenuAction('rename')">
        <span class="material-icons-outlined">edit</span>
        é‡å‘½å
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('delete')">
        <span class="material-icons-outlined">delete</span>
        åˆ é™¤
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('newNote')">
        <span class="material-icons-outlined">note_add</span>
        æ–°å»ºç¬”è®°
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('newFolder')">
        <span class="material-icons-outlined">create_new_folder</span>
        æ–°å»ºæ–‡ä»¶å¤¹
    </div>
</div>

<script>
(function() {
    'use strict';
    
    let currentFilePath = '';
    let currentFileName = '';
    let isEditMode = false;
    let contextMenuTarget = null;
    let originalContent = '';  // åŸå§‹æ–‡ä»¶å†…å®¹
    let hasUnsavedChanges = false;  // æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹

    // è°ƒè¯•å˜é‡
    let debugEnabled = false;
    let debugLogCount = 0;

    // è°ƒè¯•å‡½æ•°
    function debugLog(message) {
        console.log('[Learn Materials Debug]', message);
        if (debugEnabled) {
            addToDebugPanel('INFO', message);
        }
    }

    function debugError(message) {
        console.error('[Learn Materials Error]', message);
        if (debugEnabled) {
            addToDebugPanel('ERROR', message);
        }
    }

    function debugWarn(message) {
        console.warn('[Learn Materials Warn]', message);
        if (debugEnabled) {
            addToDebugPanel('WARN', message);
        }
    }

    // æ·»åŠ åˆ°è°ƒè¯•é¢æ¿
    function addToDebugPanel(level, message) {
        const debugLog = document.getElementById('debug-log');
        if (!debugLog) return;
        
        debugLogCount++;
        const timestamp = new Date().toLocaleTimeString();
        const levelColor = {
            'INFO': 'text-blue-600',
            'ERROR': 'text-red-600',
            'WARN': 'text-yellow-600',
            'SUCCESS': 'text-green-600'
        }[level] || 'text-gray-600';
        
        const logEntry = document.createElement('div');
        logEntry.className = 'mb-1';
        logEntry.innerHTML = `
            <span class="text-gray-500">[${timestamp}]</span>
            <span class="${levelColor} font-semibold">[${level}]</span>
            <span>${message}</span>
        `;
        
        debugLog.appendChild(logEntry);
        debugLog.scrollTop = debugLog.scrollHeight;
        
        // é™åˆ¶æ—¥å¿—æ¡æ•°ï¼Œé¿å…å ç”¨å¤ªå¤šå†…å­˜
        if (debugLogCount > 100) {
            const firstChild = debugLog.firstChild;
            if (firstChild) {
                debugLog.removeChild(firstChild);
                debugLogCount--;
            }
        }
    }

    // åˆ‡æ¢è°ƒè¯•é¢æ¿
    function toggleDebugPanel() {
        const debugPanel = document.getElementById('debug-panel');
        const debugToggleBtn = document.getElementById('debug-toggle-btn');
        
        if (debugPanel.classList.contains('hidden')) {
            debugPanel.classList.remove('hidden');
            debugEnabled = true;
            debugToggleBtn.classList.add('text-primary');
            debugToggleBtn.classList.remove('text-text-gray');
            addToDebugPanel('SUCCESS', 'è°ƒè¯•é¢æ¿å·²å¼€å¯');
        } else {
            debugPanel.classList.add('hidden');
            debugEnabled = false;
            debugToggleBtn.classList.remove('text-primary');
            debugToggleBtn.classList.add('text-text-gray');
        }
    }

    // æ¸…ç©ºè°ƒè¯•æ—¥å¿—
    function clearDebugLog() {
        const debugLog = document.getElementById('debug-log');
        if (debugLog) {
            debugLog.innerHTML = '';
            debugLogCount = 0;
            addToDebugPanel('INFO', 'è°ƒè¯•æ—¥å¿—å·²æ¸…ç©º');
        }
    }

    // é¡µé¢åˆå§‹åŒ–
    function initializePage() {
        debugLog('é¡µé¢åˆå§‹åŒ–å¼€å§‹');
        
        // æ£€æŸ¥Bridgeè¿æ¥
        if (window.bridge) {
            debugLog('Bridgeå¯¹è±¡å·²å¯ç”¨');
            loadFileStructure();
        } else {
            debugLog('Bridgeå¯¹è±¡ä¸å¯ç”¨ï¼Œç­‰å¾…è¿æ¥...');
            // ç­‰å¾…Bridgeè¿æ¥
            setTimeout(() => {
                if (window.bridge) {
                    debugLog('Bridgeè¿æ¥æˆåŠŸï¼ŒåŠ è½½æ–‡ä»¶ç»“æ„');
                    loadFileStructure();
                } else {
                    debugError('Bridgeè¿æ¥è¶…æ—¶');
                }
            }, 1000);
        }
        
        // æ·»åŠ å…¨å±€äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('click', hideContextMenu);
        document.addEventListener('contextmenu', function(e) {
            if (!e.target.closest('.file-item-content')) {
                e.preventDefault();
                hideContextMenu();
            }
        });
        
        // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(e) {
            // Ctrl+S ä¿å­˜æ–‡ä»¶
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (isEditMode && currentFilePath) {
                    saveCurrentFile();
                }
            }
        });
        
        // é¡µé¢ç¦»å¼€å‰æ£€æŸ¥æœªä¿å­˜çš„æ›´æ”¹
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = 'æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                return e.returnValue;
            }
        });
    }

    // åŠ è½½æ–‡ä»¶ç»“æ„
    function loadFileStructure() {
        debugLog('å¼€å§‹åŠ è½½æ–‡ä»¶ç»“æ„');
        
        if (!window.bridge || typeof window.bridge.getFileStructure !== 'function') {
            debugError('Bridgeå¯¹è±¡æˆ–getFileStructureæ–¹æ³•ä¸å¯ç”¨');
            return;
        }
        
        try {
            window.bridge.getFileStructure(function(jsonString) {
                debugLog('æ”¶åˆ°æ–‡ä»¶ç»“æ„æ•°æ®: ' + jsonString.substring(0, 100) + '...');
                
                try {
                    const structure = JSON.parse(jsonString);
                    renderFileTree(structure);
                } catch (parseError) {
                    debugError('è§£ææ–‡ä»¶ç»“æ„JSONå¤±è´¥: ' + parseError.message);
                }
            });
        } catch (error) {
            debugError('è°ƒç”¨getFileStructureæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
        }
    }

    // æ–‡ä»¶æ ‘æ¸²æŸ“å‡½æ•°
    function renderFileTree(data) {
        debugLog('æ¸²æŸ“æ–‡ä»¶æ ‘ï¼Œæ•°æ®é¡¹æ•°: ' + (data ? data.length : 0));
        
        const container = document.getElementById('file-tree-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }
        
        if (!container) {
            debugError('æ–‡ä»¶æ ‘å®¹å™¨æœªæ‰¾åˆ°');
            return;
        }
        
        if (!data || data.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-text-medium-brown">æš‚æ— æ–‡ä»¶</div>';
            return;
        }
        
        let html = '<ul class="space-y-1">';
        data.forEach(item => {
            html += renderFileItem(item, 0);
        });
        html += '</ul>';
        
        container.innerHTML = html;
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        addFileTreeEventListeners();
        debugLog('æ–‡ä»¶æ ‘æ¸²æŸ“å®Œæˆ');
    }

    function renderFileItem(item, level) {
        const indent = level * 20;
        const isFolder = item.type === 'folder';
        const icon = isFolder ? 'folder' : 'description';
        const itemClass = isFolder ? 'folder-item' : 'file-item';
        
        let html = `
            <li class="${itemClass}" data-path="${item.path}" data-type="${item.type}" data-name="${item.name}">
                <div class="flex items-center py-1 px-2 hover:bg-gray-100 rounded cursor-pointer file-item-content" 
                     style="margin-left: ${indent}px"
                     draggable="true">
                    ${isFolder ? '<span class="material-icons-outlined text-sm mr-1 folder-toggle">chevron_right</span>' : '<span class="w-5"></span>'}
                    <span class="material-icons-outlined text-sm mr-2 text-text-gray">${icon}</span>
                    <span class="text-sm text-text-dark-brown flex-1 file-name">${item.name}</span>
                </div>
        `;
        
        if (isFolder && item.children && item.children.length > 0) {
            html += '<ul class="folder-children hidden ml-4">';
            item.children.forEach(child => {
                html += renderFileItem(child, level + 1);
            });
            html += '</ul>';
        }
        
        html += '</li>';
        return html;
    }

    // æ·»åŠ æ–‡ä»¶æ ‘äº‹ä»¶ç›‘å¬å™¨
    function addFileTreeEventListeners() {
        debugLog('æ·»åŠ æ–‡ä»¶æ ‘äº‹ä»¶ç›‘å¬å™¨');
        
        const fileItems = document.querySelectorAll('.file-item-content');
        
        fileItems.forEach(content => {
            // ç‚¹å‡»äº‹ä»¶
            content.addEventListener('click', function(e) {
                const item = this.closest('li');
                const path = item.getAttribute('data-path');
                const type = item.getAttribute('data-type');
                const name = item.getAttribute('data-name');
                
                handleFileClick(path, type, name, this);
            });
            
            // å³é”®èœå•
            content.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                const item = this.closest('li');
                const path = item.getAttribute('data-path');
                const type = item.getAttribute('data-type');
                const name = item.getAttribute('data-name');
                
                showContextMenu(e, path, type, name);
            });
            
            // æ‹–æ‹½äº‹ä»¶
            content.addEventListener('dragstart', handleDragStart);
            content.addEventListener('dragover', handleDragOver);
            content.addEventListener('drop', handleDrop);
            content.addEventListener('dragenter', handleDragEnter);
            content.addEventListener('dragleave', handleDragLeave);
        });
        
        // æ–‡ä»¶å¤¹åˆ‡æ¢äº‹ä»¶
        const folderToggles = document.querySelectorAll('.folder-toggle');
        folderToggles.forEach(toggle => {
            toggle.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleFolder(this);
            });
        });
    }

    // å¤„ç†æ–‡ä»¶ç‚¹å‡»
    function handleFileClick(path, type, name, element) {
        debugLog(`æ–‡ä»¶ç‚¹å‡»: ${name} (${type}) - ${path}`);
        
        // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.file-item-content.selected').forEach(el => {
            el.classList.remove('selected');
        });
        
        // æ·»åŠ é€‰ä¸­çŠ¶æ€
        element.classList.add('selected');
        
        if (type === 'file' && path.endsWith('.md')) {
            // åŠ è½½Markdownæ–‡ä»¶
            loadFileContent(path, name);
        }
    }

    // åŠ è½½æ–‡ä»¶å†…å®¹
    function loadFileContent(filePath, fileName) {
        debugLog(`åŠ è½½æ–‡ä»¶å†…å®¹: ${fileName}`);
        
        currentFilePath = filePath;
        currentFileName = fileName;
        
        if (!window.bridge || !window.bridge.loadMarkdownFile) {
            debugError('Bridgeå¯¹è±¡æˆ–loadMarkdownFileæ–¹æ³•ä¸å¯ç”¨');
            return;
        }
        
        // æ›´æ–°æ–‡æ¡£é¢„è§ˆåŒºæ ‡é¢˜
        const previewTitle = document.getElementById('preview-title');
        if (previewTitle) {
            previewTitle.textContent = fileName;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const previewContent = document.getElementById('preview-content');
        if (previewContent) {
            previewContent.innerHTML = '<div class="flex items-center justify-center py-8"><div class="animate-spin mr-2"><span class="material-icons-outlined">refresh</span></div><span>åŠ è½½ä¸­...</span></div>';
        }
        
        // è°ƒç”¨åç«¯åŠ è½½æ–‡ä»¶
        try {
            window.bridge.loadMarkdownFile(filePath, function(htmlContent) {
                debugLog(`æ–‡ä»¶å†…å®¹åŠ è½½å®Œæˆï¼Œé•¿åº¦: ${htmlContent.length}`);
                
                if (previewContent) {
                    if (htmlContent) {
                        previewContent.innerHTML = htmlContent;
                    } else {
                        previewContent.innerHTML = '<div class="text-center py-8 text-gray-500">æ–‡ä»¶å†…å®¹ä¸ºç©ºæˆ–åŠ è½½å¤±è´¥</div>';
                    }
                }
                
                // ç¡®ä¿å¤„äºé¢„è§ˆæ¨¡å¼ï¼ˆä¸é‡å¤è°ƒç”¨switchToPreviewï¼‰
                if (!isEditMode) {
                    // åªæ›´æ–°UIçŠ¶æ€ï¼Œä¸é‡æ–°åŠ è½½å†…å®¹
                    document.getElementById('preview-content').classList.remove('hidden');
                    document.getElementById('edit-content').classList.add('hidden');
                    document.getElementById('save-btn').classList.add('hidden');
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.getElementById('preview-btn').classList.add('bg-primary', 'text-white');
                    document.getElementById('preview-btn').classList.remove('bg-white', 'border-gray-300', 'text-text-gray');
                    document.getElementById('edit-btn').classList.add('bg-white', 'border-gray-300', 'text-text-gray');
                    document.getElementById('edit-btn').classList.remove('bg-primary', 'text-white');
                }
            });
        } catch (error) {
            debugError(`åŠ è½½æ–‡ä»¶å†…å®¹æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`);
            if (previewContent) {
                previewContent.innerHTML = '<div class="text-center py-8 text-red-500">åŠ è½½æ–‡ä»¶å¤±è´¥</div>';
            }
        }
    }

    // é‡æ–°åŠ è½½é¢„è§ˆå†…å®¹ï¼ˆä¸è§¦å‘æ¨¡å¼åˆ‡æ¢ï¼‰
    function reloadPreviewContent(filePath, fileName) {
        debugLog(`é‡æ–°åŠ è½½é¢„è§ˆå†…å®¹: ${fileName}`);
        
        if (!window.bridge || !window.bridge.loadMarkdownFile) {
            debugError('Bridgeå¯¹è±¡æˆ–loadMarkdownFileæ–¹æ³•ä¸å¯ç”¨');
            return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const previewContent = document.getElementById('preview-content');
        if (previewContent) {
            previewContent.innerHTML = '<div class="flex items-center justify-center py-8"><div class="animate-spin mr-2"><span class="material-icons-outlined">refresh</span></div><span>é‡æ–°åŠ è½½ä¸­...</span></div>';
        }
        
        // è°ƒç”¨åç«¯åŠ è½½æ–‡ä»¶
        try {
            window.bridge.loadMarkdownFile(filePath, function(htmlContent) {
                debugLog(`é¢„è§ˆå†…å®¹é‡æ–°åŠ è½½å®Œæˆï¼Œé•¿åº¦: ${htmlContent.length}`);
                
                if (previewContent) {
                    if (htmlContent) {
                        previewContent.innerHTML = htmlContent;
                    } else {
                        previewContent.innerHTML = '<div class="text-center py-8 text-gray-500">æ–‡ä»¶å†…å®¹ä¸ºç©ºæˆ–åŠ è½½å¤±è´¥</div>';
                    }
                }
            });
        } catch (error) {
            debugError(`é‡æ–°åŠ è½½é¢„è§ˆå†…å®¹æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`);
            if (previewContent) {
                previewContent.innerHTML = '<div class="text-center py-8 text-red-500">é‡æ–°åŠ è½½å¤±è´¥</div>';
            }
        }
    }

    // åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼
    function switchToPreview() {
        debugLog('åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼');
        
        // å¦‚æœå½“å‰æ˜¯ç¼–è¾‘æ¨¡å¼ä¸”æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œå…ˆä¿å­˜
        if (isEditMode && hasUnsavedChanges) {
            debugLog('æ£€æµ‹åˆ°æœªä¿å­˜çš„æ›´æ”¹ï¼Œè‡ªåŠ¨ä¿å­˜...');
            saveCurrentFile(function() {
                // ä¿å­˜æˆåŠŸååˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼
                performPreviewSwitch();
            });
        } else {
            performPreviewSwitch();
        }
    }
    
    // æ‰§è¡Œé¢„è§ˆæ¨¡å¼åˆ‡æ¢
    function performPreviewSwitch() {
        debugLog('æ‰§è¡Œé¢„è§ˆæ¨¡å¼åˆ‡æ¢');
        isEditMode = false;
        
        // å¦‚æœæœ‰å½“å‰æ–‡ä»¶ï¼Œé‡æ–°åŠ è½½é¢„è§ˆå†…å®¹ï¼ˆä½†ä¸è°ƒç”¨switchToPreviewé¿å…å¾ªç¯ï¼‰
        if (currentFilePath) {
            reloadPreviewContent(currentFilePath, currentFileName);
        }
        
        document.getElementById('preview-content').classList.remove('hidden');
        document.getElementById('edit-content').classList.add('hidden');
        document.getElementById('save-btn').classList.add('hidden');
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.getElementById('preview-btn').classList.add('bg-primary', 'text-white');
        document.getElementById('preview-btn').classList.remove('bg-white', 'border-gray-300', 'text-text-gray');
        document.getElementById('edit-btn').classList.add('bg-white', 'border-gray-300', 'text-text-gray');
        document.getElementById('edit-btn').classList.remove('bg-primary', 'text-white');
        
        // éšè—æœªä¿å­˜æŒ‡ç¤ºå™¨
        hideUnsavedIndicator();
    }

    // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
    function switchToEdit() {
        debugLog('åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼');
        
        if (!currentFilePath) {
            debugLog('æ²¡æœ‰é€‰ä¸­çš„æ–‡ä»¶');
            return;
        }
        
        isEditMode = true;
        
        // åŠ è½½åŸå§‹å†…å®¹
        if (window.bridge && window.bridge.loadMarkdownRaw) {
            window.bridge.loadMarkdownRaw(currentFilePath, function(rawContent) {
                debugLog(`åŸå§‹å†…å®¹åŠ è½½å®Œæˆï¼Œé•¿åº¦: ${rawContent.length}`);
                
                const editContent = document.getElementById('edit-content');
                if (editContent) {
                    editContent.value = rawContent;
                    originalContent = rawContent;  // ä¿å­˜åŸå§‹å†…å®¹
                    hasUnsavedChanges = false;     // é‡ç½®æœªä¿å­˜çŠ¶æ€
                    
                    // æ·»åŠ å†…å®¹å˜æ›´ç›‘å¬
                    editContent.addEventListener('input', handleContentChange);
                }
                
                document.getElementById('preview-content').classList.add('hidden');
                document.getElementById('edit-content').classList.remove('hidden');
                document.getElementById('save-btn').classList.remove('hidden');
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('edit-btn').classList.add('bg-primary', 'text-white');
                document.getElementById('edit-btn').classList.remove('bg-white', 'border-gray-300', 'text-text-gray');
                document.getElementById('preview-btn').classList.add('bg-white', 'border-gray-300', 'text-text-gray');
                document.getElementById('preview-btn').classList.remove('bg-primary', 'text-white');
                
                // èšç„¦åˆ°ç¼–è¾‘å™¨
                editContent.focus();
            });
        }
    }

    // å¤„ç†å†…å®¹å˜æ›´
    function handleContentChange() {
        const editContent = document.getElementById('edit-content');
        if (editContent) {
            const currentContent = editContent.value;
            hasUnsavedChanges = (currentContent !== originalContent);
            
            if (hasUnsavedChanges) {
                showUnsavedIndicator();
                debugLog('æ£€æµ‹åˆ°å†…å®¹å˜æ›´ï¼Œæ˜¾ç¤ºæœªä¿å­˜æŒ‡ç¤ºå™¨');
            } else {
                hideUnsavedIndicator();
                debugLog('å†…å®¹ä¸åŸå§‹å†…å®¹ç›¸åŒï¼Œéšè—æœªä¿å­˜æŒ‡ç¤ºå™¨');
            }
        }
    }

    // æ˜¾ç¤ºæœªä¿å­˜æŒ‡ç¤ºå™¨
    function showUnsavedIndicator() {
        const indicator = document.getElementById('unsaved-indicator');
        if (indicator) {
            indicator.classList.remove('hidden');
        }
    }

    // éšè—æœªä¿å­˜æŒ‡ç¤ºå™¨
    function hideUnsavedIndicator() {
        const indicator = document.getElementById('unsaved-indicator');
        if (indicator) {
            indicator.classList.add('hidden');
        }
    }

    // ä¿å­˜å½“å‰æ–‡ä»¶
    function saveCurrentFile(callback) {
        debugLog('å¼€å§‹ä¿å­˜å½“å‰æ–‡ä»¶');
        
        if (!currentFilePath) {
            debugError('æ²¡æœ‰å½“å‰æ–‡ä»¶è·¯å¾„');
            return;
        }
        
        const editContent = document.getElementById('edit-content');
        if (!editContent) {
            debugError('ç¼–è¾‘å™¨å…ƒç´ æœªæ‰¾åˆ°');
            return;
        }
        
        const content = editContent.value;
        debugLog(`ä¿å­˜æ–‡ä»¶: ${currentFileName}, å†…å®¹é•¿åº¦: ${content.length}`);
        
        if (!window.bridge || !window.bridge.saveMarkdownFile) {
            debugError('Bridgeå¯¹è±¡æˆ–saveMarkdownFileæ–¹æ³•ä¸å¯ç”¨');
            return;
        }
        
        // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
        const saveBtn = document.getElementById('save-btn');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<span class="material-icons-outlined text-sm mr-1 animate-spin">refresh</span>ä¿å­˜ä¸­...';
        saveBtn.disabled = true;
        
        try {
            window.bridge.saveMarkdownFile(currentFilePath, content, function(success) {
                debugLog(`æ–‡ä»¶ä¿å­˜ç»“æœ: ${success}`);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                
                if (success) {
                    originalContent = content;  // æ›´æ–°åŸå§‹å†…å®¹
                    hasUnsavedChanges = false;  // é‡ç½®æœªä¿å­˜çŠ¶æ€
                    hideUnsavedIndicator();
                    
                    // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
                    showSaveSuccessMessage();
                    
                    debugLog('âœ… æ–‡ä»¶ä¿å­˜æˆåŠŸ');
                    
                    // å¦‚æœæœ‰å›è°ƒå‡½æ•°ï¼Œæ‰§è¡Œå®ƒ
                    if (callback && typeof callback === 'function') {
                        callback();
                    }
                } else {
                    debugError('âŒ æ–‡ä»¶ä¿å­˜å¤±è´¥');
                    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            });
        } catch (error) {
            debugError(`ä¿å­˜æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`);
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            
            alert('ä¿å­˜è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message);
        }
    }

    // æ˜¾ç¤ºä¿å­˜æˆåŠŸæ¶ˆæ¯
    function showSaveSuccessMessage() {
        const message = document.createElement('div');
        message.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        message.innerHTML = `
            <div class="flex items-center">
                <span class="material-icons-outlined text-sm mr-2">check_circle</span>
                <span>æ–‡ä»¶å·²ä¿å­˜</span>
            </div>
        `;
        document.body.appendChild(message);
        
        // 3ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            if (message.parentElement) {
                message.remove();
            }
        }, 3000);
    }

    // åˆ‡æ¢æ–‡ä»¶å¤¹å±•å¼€/æŠ˜å 
    function toggleFolder(toggleElement) {
        debugLog('åˆ‡æ¢æ–‡ä»¶å¤¹çŠ¶æ€');
        
        const folderItem = toggleElement.closest('.folder-item');
        const children = folderItem.querySelector('.folder-children');
        
        if (children) {
            const isHidden = children.classList.contains('hidden');
            
            if (isHidden) {
                children.classList.remove('hidden');
                toggleElement.textContent = 'expand_more';
            } else {
                children.classList.add('hidden');
                toggleElement.textContent = 'chevron_right';
            }
        }
    }

    // æ‹–æ‹½å¤„ç†å‡½æ•°
    let draggedElement = null;

    function handleDragStart(e) {
        draggedElement = this.closest('li');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', draggedElement.outerHTML);
        
        const path = draggedElement.getAttribute('data-path');
        const name = draggedElement.getAttribute('data-name');
        debugLog(`å¼€å§‹æ‹–æ‹½: ${name} - ${path}`);
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(e) {
        const targetItem = this.closest('li');
        const targetType = targetItem.getAttribute('data-type');
        
        if (targetType === 'folder' && targetItem !== draggedElement) {
            this.classList.add('drag-over');
        }
    }

    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        const targetItem = this.closest('li');
        const targetType = targetItem.getAttribute('data-type');
        const targetPath = targetItem.getAttribute('data-path');
        
        if (targetType === 'folder' && targetItem !== draggedElement && draggedElement) {
            const sourcePath = draggedElement.getAttribute('data-path');
            const sourceName = draggedElement.getAttribute('data-name');
            
            debugLog(`æ‹–æ‹½ç§»åŠ¨: ${sourceName} -> ${targetPath}`);
            
            // è°ƒç”¨åç«¯ç§»åŠ¨æ–‡ä»¶
            if (window.bridge && window.bridge.moveFileOrFolder) {
                window.bridge.moveFileOrFolder(sourcePath, targetPath, function(success) {
                    if (success) {
                        debugLog('æ–‡ä»¶ç§»åŠ¨æˆåŠŸ');
                        loadFileStructure(); // é‡æ–°åŠ è½½æ–‡ä»¶ç»“æ„
                    } else {
                        debugError('æ–‡ä»¶ç§»åŠ¨å¤±è´¥');
                    }
                });
            }
        }
        
        draggedElement = null;
    }

    // å³é”®èœå•åŠŸèƒ½
    function showContextMenu(e, path, type, name) {
        e.preventDefault();
        
        const contextMenu = document.getElementById('context-menu');
        contextMenuTarget = { path, type, name };
        
        contextMenu.style.left = e.pageX + 'px';
        contextMenu.style.top = e.pageY + 'px';
        contextMenu.classList.remove('hidden');
        
        debugLog(`æ˜¾ç¤ºå³é”®èœå•: ${name} (${type})`);
    }

    function hideContextMenu() {
        const contextMenu = document.getElementById('context-menu');
        contextMenu.classList.add('hidden');
        contextMenuTarget = null;
    }

    function contextMenuAction(action) {
        if (!contextMenuTarget) return;
        
        const { path, type, name } = contextMenuTarget;
        debugLog(`å³é”®èœå•æ“ä½œ: ${action} - ${name}`);
        
        switch (action) {
            case 'rename':
                renameItem(path, name);
                break;
            case 'delete':
                deleteItem(path, name);
                break;
            case 'newNote':
                createNewNote(path);
                break;
            case 'newFolder':
                createNewFolder(path);
                break;
        }
        
        hideContextMenu();
    }

    // é‡å‘½ååŠŸèƒ½
    function renameItem(path, currentName) {
        const newName = prompt('è¯·è¾“å…¥æ–°åç§°:', currentName);
        if (newName && newName !== currentName) {
            debugLog(`é‡å‘½å: ${currentName} -> ${newName}`);
            
            if (window.bridge && window.bridge.renameFileOrFolder) {
                window.bridge.renameFileOrFolder(path, newName, function(success) {
                    if (success) {
                        debugLog('é‡å‘½åæˆåŠŸ');
                        loadFileStructure();
                    } else {
                        debugError('é‡å‘½åå¤±è´¥');
                        alert('é‡å‘½åå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç§°æ˜¯å¦å·²å­˜åœ¨');
                    }
                });
            }
        }
    }

    // åˆ é™¤åŠŸèƒ½
    function deleteItem(path, name) {
        if (confirm(`ç¡®å®šè¦åˆ é™¤ "${name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
            debugLog(`åˆ é™¤: ${name}`);
            
            if (window.bridge && window.bridge.deleteFileOrFolder) {
                window.bridge.deleteFileOrFolder(path, function(success) {
                    if (success) {
                        debugLog('åˆ é™¤æˆåŠŸ');
                        loadFileStructure();
                    } else {
                        debugError('åˆ é™¤å¤±è´¥');
                        alert('åˆ é™¤å¤±è´¥');
                    }
                });
            }
        }
    }

    // æ–‡ä»¶æ“ä½œå‡½æ•°
    function createNewNote(parentPath = 'vault') {
        debugLog('åˆ›å»ºæ–°ç¬”è®°');
        if (window.bridge && window.bridge.createNewNote) {
            window.bridge.createNewNote(parentPath, function(result) {
                debugLog('æ–°ç¬”è®°åˆ›å»ºç»“æœ: ' + result);
                if (result) {
                    loadFileStructure();
                }
            });
        }
    }

    function createNewFolder(parentPath = 'vault') {
        debugLog('åˆ›å»ºæ–°æ–‡ä»¶å¤¹');
        if (window.bridge && window.bridge.createNewFolder) {
            window.bridge.createNewFolder(parentPath, function(result) {
                debugLog('æ–°æ–‡ä»¶å¤¹åˆ›å»ºç»“æœ: ' + result);
                if (result) {
                    loadFileStructure();
                }
            });
        }
    }

    // éªŒè¯åç«¯åŠŸèƒ½
    function validateBackendFunctions() {
        debugLog('ğŸ” å¼€å§‹éªŒè¯åç«¯åŠŸèƒ½');
        
        if (!window.bridge || typeof window.bridge.validateAllFileOperations !== 'function') {
            debugError('âŒ Bridgeå¯¹è±¡æˆ–validateAllFileOperationsæ–¹æ³•ä¸å¯ç”¨');
            alert('âŒ æ— æ³•è¿æ¥åˆ°åç«¯éªŒè¯æœåŠ¡');
            return;
        }
        
        // æ˜¾ç¤ºéªŒè¯å¼€å§‹æç¤º
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'validation-loading';
        loadingDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        loadingDiv.innerHTML = `
            <div class="flex items-center">
                <div class="animate-spin mr-2">
                    <span class="material-icons-outlined">refresh</span>
                </div>
                <span>æ­£åœ¨éªŒè¯åç«¯åŠŸèƒ½...</span>
            </div>
        `;
        document.body.appendChild(loadingDiv);
        
        debugLog('è°ƒç”¨åç«¯éªŒè¯åŠŸèƒ½...');
        
        try {
            window.bridge.validateAllFileOperations(function(result) {
                debugLog('ğŸ¯ åç«¯éªŒè¯å®Œæˆ');
                debugLog('éªŒè¯ç»“æœ: ' + result);
                
                // ç§»é™¤åŠ è½½æç¤º
                const loadingElement = document.getElementById('validation-loading');
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                // æ˜¾ç¤ºéªŒè¯ç»“æœ
                const resultDiv = document.createElement('div');
                resultDiv.className = 'fixed top-4 right-4 bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-w-md p-4';
                resultDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-800">åç«¯åŠŸèƒ½éªŒè¯ç»“æœ</h3>
                        <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                            <span class="material-icons-outlined text-sm">close</span>
                        </button>
                    </div>
                    <div class="text-sm text-gray-600 whitespace-pre-line max-h-64 overflow-y-auto">
                        ${result}
                    </div>
                `;
                document.body.appendChild(resultDiv);
                
                // 10ç§’åè‡ªåŠ¨å…³é—­
                setTimeout(() => {
                    if (resultDiv.parentElement) {
                        resultDiv.remove();
                    }
                }, 10000);
                
                // é‡æ–°åŠ è½½æ–‡ä»¶ç»“æ„ä»¥åæ˜ ä»»ä½•æ›´æ”¹
                loadFileStructure();
            });
        } catch (error) {
            debugError('è°ƒç”¨åç«¯éªŒè¯æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            
            // ç§»é™¤åŠ è½½æç¤º
            const loadingElement = document.getElementById('validation-loading');
            if (loadingElement) {
                loadingElement.remove();
            }
            
            alert('âŒ éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message);
        }
    }

    // æµ‹è¯•Bridgeè¿æ¥
    function testBridgeConnection() {
        debugLog('=== å¼€å§‹æµ‹è¯•Bridgeè¿æ¥ ===');
        
        // 1. æ£€æŸ¥window.bridge
        if (typeof window.bridge === 'undefined') {
            debugError('âŒ window.bridge æœªå®šä¹‰');
            alert('âŒ window.bridge æœªå®šä¹‰');
            return;
        }
        debugLog('âœ… window.bridge å­˜åœ¨');
        
        // 2. æ£€æŸ¥extractKnowledgePointsæ–¹æ³•
        if (typeof window.bridge.extractKnowledgePoints !== 'function') {
            debugError('âŒ extractKnowledgePoints æ–¹æ³•ä¸å­˜åœ¨');
            alert('âŒ extractKnowledgePoints æ–¹æ³•ä¸å­˜åœ¨');
            return;
        }
        debugLog('âœ… extractKnowledgePoints æ–¹æ³•å­˜åœ¨');
        
        // 3. æµ‹è¯•ç®€å•è°ƒç”¨
        try {
            debugLog('æµ‹è¯•è°ƒç”¨extractKnowledgePoints...');
            window.bridge.extractKnowledgePoints('test_path', function(result) {
                debugLog(`æµ‹è¯•è°ƒç”¨æˆåŠŸï¼Œæ”¶åˆ°ç»“æœ: ${result}`);
                alert(`âœ… Bridgeè¿æ¥æ­£å¸¸ï¼æ”¶åˆ°ç»“æœé•¿åº¦: ${result ? result.length : 'null'}`);
            });
        } catch (error) {
            debugError(`âŒ æµ‹è¯•è°ƒç”¨å¤±è´¥: ${error.message}`);
            alert(`âŒ æµ‹è¯•è°ƒç”¨å¤±è´¥: ${error.message}`);
        }
        
        debugLog('=== Bridgeè¿æ¥æµ‹è¯•å®Œæˆ ===');
    }

    // æå–çŸ¥è¯†ç‚¹åŠŸèƒ½
    function extractKnowledgePoints() {
        addToDebugPanel('INFO', '=== å¼€å§‹çŸ¥è¯†ç‚¹æå–æµç¨‹ ===');
        debugLog('å¼€å§‹æå–çŸ¥è¯†ç‚¹');
        
        // è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
        addToDebugPanel('INFO', `å½“å‰æ–‡ä»¶è·¯å¾„: ${currentFilePath}`);
        addToDebugPanel('INFO', `å½“å‰æ–‡ä»¶å: ${currentFileName}`);
        addToDebugPanel('INFO', `Bridgeå¯¹è±¡å­˜åœ¨: ${!!window.bridge}`);
        addToDebugPanel('INFO', `extractKnowledgePointsæ–¹æ³•å­˜åœ¨: ${!!(window.bridge && window.bridge.extractKnowledgePoints)}`);
        
        debugLog(`å½“å‰æ–‡ä»¶è·¯å¾„: ${currentFilePath}`);
        debugLog(`å½“å‰æ–‡ä»¶å: ${currentFileName}`);
        debugLog(`Bridgeå¯¹è±¡å­˜åœ¨: ${!!window.bridge}`);
        debugLog(`extractKnowledgePointsæ–¹æ³•å­˜åœ¨: ${!!(window.bridge && window.bridge.extractKnowledgePoints)}`);
        
        if (!currentFilePath) {
            addToDebugPanel('ERROR', 'æ²¡æœ‰é€‰ä¸­çš„æ–‡ä»¶ï¼Œæ— æ³•æå–çŸ¥è¯†ç‚¹');
            debugError('æ²¡æœ‰é€‰ä¸­çš„æ–‡ä»¶');
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡æ¡£æ–‡ä»¶');
            return;
        }
        
        if (!window.bridge || !window.bridge.extractKnowledgePoints) {
            addToDebugPanel('ERROR', 'Bridgeå¯¹è±¡æˆ–extractKnowledgePointsæ–¹æ³•ä¸å¯ç”¨');
            addToDebugPanel('ERROR', `window.bridge: ${window.bridge}`);
            addToDebugPanel('ERROR', `window.bridge.extractKnowledgePoints: ${window.bridge ? window.bridge.extractKnowledgePoints : 'bridgeä¸å­˜åœ¨'}`);
            debugError('Bridgeå¯¹è±¡æˆ–extractKnowledgePointsæ–¹æ³•ä¸å¯ç”¨');
            debugError(`window.bridge: ${window.bridge}`);
            debugError(`window.bridge.extractKnowledgePoints: ${window.bridge ? window.bridge.extractKnowledgePoints : 'bridgeä¸å­˜åœ¨'}`);
            alert('çŸ¥è¯†ç‚¹æå–åŠŸèƒ½ä¸å¯ç”¨');
            return;
        }
        
        // æ¸…ç©ºä¹‹å‰çš„çŸ¥è¯†ç‚¹ç»“æœ
        addToDebugPanel('INFO', 'æ¸…ç©ºä¹‹å‰çš„çŸ¥è¯†ç‚¹ç»“æœ');
        const contentDiv = document.getElementById('knowledge-content');
        if (contentDiv) {
            contentDiv.innerHTML = '';
            contentDiv.classList.add('hidden');
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showKnowledgeLoading();
        
        // ç¦ç”¨æå–æŒ‰é’®
        const extractBtn = document.getElementById('extract-btn');
        if (extractBtn) {
            extractBtn.style.opacity = '0.5';
            extractBtn.style.pointerEvents = 'none';
        }
        
        debugLog(`å¼€å§‹æå–æ–‡ä»¶çŸ¥è¯†ç‚¹: ${currentFileName}`);
        
        try {
            addToDebugPanel('INFO', `å‡†å¤‡è°ƒç”¨bridge.extractKnowledgePointsï¼Œæ–‡ä»¶è·¯å¾„: ${currentFilePath}`);
            debugLog(`è°ƒç”¨bridge.extractKnowledgePointsï¼Œæ–‡ä»¶è·¯å¾„: ${currentFilePath}`);
            
            window.bridge.extractKnowledgePoints(currentFilePath, function(resultJson) {
                addToDebugPanel('SUCCESS', 'çŸ¥è¯†ç‚¹æå–å›è°ƒå‡½æ•°è¢«è§¦å‘');
                addToDebugPanel('INFO', `å›è°ƒç»“æœé•¿åº¦: ${resultJson ? resultJson.length : 'null'}`);
                addToDebugPanel('INFO', `åŸå§‹ç»“æœå‰200å­—ç¬¦: ${resultJson ? resultJson.substring(0, 200) : 'null'}`);
                
                debugLog(`çŸ¥è¯†ç‚¹æå–å›è°ƒè§¦å‘ï¼Œç»“æœé•¿åº¦: ${resultJson ? resultJson.length : 'null'}`);
                debugLog(`åŸå§‹ç»“æœå‰200å­—ç¬¦: ${resultJson ? resultJson.substring(0, 200) : 'null'}`);
                
                if (!resultJson) {
                    addToDebugPanel('ERROR', 'æ”¶åˆ°ç©ºçš„APIç»“æœ');
                    debugError('æ”¶åˆ°ç©ºçš„ç»“æœ');
                    showKnowledgeError('æ”¶åˆ°ç©ºçš„æå–ç»“æœ');
                    return;
                }
                
                try {
                    addToDebugPanel('INFO', 'å¼€å§‹è§£æJSONç»“æœ');
                    const result = JSON.parse(resultJson);
                    
                    addToDebugPanel('SUCCESS', `JSONè§£ææˆåŠŸï¼Œç»“æœç±»å‹: ${typeof result}`);
                    addToDebugPanel('INFO', `ç»“æœæ˜¯å¦ä¸ºæ•°ç»„: ${Array.isArray(result)}`);
                    addToDebugPanel('INFO', `ç»“æœåŒ…å«çš„é”®: ${Object.keys(result)}`);
                    addToDebugPanel('INFO', `successå­—æ®µ: ${result.success}`);
                    addToDebugPanel('INFO', `knowledge_pointså­—æ®µå­˜åœ¨: ${!!result.knowledge_points}`);
                    addToDebugPanel('INFO', `knowledge_pointsé•¿åº¦: ${result.knowledge_points ? result.knowledge_points.length : 'undefined'}`);
                    
                    debugLog(`JSONè§£ææˆåŠŸï¼Œç»“æœç±»å‹: ${typeof result}`);
                    debugLog(`ç»“æœåŒ…å«çš„é”®: ${Object.keys(result)}`);
                    debugLog(`successå­—æ®µ: ${result.success}`);
                    debugLog(`knowledge_pointsé•¿åº¦: ${result.knowledge_points ? result.knowledge_points.length : 'undefined'}`);
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç›´æ¥è¿”å›çš„çŸ¥è¯†ç‚¹æ•°ç»„æ ¼å¼
                    if (Array.isArray(result)) {
                        addToDebugPanel('INFO', `æ£€æµ‹åˆ°æ•°ç»„æ ¼å¼ï¼ŒåŒ…å« ${result.length} ä¸ªå…ƒç´ `);
                        addToDebugPanel('INFO', 'è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼');
                        
                        // è½¬æ¢æ•°ç»„æ ¼å¼ä¸ºæ ‡å‡†æ ¼å¼
                        const convertedResult = {
                            success: true,
                            knowledge_points: result.map(item => ({
                                name: item.title || item.name || item.concept_name || 'æœªå‘½åçŸ¥è¯†ç‚¹',
                                description: item.content || item.description || item.core_definition || 'æ— æè¿°',
                                category: item.category || '',
                                importance: item.importance || 'ä¸­ç­‰'
                            })),
                            total_count: result.length
                        };
                        
                        addToDebugPanel('SUCCESS', `è½¬æ¢å®Œæˆï¼ŒåŒ…å« ${convertedResult.knowledge_points.length} ä¸ªçŸ¥è¯†ç‚¹`);
                        addToDebugPanel('INFO', 'è½¬æ¢åçš„çŸ¥è¯†ç‚¹è¯¦æƒ…:');
                        convertedResult.knowledge_points.forEach((point, index) => {
                            addToDebugPanel('INFO', `  çŸ¥è¯†ç‚¹${index + 1}: ${point.name} - ${point.description}`);
                        });
                        
                        displayKnowledgePoints(convertedResult);
                    } else {
                        // æ ‡å‡†å¯¹è±¡æ ¼å¼
                        if (result.knowledge_points && result.knowledge_points.length > 0) {
                            addToDebugPanel('INFO', 'æ ‡å‡†å¯¹è±¡æ ¼å¼ï¼ŒçŸ¥è¯†ç‚¹è¯¦æƒ…:');
                            result.knowledge_points.forEach((point, index) => {
                                addToDebugPanel('INFO', `  çŸ¥è¯†ç‚¹${index + 1}: ${JSON.stringify(point)}`);
                            });
                        }
                        
                        displayKnowledgePoints(result);
                    }
                } catch (parseError) {
                    addToDebugPanel('ERROR', `JSONè§£æå¤±è´¥: ${parseError.message}`);
                    addToDebugPanel('ERROR', `åŸå§‹ç»“æœ: ${resultJson}`);
                    debugError(`è§£æçŸ¥è¯†ç‚¹ç»“æœå¤±è´¥: ${parseError.message}`);
                    debugError(`åŸå§‹ç»“æœ: ${resultJson}`);
                    showKnowledgeError('è§£æçŸ¥è¯†ç‚¹ç»“æœå¤±è´¥: ' + parseError.message);
                }
                
                // æ¢å¤æå–æŒ‰é’®
                if (extractBtn) {
                    extractBtn.style.opacity = '1';
                    extractBtn.style.pointerEvents = 'auto';
                }
            });
        } catch (error) {
            debugError(`æå–çŸ¥è¯†ç‚¹æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`);
            showKnowledgeError('æå–çŸ¥è¯†ç‚¹æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            
            // æ¢å¤æå–æŒ‰é’®
            if (extractBtn) {
                extractBtn.style.opacity = '1';
                extractBtn.style.pointerEvents = 'auto';
            }
        }
    }

    // æ˜¾ç¤ºçŸ¥è¯†ç‚¹åŠ è½½çŠ¶æ€
    function showKnowledgeLoading() {
        const placeholderDiv = document.getElementById('knowledge-placeholder');
        const contentDiv = document.getElementById('knowledge-content');
        const loadingDiv = document.getElementById('knowledge-loading');
        
        if (placeholderDiv) placeholderDiv.classList.add('hidden');
        if (contentDiv) contentDiv.classList.add('hidden');
        if (loadingDiv) loadingDiv.classList.remove('hidden');
    }

    // æ˜¾ç¤ºçŸ¥è¯†ç‚¹å†…å®¹
    function displayKnowledgePoints(result) {
        addToDebugPanel('INFO', '=== å¼€å§‹æ˜¾ç¤ºçŸ¥è¯†ç‚¹å†…å®¹ ===');
        debugLog('æ˜¾ç¤ºçŸ¥è¯†ç‚¹å†…å®¹');
        debugLog(`ä¼ å…¥çš„result: ${JSON.stringify(result)}`);
        
        const loadingDiv = document.getElementById('knowledge-loading');
        const contentDiv = document.getElementById('knowledge-content');
        const placeholderDiv = document.getElementById('knowledge-placeholder');
        
        addToDebugPanel('INFO', `DOMå…ƒç´ æ£€æŸ¥ - loading: ${!!loadingDiv}, content: ${!!contentDiv}, placeholder: ${!!placeholderDiv}`);
        debugLog(`DOMå…ƒç´ æ£€æŸ¥ - loading: ${!!loadingDiv}, content: ${!!contentDiv}, placeholder: ${!!placeholderDiv}`);
        
        // éšè—åŠ è½½çŠ¶æ€
        if (loadingDiv) {
            loadingDiv.classList.add('hidden');
            addToDebugPanel('INFO', 'éšè—åŠ è½½çŠ¶æ€');
        }
        if (placeholderDiv) {
            placeholderDiv.classList.add('hidden');
            addToDebugPanel('INFO', 'éšè—å ä½ç¬¦');
        }
        
        addToDebugPanel('INFO', `result.success: ${result.success}`);
        addToDebugPanel('INFO', `result.knowledge_pointså­˜åœ¨: ${!!result.knowledge_points}`);
        addToDebugPanel('INFO', `result.knowledge_pointsé•¿åº¦: ${result.knowledge_points ? result.knowledge_points.length : 'undefined'}`);
        
        debugLog(`result.success: ${result.success}`);
        debugLog(`result.knowledge_pointså­˜åœ¨: ${!!result.knowledge_points}`);
        debugLog(`result.knowledge_pointsé•¿åº¦: ${result.knowledge_points ? result.knowledge_points.length : 'undefined'}`);
        
        if (result.success && result.knowledge_points && result.knowledge_points.length > 0) {
            addToDebugPanel('SUCCESS', `å‡†å¤‡æ˜¾ç¤º ${result.knowledge_points.length} ä¸ªçŸ¥è¯†ç‚¹`);
            const knowledgePoints = result.knowledge_points;
            debugLog(`æˆåŠŸæå– ${knowledgePoints.length} ä¸ªçŸ¥è¯†ç‚¹`);
            
            // ç”ŸæˆçŸ¥è¯†ç‚¹HTML - åƒç´ çº§è¿˜åŸè®¾è®¡ç¨¿
            let html = `
                <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex items-center text-green-800">
                        <span class="material-icons-outlined text-sm mr-2">check_circle</span>
                        <span class="font-medium">æˆåŠŸæå– ${knowledgePoints.length} ä¸ªçŸ¥è¯†ç‚¹</span>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto space-y-3">
            `;
            
            knowledgePoints.forEach((point, index) => {
                // ç¬¬ä¸€ä¸ªçŸ¥è¯†ç‚¹ä½¿ç”¨ç»¿è‰²ä¸»é¢˜ï¼Œå…¶ä»–ä½¿ç”¨ç°è‰²ä¸»é¢˜ï¼ˆå®Œå…¨æŒ‰ç…§è®¾è®¡ç¨¿ï¼‰
                const isFirst = index === 0;
                const bgClass = isFirst ? 'bg-bg-light-green' : 'bg-bg-light-gray';
                const titleClass = isFirst ? 'text-primary' : 'text-text-dark-brown';
                
                html += `
                    <div class="knowledge-point-item ${bgClass} p-3 rounded-lg cursor-pointer hover:shadow-md transition-shadow relative group" 
                         data-point-name="${point.name.replace(/"/g, '&quot;')}" 
                         data-point-description="${point.description.replace(/"/g, '&quot;')}"
                         data-point-index="${index}">
                        <h3 class="font-semibold ${titleClass}">${point.name}</h3>
                        <p class="text-sm text-text-medium-brown mt-1">${point.description}</p>
                        
                        <!-- æ‚¬åœæ—¶æ˜¾ç¤ºçš„æ“ä½œæŒ‰é’® -->
                        <div class="knowledge-point-actions absolute -bottom-10 left-1/2 transform -translate-x-1/2 
                                    bg-white border border-gray-200 rounded-lg shadow-lg px-2 py-1 
                                    opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10 
                                    flex items-center space-x-2">
                            <button class="edit-knowledge-btn p-1 text-text-gray hover:text-primary transition-colors" 
                                    title="ç¼–è¾‘çŸ¥è¯†ç‚¹" data-index="${index}">
                                <span class="material-icons-outlined text-sm">edit</span>
                            </button>
                            <button class="delete-knowledge-btn p-1 text-text-gray hover:text-danger transition-colors" 
                                    title="åˆ é™¤çŸ¥è¯†ç‚¹" data-index="${index}">
                                <span class="material-icons-outlined text-sm">delete</span>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <!-- æ‰‹åŠ¨æ·»åŠ çŸ¥è¯†ç‚¹æŒ‰é’® -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <button id="add-knowledge-btn" class="w-full flex items-center justify-center py-2 px-3 
                                                           border-2 border-dashed border-gray-300 rounded-lg 
                                                           text-text-gray hover:border-primary hover:text-primary 
                                                           transition-colors duration-200">
                        <span class="material-icons-outlined mr-2">add</span>
                        <span>æ‰‹åŠ¨æ·»åŠ çŸ¥è¯†ç‚¹</span>
                    </button>
                </div>
            `;
            
            if (contentDiv) {
                contentDiv.innerHTML = html;
                contentDiv.classList.remove('hidden');
                
                // ç»‘å®šçŸ¥è¯†ç‚¹äº¤äº’äº‹ä»¶
                bindKnowledgePointEvents();
            }
            
        } else {
            const errorMsg = result.error || 'æœªèƒ½æå–åˆ°çŸ¥è¯†ç‚¹';
            debugError(`çŸ¥è¯†ç‚¹æå–å¤±è´¥: ${errorMsg}`);
            showKnowledgeError(errorMsg);
        }
    }

    // ç»‘å®šçŸ¥è¯†ç‚¹äº¤äº’äº‹ä»¶
    function bindKnowledgePointEvents() {
        addToDebugPanel('INFO', 'ç»‘å®šçŸ¥è¯†ç‚¹äº¤äº’äº‹ä»¶');
        
        // 1. ç‚¹å‡»çŸ¥è¯†ç‚¹é«˜äº®æ–‡æ¡£å†…å®¹
        const knowledgeItems = document.querySelectorAll('.knowledge-point-item');
        knowledgeItems.forEach(item => {
            item.addEventListener('click', function(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯æ“ä½œæŒ‰é’®ï¼Œä¸è§¦å‘é«˜äº®åŠŸèƒ½
                if (e.target.closest('.knowledge-point-actions')) {
                    return;
                }
                
                const pointName = this.dataset.pointName;
                addToDebugPanel('INFO', `ç‚¹å‡»çŸ¥è¯†ç‚¹: ${pointName}`);
                highlightTextInDocument(pointName);
            });
        });
        
        // 2. ç¼–è¾‘çŸ¥è¯†ç‚¹æŒ‰é’®
        const editBtns = document.querySelectorAll('.edit-knowledge-btn');
        editBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const index = parseInt(this.dataset.index);
                editKnowledgePoint(index);
            });
        });
        
        // 3. åˆ é™¤çŸ¥è¯†ç‚¹æŒ‰é’®
        const deleteBtns = document.querySelectorAll('.delete-knowledge-btn');
        deleteBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const index = parseInt(this.dataset.index);
                deleteKnowledgePoint(index);
            });
        });
        
        // 4. æ‰‹åŠ¨æ·»åŠ çŸ¥è¯†ç‚¹æŒ‰é’®
        const addBtn = document.getElementById('add-knowledge-btn');
        if (addBtn) {
            addBtn.addEventListener('click', function() {
                showAddKnowledgePointModal();
            });
        }
    }
    
    // é«˜äº®æ–‡æ¡£ä¸­çš„æ–‡æœ¬
    function highlightTextInDocument(searchText) {
        addToDebugPanel('INFO', `åœ¨æ–‡æ¡£ä¸­æœç´¢å¹¶é«˜äº®: ${searchText}`);
        
        const previewContent = document.getElementById('preview-content');
        if (!previewContent) {
            addToDebugPanel('WARN', 'é¢„è§ˆå†…å®¹åŒºåŸŸä¸å­˜åœ¨');
            return;
        }
        
        // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
        clearHighlights();
        
        // æœç´¢å¹¶é«˜äº®æ–‡æœ¬
        const walker = document.createTreeWalker(
            previewContent,
            NodeFilter.SHOW_TEXT,
            null,
            false
        );
        
        const textNodes = [];
        let node;
        while (node = walker.nextNode()) {
            if (node.textContent.includes(searchText)) {
                textNodes.push(node);
            }
        }
        
        if (textNodes.length === 0) {
            addToDebugPanel('WARN', `æœªåœ¨æ–‡æ¡£ä¸­æ‰¾åˆ°æ–‡æœ¬: ${searchText}`);
            return;
        }
        
        addToDebugPanel('SUCCESS', `æ‰¾åˆ° ${textNodes.length} ä¸ªåŒ¹é…é¡¹`);
        
        // é«˜äº®æ‰€æœ‰åŒ¹é…çš„æ–‡æœ¬
        textNodes.forEach((textNode, index) => {
            const parent = textNode.parentNode;
            const text = textNode.textContent;
            const highlightedText = text.replace(
                new RegExp(searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'),
                `<mark class="bg-yellow-200 px-1 rounded" data-highlight-index="${index}">$&</mark>`
            );
            
            const wrapper = document.createElement('span');
            wrapper.innerHTML = highlightedText;
            parent.replaceChild(wrapper, textNode);
        });
        
        // æ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªé«˜äº®ä½ç½®
        const firstHighlight = previewContent.querySelector('mark[data-highlight-index="0"]');
        if (firstHighlight) {
            firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
            addToDebugPanel('SUCCESS', 'å·²å®šä½åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹');
        }
    }
    
    // æ¸…é™¤æ–‡æ¡£ä¸­çš„é«˜äº®
    function clearHighlights() {
        const previewContent = document.getElementById('preview-content');
        if (!previewContent) return;
        
        const highlights = previewContent.querySelectorAll('mark[data-highlight-index]');
        highlights.forEach(mark => {
            const parent = mark.parentNode;
            parent.replaceChild(document.createTextNode(mark.textContent), mark);
            parent.normalize(); // åˆå¹¶ç›¸é‚»çš„æ–‡æœ¬èŠ‚ç‚¹
        });
    }
    
    // ç¼–è¾‘çŸ¥è¯†ç‚¹
    function editKnowledgePoint(index) {
        addToDebugPanel('INFO', `ç¼–è¾‘çŸ¥è¯†ç‚¹ ${index}`);
        
        const knowledgeItem = document.querySelector(`[data-point-index="${index}"]`);
        if (!knowledgeItem) return;
        
        const currentName = knowledgeItem.dataset.pointName;
        const currentDescription = knowledgeItem.dataset.pointDescription;
        
        // åˆ›å»ºç¼–è¾‘æ¨¡æ€æ¡†
        showEditKnowledgePointModal(index, currentName, currentDescription);
    }
    
    // åˆ é™¤çŸ¥è¯†ç‚¹
    function deleteKnowledgePoint(index) {
        addToDebugPanel('INFO', `åˆ é™¤çŸ¥è¯†ç‚¹ ${index}`);
        
        const knowledgeItem = document.querySelector(`[data-point-index="${index}"]`);
        if (!knowledgeItem) return;
        
        const pointName = knowledgeItem.dataset.pointName;
        
        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        showDeleteConfirmModal(index, pointName);
    }
    
    // æ˜¾ç¤ºæ·»åŠ çŸ¥è¯†ç‚¹æ¨¡æ€æ¡†
    function showAddKnowledgePointModal() {
        addToDebugPanel('INFO', 'æ˜¾ç¤ºæ·»åŠ çŸ¥è¯†ç‚¹æ¨¡æ€æ¡†');
        
        const modal = createKnowledgePointModal({
            title: 'æ·»åŠ çŸ¥è¯†ç‚¹',
            nameValue: '',
            descriptionValue: '',
            confirmText: 'æ·»åŠ ',
            onConfirm: (name, description) => {
                addNewKnowledgePoint(name, description);
            }
        });
        
        document.body.appendChild(modal);
    }
    
    // æ˜¾ç¤ºç¼–è¾‘çŸ¥è¯†ç‚¹æ¨¡æ€æ¡†
    function showEditKnowledgePointModal(index, currentName, currentDescription) {
        addToDebugPanel('INFO', `æ˜¾ç¤ºç¼–è¾‘çŸ¥è¯†ç‚¹æ¨¡æ€æ¡†: ${currentName}`);
        
        const modal = createKnowledgePointModal({
            title: 'ç¼–è¾‘çŸ¥è¯†ç‚¹',
            nameValue: currentName,
            descriptionValue: currentDescription,
            confirmText: 'ä¿å­˜',
            onConfirm: (name, description) => {
                updateKnowledgePoint(index, name, description);
            }
        });
        
        document.body.appendChild(modal);
    }
    
    // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
    function showDeleteConfirmModal(index, pointName) {
        addToDebugPanel('INFO', `æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†: ${pointName}`);
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex items-center mb-4">
                    <span class="material-icons-outlined text-danger mr-3">warning</span>
                    <h3 class="text-lg font-semibold text-text-dark-brown">ç¡®è®¤åˆ é™¤</h3>
                </div>
                <p class="text-text-medium-brown mb-6">
                    ç¡®å®šè¦åˆ é™¤çŸ¥è¯†ç‚¹ "<strong>${pointName}</strong>" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚
                </p>
                <div class="flex justify-end space-x-3">
                    <button class="cancel-btn px-4 py-2 text-text-gray border border-gray-300 rounded-lg hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button class="confirm-btn px-4 py-2 bg-danger text-white rounded-lg hover:bg-red-600">
                        åˆ é™¤
                    </button>
                </div>
            </div>
        `;
        
        // ç»‘å®šäº‹ä»¶
        const cancelBtn = modal.querySelector('.cancel-btn');
        const confirmBtn = modal.querySelector('.confirm-btn');
        
        cancelBtn.addEventListener('click', () => {
            document.body.removeChild(modal);
        });
        
        confirmBtn.addEventListener('click', () => {
            removeKnowledgePoint(index);
            document.body.removeChild(modal);
        });
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
        
        document.body.appendChild(modal);
    }
    
    // åˆ›å»ºçŸ¥è¯†ç‚¹ç¼–è¾‘æ¨¡æ€æ¡†
    function createKnowledgePointModal({ title, nameValue, descriptionValue, confirmText, onConfirm }) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <h3 class="text-lg font-semibold text-text-dark-brown mb-4">${title}</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-text-dark-brown mb-2">çŸ¥è¯†ç‚¹åç§°</label>
                        <input type="text" class="knowledge-name-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                               placeholder="è¯·è¾“å…¥çŸ¥è¯†ç‚¹åç§°" value="${nameValue}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-dark-brown mb-2">çŸ¥è¯†ç‚¹æè¿°</label>
                        <textarea class="knowledge-desc-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                                  rows="3" placeholder="è¯·è¾“å…¥çŸ¥è¯†ç‚¹æè¿°">${descriptionValue}</textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button class="cancel-btn px-4 py-2 text-text-gray border border-gray-300 rounded-lg hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button class="confirm-btn px-4 py-2 bg-primary text-white rounded-lg hover:bg-green-600">
                        ${confirmText}
                    </button>
                </div>
            </div>
        `;
        
        // ç»‘å®šäº‹ä»¶
        const nameInput = modal.querySelector('.knowledge-name-input');
        const descInput = modal.querySelector('.knowledge-desc-input');
        const cancelBtn = modal.querySelector('.cancel-btn');
        const confirmBtn = modal.querySelector('.confirm-btn');
        
        cancelBtn.addEventListener('click', () => {
            document.body.removeChild(modal);
        });
        
        confirmBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            const description = descInput.value.trim();
            
            if (!name) {
                alert('è¯·è¾“å…¥çŸ¥è¯†ç‚¹åç§°');
                nameInput.focus();
                return;
            }
            
            if (!description) {
                alert('è¯·è¾“å…¥çŸ¥è¯†ç‚¹æè¿°');
                descInput.focus();
                return;
            }
            
            onConfirm(name, description);
            document.body.removeChild(modal);
        });
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
        
        // è‡ªåŠ¨èšç„¦åˆ°åç§°è¾“å…¥æ¡†
        setTimeout(() => {
            nameInput.focus();
            nameInput.select();
        }, 100);
        
        return modal;
    }
    
    // æ·»åŠ æ–°çŸ¥è¯†ç‚¹
    function addNewKnowledgePoint(name, description) {
        addToDebugPanel('SUCCESS', `æ·»åŠ æ–°çŸ¥è¯†ç‚¹: ${name}`);
        
        // è·å–å½“å‰çŸ¥è¯†ç‚¹åˆ—è¡¨
        const knowledgeItems = document.querySelectorAll('.knowledge-point-item');
        const newIndex = knowledgeItems.length;
        
        // åˆ›å»ºæ–°çŸ¥è¯†ç‚¹HTML
        const newPointHtml = `
            <div class="knowledge-point-item bg-bg-light-gray p-3 rounded-lg cursor-pointer hover:shadow-md transition-shadow relative group" 
                 data-point-name="${name.replace(/"/g, '&quot;')}" 
                 data-point-description="${description.replace(/"/g, '&quot;')}"
                 data-point-index="${newIndex}">
                <h3 class="font-semibold text-text-dark-brown">${name}</h3>
                <p class="text-sm text-text-medium-brown mt-1">${description}</p>
                
                <!-- æ‚¬åœæ—¶æ˜¾ç¤ºçš„æ“ä½œæŒ‰é’® -->
                <div class="knowledge-point-actions absolute -bottom-10 left-1/2 transform -translate-x-1/2 
                            bg-white border border-gray-200 rounded-lg shadow-lg px-2 py-1 
                            opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10 
                            flex items-center space-x-2">
                    <button class="edit-knowledge-btn p-1 text-text-gray hover:text-primary transition-colors" 
                            title="ç¼–è¾‘çŸ¥è¯†ç‚¹" data-index="${newIndex}">
                        <span class="material-icons-outlined text-sm">edit</span>
                    </button>
                    <button class="delete-knowledge-btn p-1 text-text-gray hover:text-danger transition-colors" 
                            title="åˆ é™¤çŸ¥è¯†ç‚¹" data-index="${newIndex}">
                        <span class="material-icons-outlined text-sm">delete</span>
                    </button>
                </div>
            </div>
        `;
        
        // æ’å…¥åˆ°çŸ¥è¯†ç‚¹åˆ—è¡¨ä¸­
        const knowledgeContainer = document.querySelector('.flex-1.overflow-y-auto.space-y-3');
        if (knowledgeContainer) {
            knowledgeContainer.insertAdjacentHTML('beforeend', newPointHtml);
            
            // é‡æ–°ç»‘å®šäº‹ä»¶
            bindKnowledgePointEvents();
            
            addToDebugPanel('SUCCESS', 'æ–°çŸ¥è¯†ç‚¹å·²æ·»åŠ åˆ°åˆ—è¡¨');
        }
    }
    
    // æ›´æ–°çŸ¥è¯†ç‚¹
    function updateKnowledgePoint(index, name, description) {
        addToDebugPanel('SUCCESS', `æ›´æ–°çŸ¥è¯†ç‚¹ ${index}: ${name}`);
        
        const knowledgeItem = document.querySelector(`[data-point-index="${index}"]`);
        if (!knowledgeItem) return;
        
        // æ›´æ–°æ•°æ®å±æ€§
        knowledgeItem.dataset.pointName = name;
        knowledgeItem.dataset.pointDescription = description;
        
        // æ›´æ–°æ˜¾ç¤ºå†…å®¹
        const titleElement = knowledgeItem.querySelector('h3');
        const descElement = knowledgeItem.querySelector('p');
        
        if (titleElement) titleElement.textContent = name;
        if (descElement) descElement.textContent = description;
        
        addToDebugPanel('SUCCESS', 'çŸ¥è¯†ç‚¹å·²æ›´æ–°');
    }
    
    // åˆ é™¤çŸ¥è¯†ç‚¹
    function removeKnowledgePoint(index) {
        addToDebugPanel('SUCCESS', `åˆ é™¤çŸ¥è¯†ç‚¹ ${index}`);
        
        const knowledgeItem = document.querySelector(`[data-point-index="${index}"]`);
        if (knowledgeItem) {
            knowledgeItem.remove();
            
            // é‡æ–°ç¼–å·å‰©ä½™çš„çŸ¥è¯†ç‚¹
            const remainingItems = document.querySelectorAll('.knowledge-point-item');
            remainingItems.forEach((item, newIndex) => {
                item.dataset.pointIndex = newIndex;
                
                // æ›´æ–°æŒ‰é’®çš„data-index
                const editBtn = item.querySelector('.edit-knowledge-btn');
                const deleteBtn = item.querySelector('.delete-knowledge-btn');
                if (editBtn) editBtn.dataset.index = newIndex;
                if (deleteBtn) deleteBtn.dataset.index = newIndex;
            });
            
            addToDebugPanel('SUCCESS', 'çŸ¥è¯†ç‚¹å·²åˆ é™¤');
        }
    }

    // æ˜¾ç¤ºçŸ¥è¯†ç‚¹é”™è¯¯
    function showKnowledgeError(message) {
        const loadingDiv = document.getElementById('knowledge-loading');
        const contentDiv = document.getElementById('knowledge-content');
        const placeholderDiv = document.getElementById('knowledge-placeholder');
        
        if (loadingDiv) loadingDiv.classList.add('hidden');
        if (placeholderDiv) placeholderDiv.classList.add('hidden');
        
        if (contentDiv) {
            contentDiv.innerHTML = `
                <div class="text-center py-16 text-red-600">
                    <span class="material-icons-outlined text-6xl mb-4">error_outline</span>
                    <p class="text-lg font-medium mb-2">çŸ¥è¯†ç‚¹æå–å¤±è´¥</p>
                    <p class="text-sm">${message}</p>
                </div>
            `;
            contentDiv.classList.remove('hidden');
        }
    }

    // è·å–é‡è¦æ€§é¢œè‰²
    function getImportanceColor(importance) {
        switch (importance) {
            case 'é«˜':
            case 'é‡è¦':
                return 'bg-red-100 text-red-800';
            case 'ä¸­':
            case 'ä¸­ç­‰':
                return 'bg-yellow-100 text-yellow-800';
            case 'ä½':
            case 'ä¸€èˆ¬':
                return 'bg-green-100 text-green-800';
            default:
                return 'bg-gray-100 text-gray-800';
        }
    }

    // å¯¼èˆªå‡½æ•°ï¼ˆå…¼å®¹SPAï¼‰
    function loadContent(contentId) {
        if (window.bridge && window.bridge.loadContent) {
            window.bridge.loadContent(contentId);
        }
    }

    // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.toggleFolder = toggleFolder;
    window.handleFileClick = handleFileClick;
    window.switchToPreview = switchToPreview;
    window.switchToEdit = switchToEdit;
    window.saveCurrentFile = saveCurrentFile;
    window.createNewNote = createNewNote;
    window.createNewFolder = createNewFolder;
    window.validateBackendFunctions = validateBackendFunctions;
    window.contextMenuAction = contextMenuAction;
    window.testBridgeConnection = testBridgeConnection;
    window.toggleDebugPanel = toggleDebugPanel;
    window.clearDebugLog = clearDebugLog;
    window.extractKnowledgePoints = extractKnowledgePoints;
    window.loadContent = loadContent;

    // é¡µé¢åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePage);
    } else {
        initializePage();
    }

})();
</script>
