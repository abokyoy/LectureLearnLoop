<!-- LLMè°ƒç”¨æ—¥å¿—æŸ¥çœ‹å™¨ -->
<style>
    .log-viewer {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        padding: 20px;
    }
    .log-viewer h2 {
        color: #2d3748;
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 16px;
        border-bottom: 2px solid #32C77F;
        padding-bottom: 8px;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    .stat-card {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 16px;
        text-align: center;
    }
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #32C77F;
        margin-bottom: 4px;
    }
    .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .log-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
    }
    .log-table th,
    .log-table td {
        padding: 8px 12px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
        font-size: 12px;
    }
    .log-table th {
        background: #f7fafc;
        font-weight: 600;
        color: #4a5568;
    }
    .log-table tr:hover {
        background: #f7fafc;
    }
    .status-success {
        color: #22543d;
        background: #c6f6d5;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
    }
    .status-error {
        color: #742a2a;
        background: #fed7d7;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
    }
    .provider-tag {
        background: #bee3f8;
        color: #2a69ac;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: 500;
    }
    .context-tag {
        background: #fbb6ce;
        color: #97266d;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
    }
    .duration-fast {
        color: #22543d;
        font-weight: 500;
    }
    .duration-medium {
        color: #d69e2e;
        font-weight: 500;
    }
    .duration-slow {
        color: #e53e3e;
        font-weight: 500;
    }
    .log-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    .refresh-btn {
        background: #32C77F;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    .refresh-btn:hover {
        background: #2bb06a;
    }
    .filter-input {
        padding: 6px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        font-size: 12px;
        width: 200px;
    }
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    .log-detail {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        padding: 8px;
        margin-top: 4px;
        font-size: 11px;
        color: #4a5568;
        max-height: 100px;
        overflow-y: auto;
    }
</style>

<div class="p-8">
    <div class="log-viewer">
        <h2>ğŸ“Š LLMè°ƒç”¨ç»Ÿè®¡</h2>
        <div class="stats-grid" id="stats-grid">
            <!-- ç»Ÿè®¡æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <div class="log-viewer">
        <h2>ğŸ“‹ è°ƒç”¨æ—¥å¿—</h2>
        <div class="log-controls">
            <div>
                <input type="text" id="filter-input" class="filter-input" placeholder="æœç´¢æ—¥å¿—..." onkeyup="filterLogs()">
            </div>
            <div>
                <button class="refresh-btn" onclick="refreshLogs()">ğŸ”„ åˆ·æ–°</button>
                <button class="refresh-btn" onclick="exportLogs()" style="margin-left: 8px; background: #4299e1;">ğŸ“¥ å¯¼å‡º</button>
            </div>
        </div>
        
        <div id="logs-container">
            <!-- æ—¥å¿—è¡¨æ ¼å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    let currentLogs = [];
    let currentStats = {};

    // è°ƒè¯•å‡½æ•°
    function debugLog(message) {
        console.log('[LLM Logs Debug]', message);
    }

    function debugError(message) {
        console.error('[LLM Logs Error]', message);
    }

    // åˆå§‹åŒ–æ—¥å¿—æŸ¥çœ‹å™¨
    function initializeLogs() {
        debugLog('åˆå§‹åŒ–LLMæ—¥å¿—æŸ¥çœ‹å™¨');
        loadLogs();
    }

    // åŠ è½½æ—¥å¿—æ•°æ®
    function loadLogs() {
        debugLog('åŠ è½½LLMè°ƒç”¨æ—¥å¿—');
        
        if (!window.bridge || !window.bridge.getLLMCallLogs) {
            debugError('Bridgeå¯¹è±¡æˆ–getLLMCallLogsæ–¹æ³•ä¸å¯ç”¨');
            showEmptyState('æ—¥å¿—åŠŸèƒ½ä¸å¯ç”¨');
            return;
        }
        
        try {
            window.bridge.getLLMCallLogs().then(function(result) {
                debugLog('æ”¶åˆ°æ—¥å¿—æ•°æ®: ' + result.substring(0, 100) + '...');
                
                try {
                    const data = JSON.parse(result);
                    if (data.success) {
                        currentLogs = data.records || [];
                        currentStats = data.statistics || {};
                        displayStats(currentStats);
                        displayLogs(currentLogs);
                    } else {
                        debugError('è·å–æ—¥å¿—å¤±è´¥: ' + data.error);
                        showEmptyState('è·å–æ—¥å¿—å¤±è´¥: ' + data.error);
                    }
                } catch (parseError) {
                    debugError('è§£ææ—¥å¿—æ•°æ®å¤±è´¥: ' + parseError.message);
                    showEmptyState('è§£ææ—¥å¿—æ•°æ®å¤±è´¥');
                }
            }).catch(function(error) {
                debugError('è·å–æ—¥å¿—å¼‚å¸¸: ' + error);
                showEmptyState('è·å–æ—¥å¿—å¼‚å¸¸: ' + error);
            });
        } catch (error) {
            debugError('è°ƒç”¨getLLMCallLogsæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            showEmptyState('è°ƒç”¨æ—¥å¿—æ¥å£å¤±è´¥');
        }
    }

    // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
    function displayStats(stats) {
        const statsGrid = document.getElementById('stats-grid');
        
        const successRate = stats.success_rate ? stats.success_rate.toFixed(1) : '0.0';
        const avgDuration = stats.avg_duration ? (stats.avg_duration * 1000).toFixed(0) : '0';
        const avgFirstByte = stats.avg_first_byte_time ? (stats.avg_first_byte_time * 1000).toFixed(0) : '0';
        
        statsGrid.innerHTML = `
            <div class="stat-card">
                <div class="stat-value">${stats.total_calls || 0}</div>
                <div class="stat-label">æ€»è°ƒç”¨æ¬¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.successful_calls || 0}</div>
                <div class="stat-label">æˆåŠŸè°ƒç”¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${successRate}%</div>
                <div class="stat-label">æˆåŠŸç‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${avgDuration}ms</div>
                <div class="stat-label">å¹³å‡å“åº”æ—¶é—´</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${avgFirstByte}ms</div>
                <div class="stat-label">å¹³å‡é¦–å­—èŠ‚æ—¶é—´</div>
            </div>
        `;
    }

    // æ˜¾ç¤ºæ—¥å¿—åˆ—è¡¨
    function displayLogs(logs) {
        const container = document.getElementById('logs-container');
        
        if (!logs || logs.length === 0) {
            showEmptyState('æš‚æ— æ—¥å¿—è®°å½•');
            return;
        }

        let tableHTML = `
            <table class="log-table">
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>æä¾›å•†</th>
                        <th>æ¨¡å‹</th>
                        <th>ä¸Šä¸‹æ–‡</th>
                        <th>çŠ¶æ€</th>
                        <th>è€—æ—¶</th>
                        <th>é¦–å­—èŠ‚</th>
                        <th>æç¤ºè¯é•¿åº¦</th>
                        <th>å“åº”é•¿åº¦</th>
                        <th>è¯¦æƒ…</th>
                    </tr>
                </thead>
                <tbody>
        `;

        logs.forEach(log => {
            const statusClass = log.success ? 'status-success' : 'status-error';
            const statusText = log.success ? 'æˆåŠŸ' : 'å¤±è´¥';
            const durationMs = (log.total_duration * 1000).toFixed(0);
            const firstByteMs = (log.time_to_first_byte * 1000).toFixed(0);
            
            let durationClass = 'duration-fast';
            if (log.total_duration > 5) durationClass = 'duration-slow';
            else if (log.total_duration > 2) durationClass = 'duration-medium';

            tableHTML += `
                <tr onclick="toggleLogDetail('${log.call_id}')">
                    <td>${log.timestamp}</td>
                    <td><span class="provider-tag">${log.provider}</span></td>
                    <td>${log.model}</td>
                    <td><span class="context-tag">${log.context || 'æœªçŸ¥'}</span></td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td class="${durationClass}">${durationMs}ms</td>
                    <td>${firstByteMs}ms</td>
                    <td>${log.prompt_length}</td>
                    <td>${log.response_length}</td>
                    <td>
                        <button onclick="event.stopPropagation(); toggleLogDetail('${log.call_id}')" style="background: none; border: none; color: #4299e1; cursor: pointer;">ğŸ“‹</button>
                    </td>
                </tr>
                <tr id="detail-${log.call_id}" style="display: none;">
                    <td colspan="10">
                        <div class="log-detail">
                            <strong>APIç«¯ç‚¹:</strong> ${log.api_endpoint}<br>
                            <strong>HTTPçŠ¶æ€ç :</strong> ${log.status_code}<br>
                            <strong>æç¤ºè¯é¢„è§ˆ:</strong> ${log.prompt_preview}<br>
                            <strong>å“åº”é¢„è§ˆ:</strong> ${log.response_preview}<br>
                            ${log.error_message ? `<strong>é”™è¯¯ä¿¡æ¯:</strong> ${log.error_message}<br>` : ''}
                        </div>
                    </td>
                </tr>
            `;
        });

        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState(message) {
        const container = document.getElementById('logs-container');
        container.innerHTML = `
            <div class="empty-state">
                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“</div>
                <div>${message}</div>
            </div>
        `;
    }

    // åˆ‡æ¢æ—¥å¿—è¯¦æƒ…æ˜¾ç¤º
    function toggleLogDetail(callId) {
        const detailRow = document.getElementById(`detail-${callId}`);
        if (detailRow) {
            detailRow.style.display = detailRow.style.display === 'none' ? 'table-row' : 'none';
        }
    }

    // è¿‡æ»¤æ—¥å¿—
    function filterLogs() {
        const filterValue = document.getElementById('filter-input').value.toLowerCase();
        const filteredLogs = currentLogs.filter(log => {
            return log.provider.toLowerCase().includes(filterValue) ||
                   log.model.toLowerCase().includes(filterValue) ||
                   log.context.toLowerCase().includes(filterValue) ||
                   log.timestamp.toLowerCase().includes(filterValue);
        });
        displayLogs(filteredLogs);
    }

    // åˆ·æ–°æ—¥å¿—
    function refreshLogs() {
        debugLog('åˆ·æ–°æ—¥å¿—æ•°æ®');
        loadLogs();
    }

    // å¯¼å‡ºæ—¥å¿—
    function exportLogs() {
        debugLog('å¯¼å‡ºæ—¥å¿—æ•°æ®');
        
        if (!currentLogs || currentLogs.length === 0) {
            alert('æ²¡æœ‰æ—¥å¿—æ•°æ®å¯ä»¥å¯¼å‡º');
            return;
        }

        // åˆ›å»ºCSVå†…å®¹
        const headers = ['æ—¶é—´', 'æä¾›å•†', 'æ¨¡å‹', 'ä¸Šä¸‹æ–‡', 'çŠ¶æ€', 'æ€»è€—æ—¶(s)', 'é¦–å­—èŠ‚æ—¶é—´(s)', 'æç¤ºè¯é•¿åº¦', 'å“åº”é•¿åº¦', 'APIç«¯ç‚¹', 'é”™è¯¯ä¿¡æ¯'];
        const csvContent = [
            headers.join(','),
            ...currentLogs.map(log => [
                log.timestamp,
                log.provider,
                log.model,
                log.context || '',
                log.success ? 'æˆåŠŸ' : 'å¤±è´¥',
                log.total_duration,
                log.time_to_first_byte,
                log.prompt_length,
                log.response_length,
                log.api_endpoint,
                log.error_message || ''
            ].map(field => `"${field}"`).join(','))
        ].join('\n');

        // ä¸‹è½½æ–‡ä»¶
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `llm_call_logs_${new Date().toISOString().slice(0, 10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.toggleLogDetail = toggleLogDetail;
    window.filterLogs = filterLogs;
    window.refreshLogs = refreshLogs;
    window.exportLogs = exportLogs;

    // é¡µé¢åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeLogs);
    } else {
        initializeLogs();
    }

})();
</script>
