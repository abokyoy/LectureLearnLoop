<!DOCTYPE html>
<html>
<head>
    <title>å‰ç«¯çŸ¥è¯†ç‚¹æå–è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; }
        #log { background: #f5f5f5; padding: 10px; height: 300px; overflow-y: scroll; }
    </style>
</head>
<body>
    <h1>å‰ç«¯çŸ¥è¯†ç‚¹æå–è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-section">
        <h3>1. æ£€æŸ¥Bridgeå¯¹è±¡</h3>
        <button onclick="checkBridge()">æ£€æŸ¥Bridge</button>
        <div id="bridge-status"></div>
    </div>
    
    <div class="debug-section">
        <h3>2. æµ‹è¯•çŸ¥è¯†ç‚¹æå–</h3>
        <input type="text" id="test-file-path" placeholder="è¾“å…¥æµ‹è¯•æ–‡ä»¶è·¯å¾„" style="width: 300px;">
        <button onclick="testExtraction()">æµ‹è¯•æå–</button>
        <div id="extraction-status"></div>
    </div>
    
    <div class="debug-section">
        <h3>3. æ¨¡æ‹ŸçŸ¥è¯†ç‚¹æ˜¾ç¤º</h3>
        <button onclick="testDisplay()">æµ‹è¯•æ˜¾ç¤º</button>
        <div id="display-test"></div>
    </div>
    
    <div class="debug-section">
        <h3>4. è°ƒè¯•æ—¥å¿—</h3>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="log"></div>
    </div>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // æ£€æŸ¥Bridgeå¯¹è±¡
        function checkBridge() {
            log('å¼€å§‹æ£€æŸ¥Bridgeå¯¹è±¡...');
            
            if (typeof window.bridge === 'undefined') {
                log('âŒ window.bridge æœªå®šä¹‰', 'error');
                document.getElementById('bridge-status').innerHTML = '<span class="error">âŒ Bridgeå¯¹è±¡ä¸å­˜åœ¨</span>';
                return false;
            }
            
            log('âœ… window.bridge å­˜åœ¨');
            
            if (typeof window.bridge.extractKnowledgePoints !== 'function') {
                log('âŒ extractKnowledgePoints æ–¹æ³•ä¸å­˜åœ¨', 'error');
                document.getElementById('bridge-status').innerHTML = '<span class="error">âŒ extractKnowledgePointsæ–¹æ³•ä¸å­˜åœ¨</span>';
                return false;
            }
            
            log('âœ… extractKnowledgePoints æ–¹æ³•å­˜åœ¨');
            document.getElementById('bridge-status').innerHTML = '<span class="success">âœ… Bridgeå¯¹è±¡æ­£å¸¸</span>';
            return true;
        }
        
        // æµ‹è¯•çŸ¥è¯†ç‚¹æå–
        function testExtraction() {
            log('å¼€å§‹æµ‹è¯•çŸ¥è¯†ç‚¹æå–...');
            
            if (!checkBridge()) {
                return;
            }
            
            const filePath = document.getElementById('test-file-path').value.trim();
            if (!filePath) {
                log('âŒ è¯·è¾“å…¥æµ‹è¯•æ–‡ä»¶è·¯å¾„', 'error');
                return;
            }
            
            log(`æµ‹è¯•æ–‡ä»¶è·¯å¾„: ${filePath}`);
            document.getElementById('extraction-status').innerHTML = '<span class="info">ğŸ”„ æ­£åœ¨æå–...</span>';
            
            try {
                window.bridge.extractKnowledgePoints(filePath, function(resultJson) {
                    log(`æ”¶åˆ°æå–ç»“æœï¼Œé•¿åº¦: ${resultJson.length} å­—ç¬¦`);
                    log(`åŸå§‹ç»“æœ: ${resultJson.substring(0, 200)}...`);
                    
                    try {
                        const result = JSON.parse(resultJson);
                        log('âœ… JSONè§£ææˆåŠŸ', 'success');
                        log(`ç»“æœç»“æ„: ${JSON.stringify(Object.keys(result))}`);
                        
                        if (result.success) {
                            const points = result.knowledge_points || [];
                            log(`âœ… æˆåŠŸæå– ${points.length} ä¸ªçŸ¥è¯†ç‚¹`, 'success');
                            
                            document.getElementById('extraction-status').innerHTML = 
                                `<span class="success">âœ… æˆåŠŸæå– ${points.length} ä¸ªçŸ¥è¯†ç‚¹</span>`;
                            
                            // æ˜¾ç¤ºå‰3ä¸ªçŸ¥è¯†ç‚¹
                            points.slice(0, 3).forEach((point, index) => {
                                log(`çŸ¥è¯†ç‚¹${index + 1}: ${point.name} - ${point.description.substring(0, 50)}...`);
                            });
                            
                        } else {
                            const error = result.error || 'æœªçŸ¥é”™è¯¯';
                            log(`âŒ æå–å¤±è´¥: ${error}`, 'error');
                            document.getElementById('extraction-status').innerHTML = 
                                `<span class="error">âŒ æå–å¤±è´¥: ${error}</span>`;
                        }
                        
                    } catch (parseError) {
                        log(`âŒ JSONè§£æå¤±è´¥: ${parseError.message}`, 'error');
                        document.getElementById('extraction-status').innerHTML = 
                            `<span class="error">âŒ JSONè§£æå¤±è´¥</span>`;
                    }
                });
                
            } catch (error) {
                log(`âŒ è°ƒç”¨extractKnowledgePointså¤±è´¥: ${error.message}`, 'error');
                document.getElementById('extraction-status').innerHTML = 
                    `<span class="error">âŒ è°ƒç”¨å¤±è´¥: ${error.message}</span>`;
            }
        }
        
        // æµ‹è¯•çŸ¥è¯†ç‚¹æ˜¾ç¤º
        function testDisplay() {
            log('æµ‹è¯•çŸ¥è¯†ç‚¹æ˜¾ç¤ºåŠŸèƒ½...');
            
            // æ¨¡æ‹ŸæˆåŠŸçš„çŸ¥è¯†ç‚¹æ•°æ®
            const mockResult = {
                success: true,
                knowledge_points: [
                    {
                        name: "äººå·¥æ™ºèƒ½",
                        description: "è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œæ—¨åœ¨åˆ›å»ºèƒ½å¤Ÿæ‰§è¡Œé€šå¸¸éœ€è¦äººç±»æ™ºèƒ½çš„ä»»åŠ¡çš„ç³»ç»Ÿã€‚",
                        category: "åŸºç¡€æ¦‚å¿µ",
                        importance: "é«˜"
                    },
                    {
                        name: "æœºå™¨å­¦ä¹ ",
                        description: "äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªå­é¢†åŸŸï¼Œä½¿è®¡ç®—æœºèƒ½å¤Ÿä»æ•°æ®ä¸­å­¦ä¹ å¹¶åšå‡ºé¢„æµ‹æˆ–å†³ç­–ã€‚",
                        category: "æ ¸å¿ƒæŠ€æœ¯",
                        importance: "é«˜"
                    },
                    {
                        name: "æ·±åº¦å­¦ä¹ ",
                        description: "æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåˆ†æ”¯ï¼ŒåŸºäºäººå·¥ç¥ç»ç½‘ç»œï¼Œç‰¹åˆ«æ˜¯æ·±å±‚ç¥ç»ç½‘ç»œã€‚",
                        category: "é«˜çº§æŠ€æœ¯",
                        importance: "ä¸­ç­‰"
                    }
                ],
                total_count: 3
            };
            
            log('ç”Ÿæˆæ¨¡æ‹ŸçŸ¥è¯†ç‚¹æ•°æ®');
            log(`æ¨¡æ‹Ÿæ•°æ®: ${JSON.stringify(mockResult, null, 2)}`);
            
            // ç”Ÿæˆæ˜¾ç¤ºHTML
            let html = `
                <div style="border: 1px solid #ccc; padding: 15px; margin-top: 10px;">
                    <h4 style="color: green;">âœ… æˆåŠŸæå– ${mockResult.knowledge_points.length} ä¸ªçŸ¥è¯†ç‚¹</h4>
            `;
            
            mockResult.knowledge_points.forEach((point, index) => {
                const importanceColor = point.importance === 'é«˜' ? 'red' : 
                                      point.importance === 'ä¸­ç­‰' ? 'orange' : 'green';
                html += `
                    <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; background: #f9f9f9;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h5 style="margin: 0; color: #333;">${point.name}</h5>
                            <span style="background: ${importanceColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                ${point.importance}
                            </span>
                        </div>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">${point.description}</p>
                        ${point.category ? `<div style="margin-top: 5px;"><span style="background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 4px; font-size: 12px;">${point.category}</span></div>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            
            document.getElementById('display-test').innerHTML = html;
            log('âœ… çŸ¥è¯†ç‚¹æ˜¾ç¤ºæµ‹è¯•å®Œæˆ', 'success');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥Bridge
        window.addEventListener('load', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥ç¯å¢ƒ...');
            setTimeout(checkBridge, 1000); // å»¶è¿Ÿ1ç§’æ£€æŸ¥ï¼Œç¡®ä¿Bridgeå·²åŠ è½½
        });
    </script>
</body>
</html>
